<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>InsightFoundry</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
    <style>
      :root {
        --font-ui: "Sohne", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        --font-mono: "Sohne Mono", "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, monospace;
        --size-11: 11px;
        --size-12: 12px;
        --size-13: 13px;
        --size-14: 14px;
        --size-15: 15px;
        --size-18: 18px;
        --bg: #f7f8fa;
        --panel: #ffffff;
        --panel-solid: #ffffff;
        --line: #e5e7eb;
        --line-strong: #cfd5df;
        --text: #101828;
        --muted: #667085;
        --accent: #0f766e;
        --accent-deep: #115e59;
        --accent-soft: #ecfdf3;
        --shadow: 0 1px 2px rgba(16, 24, 40, 0.05), 0 1px 3px rgba(16, 24, 40, 0.1);
        --glass-blur: 0px;
        --radius-lg: 12px;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: var(--font-ui);
        font-size: var(--size-14);
        line-height: 1.45;
        color: var(--text);
        background: var(--bg);
        min-height: 100vh;
        position: relative;
      }
      body::before,
      body::after {
        content: "";
        position: fixed;
        z-index: -1;
        border-radius: 999px;
        filter: blur(24px);
        pointer-events: none;
      }
      body::before {
        width: min(42vw, 560px);
        height: min(42vw, 560px);
        top: -120px;
        left: -80px;
        background: rgba(186, 228, 215, 0.45);
      }
      body::after {
        width: min(36vw, 460px);
        height: min(36vw, 460px);
        right: -70px;
        top: 26vh;
        background: rgba(178, 205, 234, 0.34);
      }
      .app {
        display: grid;
        grid-template-rows: 64px 1fr;
        min-height: 100vh;
      }
      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 0 18px;
        border-bottom: 1px solid var(--line);
        background: #ffffff;
        backdrop-filter: blur(var(--glass-blur));
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .brand-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, #2ed1a0, #08745a);
        box-shadow: 0 0 0 6px #d7f1e8;
      }
      .brand h1 { margin: 0; font-size: var(--size-18); letter-spacing: -0.01em; }
      .subtle { color: var(--muted); font-size: var(--size-12); }
      .system-alert {
        margin: 10px 0;
        border: 1px solid rgba(187, 132, 74, 0.6);
        border-radius: 10px;
        background: rgba(255, 243, 228, 0.92);
        color: #6a4320;
        padding: 10px;
        font-size: 12px;
      }
      .nav {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .session-controls {
        display: flex;
        gap: 8px;
        align-items: center;
        border: 1px solid var(--line);
        border-radius: 10px;
        background: #ffffff;
        padding: 4px 8px;
      }
      .session-controls select {
        min-width: 170px;
        border: 1px solid var(--line);
      }
      .session-role {
        font-size: var(--size-11);
        font-family: var(--font-mono);
        border: 1px solid var(--line);
        border-radius: 999px;
        padding: 3px 8px;
        color: var(--muted);
        background: #f8fafc;
      }
      .nav button,
      button,
      .chip,
      .tab {
        border: 1px solid var(--line);
        background: #ffffff;
        color: var(--text);
        border-radius: 10px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: var(--size-13);
        font-family: var(--font-ui);
        font-weight: 500;
        transition: border-color 120ms ease, background-color 120ms ease, transform 120ms ease;
      }
      .nav button:hover,
      button:hover,
      .chip:hover,
      .tab:hover {
        border-color: var(--line-strong);
      }
      .nav button.active,
      .tab.active,
      button.primary,
      .chip.active {
        background: var(--accent-soft);
        border-color: #a7f3d0;
        color: var(--accent-deep);
      }
      button.primary {
        font-weight: 600;
      }
      .main {
        padding: 12px;
      }
      .route { display: none; }
      .route.active { display: block; }
      .panel {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow);
        backdrop-filter: blur(var(--glass-blur));
      }
      .workspace {
        display: grid;
        grid-template-columns: 250px 1fr 330px;
        gap: 10px;
        min-height: calc(100vh - 90px);
      }
      .left-rail,
      .center,
      .right-rail,
      .settings-layout,
      .runs-layout {
        padding: 12px;
      }
      .left-rail,
      .right-rail,
      .settings-nav,
      .runs-list {
        display: grid;
        gap: 10px;
        align-content: start;
      }
      .right-rail {
        grid-template-rows: auto auto auto 1fr;
      }
      .card {
        border: 1px solid var(--line);
        border-radius: 12px;
        background: #ffffff;
        padding: 10px;
      }
      .card h3,
      .card h4 { margin: 0 0 6px; }
      .list {
        display: grid;
        gap: 7px;
        max-height: 240px;
        overflow: auto;
      }
      .item {
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 8px;
        font-size: var(--size-13);
        background: #ffffff;
      }
      .center {
        display: grid;
        grid-template-rows: auto auto auto 1fr auto;
        gap: 10px;
      }
      .workspace-hero {
        border: 1px solid var(--line);
        background: linear-gradient(120deg, rgba(245, 252, 249, 0.78), rgba(238, 245, 253, 0.74));
        border-radius: 12px;
        padding: 10px;
        backdrop-filter: blur(12px);
      }
      .workspace-hero h2 {
        margin: 0 0 4px;
      }
      .workspace-hero p {
        margin: 0;
      }
      .commandbar {
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 10px;
        background: #ffffff;
        display: grid;
        gap: 8px;
      }
      .quick-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .quick-actions button {
        background: rgba(255, 255, 255, 0.66);
      }
      .command-line {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 8px;
        align-items: center;
      }
      kbd {
        font-family: var(--font-mono);
        font-size: var(--size-11);
        border: 1px solid var(--line);
        border-radius: 8px;
        padding: 2px 6px;
        background: rgba(255, 255, 255, 0.66);
      }
      .kpis {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
      }
      .kpi {
        border: 1px solid var(--line);
        border-radius: 11px;
        padding: 8px;
        background: rgba(255, 255, 255, 0.62);
      }
      .kpi .val {
        font-size: 22px;
        font-weight: 700;
      }
      .chat {
        border: 1px solid var(--line);
        border-radius: 12px;
        background: #ffffff;
        display: grid;
        grid-template-rows: 1fr auto;
        min-height: 290px;
      }
      .thread {
        padding: 12px;
        overflow: auto;
      }
      .msg {
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 8px;
        margin-bottom: 8px;
        font-size: var(--size-13);
        background: #ffffff;
      }
      .msg .msg-meta {
        display: block;
        font-size: var(--size-11);
        color: var(--muted);
        margin-bottom: 4px;
      }
      .msg.user {
        background: rgba(228, 248, 240, 0.82);
        border-color: rgba(113, 161, 144, 0.45);
      }
      .composer {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 8px;
        padding: 10px;
        border-top: 1px solid var(--line);
        background: #ffffff;
      }
      .chat-toolbar {
        display: grid;
        grid-template-columns: auto minmax(0, 1fr) auto auto;
        gap: 8px;
        align-items: center;
        padding: 8px 10px;
        border-bottom: 1px solid var(--line);
        background: #ffffff;
      }
      .attachment-tray {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        padding: 0 10px 8px;
      }
      .attachment-pill {
        border: 1px solid var(--line);
        border-radius: 999px;
        padding: 4px 8px;
        font-size: 11px;
        background: rgba(255, 255, 255, 0.84);
      }
      textarea,
      input,
      select {
        width: 100%;
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 8px;
        font: inherit;
        font-size: var(--size-13);
        background: #ffffff;
      }
      .stepper {
        display: grid;
        gap: 8px;
      }
      .step {
        border: 1px dashed rgba(129, 156, 146, 0.66);
        border-radius: 10px;
        padding: 8px;
        font-size: 12px;
        background: rgba(255, 255, 255, 0.54);
      }
      .toolbar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .tabs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .context-body {
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 10px;
        min-height: 230px;
        background: #ffffff;
      }
      .value-points {
        margin: 8px 0 0;
        padding-left: 18px;
        display: grid;
        gap: 6px;
        font-size: 13px;
      }
      .onboard {
        border: 1px solid rgba(129, 156, 146, 0.58);
        background: rgba(240, 250, 245, 0.75);
        border-radius: 10px;
        padding: 8px;
        font-size: 12px;
      }
      .progress-track {
        width: 100%;
        height: 8px;
        border-radius: 999px;
        background: rgba(169, 184, 204, 0.28);
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, rgba(15, 118, 110, 0.9), rgba(59, 130, 246, 0.8));
      }
      .settings-layout {
        display: grid;
        grid-template-columns: 220px 1fr;
        gap: 10px;
        min-height: calc(100vh - 90px);
      }
      .settings-nav .tab,
      .runs-list .item,
      .item.clickable {
        text-align: left;
      }
      .settings-content,
      .runs-detail {
        display: grid;
        gap: 10px;
        align-content: start;
      }
      .settings-section {
        display: none;
      }
      .settings-section.active {
        display: grid;
        gap: 10px;
      }
      .form-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
      }
      .form-grid .full {
        grid-column: 1 / -1;
      }
      .runs-layout {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 10px;
        min-height: calc(100vh - 90px);
      }
      .timeline {
        display: grid;
        gap: 8px;
      }
      .timeline .item {
        border-left: 3px solid rgba(131, 163, 151, 0.72);
      }
      .status {
        font-size: 11px;
        border-radius: 999px;
        padding: 3px 7px;
        border: 1px solid rgba(129, 156, 146, 0.58);
        background: rgba(245, 251, 249, 0.88);
      }
      .badges {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .badge {
        font-size: 11px;
        border-radius: 999px;
        padding: 4px 8px;
        border: 1px solid rgba(129, 156, 146, 0.6);
        background: rgba(244, 251, 248, 0.9);
      }
      .badge.good {
        border-color: rgba(99, 170, 139, 0.64);
        background: rgba(229, 246, 238, 0.92);
      }
      .badge.warn {
        border-color: rgba(187, 160, 95, 0.65);
        background: rgba(254, 247, 229, 0.95);
      }
      .badge.bad {
        border-color: rgba(186, 114, 114, 0.64);
        background: rgba(253, 236, 236, 0.94);
      }
      .preview-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      .preview-panel {
        border: 1px solid var(--line);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.74);
        padding: 8px;
      }
      .preview-panel pre {
        margin: 0;
        font-size: 12px;
        white-space: pre-wrap;
      }
      .evidence-list {
        display: grid;
        gap: 8px;
      }
      .mono { font-family: var(--font-mono); }

      /* Workspace V4: codex-like hierarchy */
      :root {
        --bg: #f7f8fa;
        --panel: #ffffff;
        --line: #e5e7eb;
        --line-strong: #cfd5df;
        --text: #101828;
        --muted: #667085;
        --accent: #0f766e;
        --accent-deep: #0f5e59;
        --accent-soft: #ecfdf3;
        --shadow: 0 1px 2px rgba(16, 24, 40, 0.05), 0 1px 3px rgba(16, 24, 40, 0.1);
        --glass-blur: 0px;
        --radius-lg: 12px;
      }
      body {
        background: var(--bg);
      }
      body::before,
      body::after {
        display: none;
      }
      .topbar {
        height: 56px;
        background: #ffffff;
        border-color: var(--line);
        backdrop-filter: blur(var(--glass-blur));
      }
      .brand-dot {
        width: 10px;
        height: 10px;
        box-shadow: 0 0 0 4px #dff1e8;
      }
      .panel,
      .card,
      .item,
      .chat,
      .context-body,
      .preview-panel {
        background: var(--panel);
        backdrop-filter: none;
      }
      .workspace.codex-layout {
        grid-template-columns: 280px minmax(0, 1fr) 380px;
        gap: 12px;
        transition: grid-template-columns 180ms ease;
      }
      .workspace.codex-layout.left-collapsed {
        grid-template-columns: minmax(0, 1fr) 380px;
      }
      .workspace.codex-layout.right-collapsed {
        grid-template-columns: 280px minmax(0, 1fr);
      }
      .workspace.codex-layout.left-collapsed.right-collapsed {
        grid-template-columns: minmax(0, 1fr);
      }
      .workspace.codex-layout.focus-mode {
        grid-template-columns: minmax(0, 1fr);
      }
      .workspace.codex-layout.left-collapsed .left-rail {
        display: none;
      }
      .workspace.codex-layout.right-collapsed .right-rail {
        display: none;
      }
      .workspace.codex-layout.focus-mode .left-rail,
      .workspace.codex-layout.focus-mode .right-rail {
        display: none;
      }
      .workspace.codex-layout .left-rail,
      .workspace.codex-layout .center,
      .workspace.codex-layout .right-rail {
        padding: 10px;
      }
      .workspace.codex-layout .left-rail .card {
        padding: 12px;
      }
      .workspace.codex-layout .center {
        grid-template-rows: auto auto auto 1fr;
        gap: 10px;
      }
      .workspace.codex-layout .doc-header {
        border: 1px solid var(--line);
      }
      .workspace.codex-layout #dataContextStrip {
        border: 1px solid var(--line);
      }
      .workspace.codex-layout .context-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
      }
      .workspace.codex-layout .context-kv {
        border: 1px solid var(--line);
        border-radius: 8px;
        padding: 8px;
        background: #fbfcfd;
      }
      .workspace.codex-layout .left-rail .toolbar button,
      .workspace.codex-layout .tabs .tab,
      .workspace.codex-layout .run-builder-compact .toolbar button {
        font-family: var(--font-ui);
      }
      .workspace.codex-layout .chat {
        min-height: 66vh;
        border-color: var(--line);
      }
      .workspace.codex-layout .thread {
        padding: 16px;
      }
      .workspace.codex-layout .msg {
        border-radius: 12px;
        border-color: #e5e7eb;
      }
      .workspace.codex-layout .msg.user {
        background: #f0fdf4;
        border-color: #bbf7d0;
      }
      .workspace.codex-layout .msg.private-hidden {
        background: rgba(243, 244, 246, 0.95);
        border-style: dashed;
      }
      .workspace.codex-layout .msg.reply {
        margin-left: 18px;
        border-left-width: 3px;
      }
      .workspace.codex-layout .msg .reply-actions {
        margin-top: 8px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .workspace.codex-layout .composer {
        background: rgba(255, 255, 255, 0.62);
      }
      .workspace.codex-layout .composer {
        grid-template-columns: 1fr;
      }
      .workspace.codex-layout .composer .toolbar {
        margin: 0;
      }
      .workspace.codex-layout .composer textarea {
        min-height: 56px;
      }
      #miniThreadDrawer {
        border-color: var(--line);
        background: rgba(255, 255, 255, 0.8);
      }
      .workspace.codex-layout .right-rail .stepper {
        gap: 10px;
      }
      .workspace.codex-layout .step {
        border-style: solid;
        border-color: #e5e7eb;
        background: #ffffff;
      }
      .workspace.codex-layout .run-builder-compact .toolbar button {
        flex: 1 1 auto;
      }
      .workspace.codex-layout .run-builder-compact h3 {
        margin-bottom: 10px;
      }
      .item.clickable.active {
        border-color: rgba(80, 131, 117, 0.62);
        background: rgba(223, 247, 240, 0.78);
      }
      @media (prefers-reduced-motion: reduce) {
        * {
          transition: none !important;
        }
      }
      @media (max-width: 1120px) {
        .workspace,
        .settings-layout,
        .runs-layout {
          grid-template-columns: 1fr;
        }
        .command-line {
          grid-template-columns: 1fr;
        }
        .preview-grid {
          grid-template-columns: 1fr;
        }
        .workspace.codex-layout .context-grid {
          grid-template-columns: 1fr;
        }
        .workspace.codex-layout.left-collapsed,
        .workspace.codex-layout.right-collapsed,
        .workspace.codex-layout.left-collapsed.right-collapsed {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header class="topbar">
        <div class="brand">
          <span class="brand-dot"></span>
          <div>
            <h1>InsightFoundry</h1>
            <div class="subtle" id="tenantLabel">Tenant: loading...</div>
          </div>
        </div>
        <div style="display:flex; gap:8px; align-items:center">
          <div class="session-controls">
            <label class="subtle" for="sessionUserSelect">Acting as</label>
            <select id="sessionUserSelect"></select>
            <span id="sessionRoleBadge" class="session-role">owner</span>
          </div>
          <div class="nav">
            <button data-route-target="workspace" class="active">Workspace</button>
            <button data-route-target="settings">Settings</button>
            <button data-route-target="runs">Runs</button>
          </div>
          <div class="nav">
            <button id="toggleFocusModeBtn" type="button">Focus</button>
            <button id="toggleLeftRailBtn" type="button">Hide Left</button>
            <button id="toggleRightRailBtn" type="button">Hide Right</button>
          </div>
        </div>
      </header>

      <main class="main">
        <div id="systemAlert" class="system-alert" hidden></div>
        <section id="route-workspace" class="route active">
          <div class="workspace codex-layout">
            <aside class="left-rail panel">
              <div class="card">
                <h3>Projects</h3>
                <div class="subtle">Folders and shared threads</div>
                <div class="toolbar" style="margin-top:8px">
                  <button id="leftNewThreadBtn" type="button" class="primary">New Thread</button>
                  <button id="leftNewSkillBtn" type="button">New Skill</button>
                  <button id="leftNewAutomationBtn" type="button">New Automation</button>
                </div>
                <div class="toolbar" style="margin-top:8px">
                  <input id="newFolderNameInput" placeholder="New folder name" />
                  <button id="newFolderBtn" type="button">Create</button>
                </div>
                <div id="folderList" class="list" style="margin-top:8px"></div>
                <div class="toolbar" style="margin-top:8px">
                  <input id="newThreadTitleInput" placeholder="New thread title" />
                  <button id="newThreadBtn" type="button">Create</button>
                </div>
                <div id="threadList" class="list" style="margin-top:8px"></div>
              </div>
              <div class="card">
                <h3>Skills</h3>
                <div class="subtle">Installed and active skill packs</div>
                <div id="sidebarSkillsList" class="list" style="margin-top:8px"></div>
              </div>
              <div class="card">
                <h3>Automations</h3>
                <div class="subtle">Folder-scoped jobs and heartbeat triggers</div>
                <div id="sidebarAutomationsList" class="list" style="margin-top:8px"></div>
                <div id="runContextList" hidden></div>
              </div>
              <div class="card">
                <h3>Prompt Seeds</h3>
                <div class="list" id="savedPromptList"></div>
              </div>
            </aside>

            <section class="center panel">
              <div class="card doc-header">
                <div class="subtle mono">Workspace / Team Feed</div>
                <h2 style="margin:4px 0 2px">Collaborative AI Copilot</h2>
                <div class="subtle">Shared by default. Ask privately when needed. Mini-threads keep the main feed clean.</div>
              </div>
              <div class="commandbar">
                <form id="commandForm" class="command-line">
                  <kbd>cmd+k</kbd>
                  <input id="commandInput" placeholder="new thread | new run | execute run | open settings team/channels/models" />
                  <button type="submit">Run</button>
                </form>
                <div class="toolbar">
                  <button id="quickNewRunBtn" type="button">New Run</button>
                  <button id="quickExecuteBtn" type="button">Execute</button>
                  <button id="quickDeliverBtn" type="button">Deliver</button>
                  <button id="quickSettingsBtn" type="button">Settings</button>
                </div>
              </div>
              <div class="card" id="dataContextStrip"></div>
              <section class="chat">
                <div class="chat-toolbar">
                  <label class="subtle">Model</label>
                  <select id="chatModelProfileSelect"></select>
                  <button id="chatOpenModelsBtn" type="button">Models</button>
                  <button id="chatOpenChannelsBtn" type="button">Channels</button>
                </div>
                <div class="toolbar" id="chatQuickActionBar" style="padding:8px 10px; border-bottom:1px solid var(--line);"></div>
                <div class="thread" id="thread"></div>
                <aside id="miniThreadDrawer" class="card" style="margin:8px 10px 0; display:none;">
                  <div class="toolbar" style="justify-content:space-between">
                    <strong id="miniThreadTitle">Mini Thread</strong>
                    <button id="closeMiniThreadBtn" type="button">Close</button>
                  </div>
                  <div id="miniThreadList" class="list" style="margin-top:8px; max-height:180px; overflow:auto;"></div>
                  <div class="toolbar" style="margin-top:8px">
                    <input id="miniThreadReplyInput" placeholder="Reply in mini-thread" />
                    <button id="miniThreadReplyBtn" type="button" class="primary">Reply</button>
                  </div>
                </aside>
                <div class="attachment-tray" id="chatAttachments"></div>
                <form id="chatForm" class="composer">
                  <div class="toolbar">
                    <button type="button" id="attachFilesBtn">Attach</button>
                    <button type="button" id="askAiSharedBtn">Ask AI</button>
                    <button type="button" id="askAiPrivateBtn">Ask AI Privately</button>
                  </div>
                  <textarea id="chatInput" placeholder="Ask for a revenue forecast, anomaly scan, root-cause breakdown, or action plan from current run context"></textarea>
                  <input id="chatFileInput" type="file" multiple hidden />
                  <button type="submit" class="primary">Send</button>
                </form>
              </section>
            </section>

            <aside class="right-rail panel">
              <div class="card">
                <div class="tabs">
                  <button id="rightRailTabWorking" class="tab active" type="button">Working Folders</button>
                  <button id="rightRailTabAttachments" class="tab" type="button">Attachments</button>
                  <button id="rightRailTabNotifications" class="tab" type="button">Notifications</button>
                </div>
              </div>
              <div id="rightRailWorkingPanel" class="card">
                <h4>Run + Agent Controls</h4>
                <div class="badges" id="runHealthBadges"></div>
                <div id="onboardingChecklist" class="onboard" style="margin-top:8px"></div>
                <div class="form-grid" style="margin-top:8px">
                  <label class="full">Cowork Prompt<input id="agentCoworkPrompt" placeholder="Summarize this thread and propose next steps." /></label>
                  <button id="runCoworkAgentBtn" type="button">Run In Thread</button>
                </div>
                <div class="form-grid" style="margin-top:8px">
                  <label>Command<input id="deviceCommandInput" placeholder="pwd" /></label>
                  <label>Args<input id="deviceCommandArgsInput" placeholder="-la" /></label>
                  <button id="requestDeviceCommandBtn" type="button">Request Command</button>
                </div>
                <div class="stepper run-builder-compact" style="margin-top:8px">
                  <div class="step">1. Source Dataset: <select id="runSourceSelect"></select></div>
                  <div class="step">2. Model Profile: <select id="runModelSelect"></select></div>
                  <div class="step">3. Report Type: <select id="runReportSelect"></select></div>
                  <div class="step">4. Skill (optional): <select id="runSkillSelect"></select></div>
                  <div class="step">5. Channels: <input id="runChannelsInput" value="email,slack" /></div>
                  <div class="toolbar">
                    <button id="createRunBtn" type="button" class="primary">Create Draft</button>
                    <button id="executeRunBtn" type="button">Execute</button>
                    <button id="deliverRunBtn" type="button">Deliver</button>
                    <button id="previewRunBtn" type="button">Preview</button>
                  </div>
                  <div class="preview-grid">
                    <div class="preview-panel">
                      <h4>Report Preview</h4>
                      <pre id="runReportPreview" class="mono">Select a report type, then click Preview.</pre>
                    </div>
                    <div class="preview-panel">
                      <h4>Channel Preview</h4>
                      <pre id="runChannelPreview" class="mono">Delivery summary appears here before execute/deliver.</pre>
                    </div>
                  </div>
                </div>
              </div>

              <div id="rightRailAttachmentsPanel" class="card" style="display:none;">
                <h4>Attachments</h4>
                <div id="rightAttachmentsList" class="list"></div>
              </div>

              <div id="rightRailNotificationsPanel" class="card" style="display:none;">
                <h4>Notifications</h4>
                <div id="rightNotificationsList" class="list"></div>
              </div>

              <div class="tabs card" id="contextTabsCard">
                <button class="tab active" data-context-tab="summary">Summary</button>
                <button class="tab" data-context-tab="evidence">Evidence</button>
                <button class="tab" data-context-tab="actions">Actions</button>
                <button class="tab" data-context-tab="artifacts">Artifacts</button>
                <button class="tab" data-context-tab="comments">Comments</button>
              </div>
              <div class="context-body" id="contextBody"></div>
            </aside>
          </div>
        </section>

        <section id="route-settings" class="route">
          <div class="settings-layout panel">
            <aside class="settings-nav">
              <button class="tab active" data-settings-tab="setup">Setup</button>
              <button class="tab" data-settings-tab="general">General</button>
              <button class="tab" data-settings-tab="team">Team</button>
              <button class="tab" data-settings-tab="mcp-agents">MCP & Agents</button>
              <button class="tab" data-settings-tab="integrations">Integrations</button>
              <button class="tab" data-settings-tab="connections">Connections</button>
              <button class="tab" data-settings-tab="credentials">Credentials</button>
              <button class="tab" data-settings-tab="models">Models</button>
              <button class="tab" data-settings-tab="training">Training</button>
              <button class="tab" data-settings-tab="reports">Reports</button>
              <button class="tab" data-settings-tab="skills">Skills</button>
              <button class="tab" data-settings-tab="channels">Channels</button>
              <button class="tab" data-settings-tab="policies">Policies</button>
            </aside>

            <section class="settings-content">
              <div id="settings-setup" class="settings-section active card"></div>
              <div id="settings-general" class="settings-section card"></div>
              <div id="settings-team" class="settings-section card"></div>
              <div id="settings-mcp-agents" class="settings-section card"></div>
              <div id="settings-integrations" class="settings-section card"></div>
              <div id="settings-connections" class="settings-section card"></div>
              <div id="settings-credentials" class="settings-section card"></div>
              <div id="settings-models" class="settings-section card"></div>
              <div id="settings-training" class="settings-section card"></div>
              <div id="settings-reports" class="settings-section card"></div>
              <div id="settings-skills" class="settings-section card"></div>
              <div id="settings-channels" class="settings-section card"></div>
              <div id="settings-policies" class="settings-section card"></div>
            </section>
          </div>
        </section>

        <section id="route-runs" class="route">
          <div class="runs-layout panel">
            <aside class="runs-list card">
              <h3>Analysis Runs</h3>
              <div id="runList" class="list"></div>
            </aside>
            <section class="runs-detail card" id="runDetail"></section>
          </div>
        </section>
      </main>
    </div>

    <script>
      const demoTenantId = "__DEMO_TENANT_ID__";
      const appState = {
        tenantId: demoTenantId,
        route: "workspace",
        settingsTab: "setup",
        contextTab: "summary",
        leftRailCollapsed: false,
        rightRailCollapsed: false,
        focusMode: false,
        activeRunId: null,
        settings: null,
        connections: [],
        profiles: [],
        reportTypes: [],
        skillsInstalled: [],
        skillTools: [],
        skillDrafts: [],
        integrationCatalog: [],
        mcpProviders: [],
        mcpServers: [],
        agentJobs: [],
        deviceCommands: [],
        team: [],
        currentUserId: "ui-user",
        currentUserRole: "owner",
        currentUserName: "Owner",
        folders: [],
        threads: [],
        messagesByThread: {},
        repliesByMessage: {},
        threadAttachmentsByThread: {},
        notifications: [],
        folderAutomations: [],
        workspaceAgentProfile: null,
        teamAppearanceByMember: {},
        activeRightRailTab: "working",
        miniThreadParentMessageId: null,
        activeFolderId: null,
        activeThreadId: null,
        pendingAttachments: [],
        runs: [],
        channelEvents: [],
        sourceRunHistoryByConnection: {},
        insightById: {},
        reportById: {},
        latestInsight: null,
        pendingActions: [],
        metrics: {},
        runPreview: {
          reportText: "Select a report type, then click Preview Output.",
          channelText: "Delivery summary appears here before execute/deliver."
        }
      };

      const savedPrompts = [
        "Forecast next 14 days and explain confidence.",
        "Find anomalies in lead and pipeline movement.",
        "Generate executive summary for this week.",
        "Propose actions with policy constraints."
      ];

      function headers() {
        return {
          "content-type": "application/json",
          "x-tenant-id": appState.tenantId,
          "x-user-id": appState.currentUserId || "ui-user",
          "x-user-role": appState.currentUserRole || "owner"
        };
      }

      async function api(path, options = {}) {
        const res = await fetch(path, {
          ...options,
          headers: {
            ...headers(),
            ...(options.headers || {})
          }
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const err = new Error(data.error || `Request failed: ${res.status}`);
          err.payload = data;
          if (res.status === 403) {
            setSystemAlert(`Permission denied for ${appState.currentUserRole}: ${err.message}`);
          } else if (res.status >= 400 && res.status < 500) {
            setSystemAlert(err.message);
          }
          throw err;
        }
        setSystemAlert("");
        return data;
      }

      function setSystemAlert(message = "") {
        const alert = document.getElementById("systemAlert");
        if (!alert) return;
        if (!message) {
          alert.hidden = true;
          alert.textContent = "";
          return;
        }
        alert.hidden = false;
        alert.textContent = message;
      }

      function renderTenantLabel() {
        const label = document.getElementById("tenantLabel");
        if (!label) return;
        const userName = appState.currentUserName || appState.currentUserId || "user";
        const role = appState.currentUserRole || "owner";
        label.textContent = `Tenant: ${appState.tenantId} • User: ${userName} (${role})`;
      }

      function setRoute(route) {
        appState.route = route;
        document.querySelectorAll("[data-route-target]").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.routeTarget === route);
        });
        document.querySelectorAll(".route").forEach((routeEl) => {
          routeEl.classList.toggle("active", routeEl.id === `route-${route}`);
        });
        applyWorkspaceLayout();
      }

      function applyWorkspaceLayout() {
        const workspace = document.querySelector(".workspace.codex-layout");
        if (!workspace) return;
        workspace.classList.toggle("focus-mode", appState.focusMode);
        workspace.classList.toggle("left-collapsed", appState.leftRailCollapsed);
        workspace.classList.toggle("right-collapsed", appState.rightRailCollapsed);
        const focusBtn = document.getElementById("toggleFocusModeBtn");
        const leftBtn = document.getElementById("toggleLeftRailBtn");
        const rightBtn = document.getElementById("toggleRightRailBtn");
        if (focusBtn) {
          focusBtn.textContent = appState.focusMode ? "Exit Focus" : "Focus";
          focusBtn.classList.toggle("active", appState.focusMode);
          focusBtn.disabled = appState.route !== "workspace";
        }
        if (leftBtn) {
          leftBtn.textContent = appState.leftRailCollapsed ? "Show Left" : "Hide Left";
          leftBtn.disabled = appState.route !== "workspace" || appState.focusMode;
        }
        if (rightBtn) {
          rightBtn.textContent = appState.rightRailCollapsed ? "Show Right" : "Hide Right";
          rightBtn.disabled = appState.route !== "workspace" || appState.focusMode;
        }
      }

      function appendMessage(text, role = "ai") {
        const thread = document.getElementById("thread");
        if (!thread) return;
        const div = document.createElement("div");
        div.className = `msg ${role}`;
        const meta = document.createElement("span");
        meta.className = "msg-meta";
        meta.textContent = role === "user" ? "You" : (appState.workspaceAgentProfile?.name || "InsightFoundry Agent");
        const body = document.createElement("div");
        body.textContent = text;
        div.appendChild(meta);
        div.appendChild(body);
        thread.appendChild(div);
        thread.scrollTop = thread.scrollHeight;
      }

      function formatStatus(status) {
        return `<span class="status mono">${status}</span>`;
      }

      function sourceHealthForConnection(connectionId) {
        const connection = appState.connections.find((item) => item.id === connectionId) || null;
        const freshnessSlaHours = Number(connection?.syncPolicy?.freshnessSlaHours ?? 24);
        const minQualityScore = Number(connection?.qualityPolicy?.minQualityScore ?? 0.75);
        const runs = appState.sourceRunHistoryByConnection[connectionId] || [];
        if (!runs.length) {
          return {
            freshnessLabel: "No sync run",
            freshnessClass: "warn",
            qualityLabel: `Quality n/a (<${minQualityScore.toFixed(2)})`,
            qualityClass: "warn"
          };
        }
        const latest = runs[0];
        const score = Number(latest.diagnostics?.qualityScore ?? 0);
        const ageMs = Date.now() - new Date(latest.createdAt).getTime();
        const ageHours = Math.max(0, Math.round(ageMs / (1000 * 60 * 60)));
        const freshnessClass = ageHours <= freshnessSlaHours ? "good" : ageHours <= freshnessSlaHours * 2 ? "warn" : "bad";
        const qualityClass = score >= minQualityScore ? "good" : score >= Math.max(0, minQualityScore - 0.1) ? "warn" : "bad";
        return {
          freshnessLabel: `Freshness ${ageHours}h (SLA ${freshnessSlaHours}h)`,
          freshnessClass,
          qualityLabel: `Quality ${score.toFixed(2)} (min ${minQualityScore.toFixed(2)})`,
          qualityClass
        };
      }

      function selectedModelProfile() {
        const chatChoice = document.getElementById("chatModelProfileSelect")?.value;
        return appState.profiles.find((item) => item.id === chatChoice)
          || appState.profiles.find((item) => item.id === document.getElementById("runModelSelect")?.value)
          || appState.profiles.find((item) => item.active)
          || null;
      }

      function renderSavedPrompts() {
        const box = document.getElementById("savedPromptList");
        box.innerHTML = "";
        savedPrompts.forEach((prompt) => {
          const btn = document.createElement("button");
          btn.className = "item clickable";
          btn.textContent = prompt;
          btn.onclick = () => {
            document.getElementById("chatInput").value = prompt;
          };
          box.appendChild(btn);
        });
      }

      function currentFolder() {
        return appState.folders.find((item) => item.id === appState.activeFolderId) || null;
      }

      function currentThread() {
        return appState.threads.find((item) => item.id === appState.activeThreadId) || null;
      }

      function currentTeamMember() {
        return appState.team.find((member) => member.id === appState.currentUserId) || null;
      }

      function renderSessionUserControls() {
        const select = document.getElementById("sessionUserSelect");
        const roleBadge = document.getElementById("sessionRoleBadge");
        if (!select || !roleBadge) return;
        const activeMembers = appState.team.filter((member) => member.status !== "inactive");
        const candidateMembers = activeMembers.length ? activeMembers : appState.team;
        if (!candidateMembers.length) {
          select.innerHTML = `<option value="ui-user">ui-user</option>`;
          appState.currentUserId = "ui-user";
          appState.currentUserRole = "owner";
          appState.currentUserName = "Owner";
          roleBadge.textContent = appState.currentUserRole;
          return;
        }
        if (!candidateMembers.some((member) => member.id === appState.currentUserId)) {
          appState.currentUserId = candidateMembers[0].id;
          appState.currentUserRole = candidateMembers[0].role;
          appState.currentUserName = candidateMembers[0].name;
        }
        select.innerHTML = candidateMembers.map((member) => `
          <option value="${member.id}" ${member.id === appState.currentUserId ? "selected" : ""}>
            ${member.name} (${member.role})
          </option>
        `).join("");
        const current = candidateMembers.find((member) => member.id === appState.currentUserId) || candidateMembers[0];
        appState.currentUserRole = current.role;
        appState.currentUserName = current.name;
        roleBadge.textContent = current.role;
      }

      function escapeHtml(input) {
        return String(input ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll("\"", "&quot;")
          .replaceAll("'", "&#39;");
      }

      function teamColorForMember(memberId) {
        if (!memberId) return "#0f766e";
        const explicit = appState.teamAppearanceByMember[memberId];
        if (explicit?.colorHex) return explicit.colorHex;
        let hash = 0;
        for (let i = 0; i < memberId.length; i += 1) hash = (hash * 31 + memberId.charCodeAt(i)) >>> 0;
        const palette = ["#0f766e", "#0b57d0", "#a61e4d", "#7c2d12", "#3f6212", "#5b21b6"];
        return palette[hash % palette.length];
      }

      function messagesForThread(threadId) {
        return appState.messagesByThread[threadId] || [];
      }

      function repliesForMessage(messageId) {
        return appState.repliesByMessage?.[messageId] || [];
      }

      function renderFolderList() {
        const box = document.getElementById("folderList");
        box.innerHTML = "";
        if (!appState.folders.length) {
          box.innerHTML = `<div class="item">No folders yet</div>`;
          return;
        }
        appState.folders.forEach((folder) => {
          const button = document.createElement("button");
          button.className = `item clickable ${folder.id === appState.activeFolderId ? "active" : ""}`;
          const unread = appState.notifications
            .filter((item) => !item.read && item.folderId === folder.id)
            .length;
          button.innerHTML = `
            <div><strong>${folder.name}</strong> ${unread ? `<span class="status mono">${unread} unread</span>` : ""}</div>
            <div class="subtle">${folder.description || ""}</div>
          `;
          button.onclick = async () => {
            appState.activeFolderId = folder.id;
            const threadIds = appState.threads.filter((item) => item.folderId === folder.id).map((item) => item.id);
            if (!threadIds.includes(appState.activeThreadId)) {
              appState.activeThreadId = threadIds[0] || null;
            }
            appState.miniThreadParentMessageId = null;
            await refreshThreadMessages();
            await refreshFolderAutomations();
            renderFolderList();
            renderSidebarAutomations();
            renderThreadList();
            renderSharedThread();
            renderRightRail();
            renderContextPanel();
          };
          box.appendChild(button);
        });
      }

      function renderThreadList() {
        const box = document.getElementById("threadList");
        box.innerHTML = "";
        const folderThreads = appState.threads.filter((item) => item.folderId === appState.activeFolderId);
        if (!folderThreads.length) {
          box.innerHTML = `<div class="item">No threads in this folder</div>`;
          return;
        }
        folderThreads.forEach((thread) => {
          const button = document.createElement("button");
          button.className = `item clickable ${thread.id === appState.activeThreadId ? "active" : ""}`;
          const count = messagesForThread(thread.id).length;
          const unread = appState.notifications.filter((item) => !item.read && item.threadId === thread.id).length;
          button.innerHTML = `
            <div><strong>${thread.title}</strong></div>
            <div class="subtle">${count} messages${unread ? ` • ${unread} unread` : ""}${thread.lastMessageAt ? ` • ${new Date(thread.lastMessageAt).toLocaleString()}` : ""}</div>
          `;
          button.onclick = async () => {
            appState.activeThreadId = thread.id;
            appState.miniThreadParentMessageId = null;
            await refreshThreadMessages();
            renderThreadList();
            renderSharedThread();
            renderRightRail();
            renderContextPanel();
          };
          box.appendChild(button);
        });
      }

      function renderMiniThreadDrawer() {
        const drawer = document.getElementById("miniThreadDrawer");
        const list = document.getElementById("miniThreadList");
        const parentId = appState.miniThreadParentMessageId;
        if (!drawer || !list) return;
        if (!parentId) {
          drawer.style.display = "none";
          return;
        }
        const thread = currentThread();
        if (!thread) {
          drawer.style.display = "none";
          return;
        }
        const parent = messagesForThread(thread.id).find((message) => message.id === parentId)
          || Object.values(appState.repliesByMessage || {}).flat().find((message) => message.id === parentId);
        const replies = repliesForMessage(parentId);
        drawer.style.display = "block";
        document.getElementById("miniThreadTitle").textContent = parent ? `Mini Thread: ${parent.authorName}` : "Mini Thread";
        list.innerHTML = replies.length
          ? replies.map((reply) => `
              <div class="item">
                <div><strong style="color:${teamColorForMember(reply.authorId)}">${escapeHtml(reply.authorName)}</strong> <span class="subtle">${new Date(reply.createdAt).toLocaleString()}</span></div>
                <div>${escapeHtml(reply.body)}</div>
              </div>
            `).join("")
          : `<div class="item">No replies yet.</div>`;
      }

      function renderSharedThread() {
        const threadEl = document.getElementById("thread");
        if (!threadEl) return;
        const thread = currentThread();
        if (!thread) {
          threadEl.innerHTML = `<div class="item">Select a thread or create one from the left rail.</div>`;
          renderMiniThreadDrawer();
          return;
        }
        const messages = messagesForThread(thread.id);
        if (!messages.length) {
          threadEl.innerHTML = `<div class="item">No messages yet in "${thread.title}".</div>`;
          renderMiniThreadDrawer();
          return;
        }
        threadEl.innerHTML = messages.map((message) => {
          const replyCount = Number(message.replyCount ?? 0);
          const inlineReplies = repliesForMessage(message.id);
          const roleClass = message.authorType === "user" ? "user" : "ai";
          const visibility = message.visibility === "private" ? "private" : "shared";
          const visibilityText = visibility === "private" ? "private" : "shared";
          const badges = `<span class="status mono">${visibilityText}</span>${replyCount ? `<span class="status mono">${replyCount} replies</span>` : ""}`;
          const body = escapeHtml(message.body);
          const inlineBlock = inlineReplies.length === 1
            ? `
              <div class="msg reply ${inlineReplies[0].privateHidden ? "private-hidden" : ""}">
                <span class="msg-meta"><strong style="color:${teamColorForMember(inlineReplies[0].authorId)}">${escapeHtml(inlineReplies[0].authorName)}</strong> • ${new Date(inlineReplies[0].createdAt).toLocaleString()}</span>
                <div>${escapeHtml(inlineReplies[0].body)}</div>
              </div>
            `
            : "";
          const miniThreadAction = replyCount > 1
            ? `<button type="button" data-open-mini-thread="${message.id}">Open Mini Thread</button>`
            : "";
          return `
            <div class="msg ${roleClass} ${message.privateHidden ? "private-hidden" : ""}">
              <span class="msg-meta"><strong style="color:${teamColorForMember(message.authorId)}">${escapeHtml(message.authorName)}</strong> • ${new Date(message.createdAt).toLocaleString()} ${badges}</span>
              <div>${body}</div>
              ${inlineBlock}
              <div class="reply-actions">
                <button type="button" data-reply-message="${message.id}">Reply</button>
                ${miniThreadAction}
                <button type="button" data-ask-ai-shared="${message.id}">Ask AI</button>
                <button type="button" data-ask-ai-private="${message.id}">Ask AI Privately</button>
              </div>
            </div>
          `;
        }).join("");
        threadEl.scrollTop = threadEl.scrollHeight;

        threadEl.querySelectorAll("[data-open-mini-thread]").forEach((btn) => {
          btn.onclick = () => {
            appState.miniThreadParentMessageId = btn.dataset.openMiniThread;
            renderMiniThreadDrawer();
          };
        });
        threadEl.querySelectorAll("[data-reply-message]").forEach((btn) => {
          btn.onclick = () => {
            appState.miniThreadParentMessageId = btn.dataset.replyMessage;
            renderMiniThreadDrawer();
            document.getElementById("miniThreadReplyInput")?.focus();
          };
        });
        threadEl.querySelectorAll("[data-ask-ai-shared]").forEach((btn) => {
          btn.onclick = async () => {
            await askAiForMessage(btn.dataset.askAiShared, "shared");
          };
        });
        threadEl.querySelectorAll("[data-ask-ai-private]").forEach((btn) => {
          btn.onclick = async () => {
            await askAiForMessage(btn.dataset.askAiPrivate, "private");
          };
        });
        renderMiniThreadDrawer();
      }

      function renderSidebarSkills() {
        const list = document.getElementById("sidebarSkillsList");
        if (!list) return;
        if (!appState.skillsInstalled.length) {
          list.innerHTML = `<div class="item">No skills installed.</div>`;
          return;
        }
        list.innerHTML = appState.skillsInstalled.slice(0, 10).map((skill) => `
          <div class="item">
            <div><strong>${escapeHtml(skill.manifest?.name || skill.id)}</strong> ${skill.active ? "<span class='status mono'>active</span>" : ""}</div>
            <div class="subtle mono">${escapeHtml(skill.id)}</div>
          </div>
        `).join("");
      }

      function renderSidebarAutomations() {
        const list = document.getElementById("sidebarAutomationsList");
        if (!list) return;
        if (!appState.folderAutomations.length) {
          list.innerHTML = `<div class="item">No automations in this folder.</div>`;
          return;
        }
        list.innerHTML = appState.folderAutomations.map((automation) => `
          <div class="item">
            <div><strong>${escapeHtml(automation.name)}</strong> <span class="status mono">${automation.triggerType}</span></div>
            <div class="subtle">${automation.enabled ? "enabled" : "disabled"} • ${automation.actionType}</div>
          </div>
        `).join("");
      }

      function renderChatModelSelect() {
        const select = document.getElementById("chatModelProfileSelect");
        if (!select) return;
        const active = selectedModelProfile();
        fillSelect("chatModelProfileSelect", appState.profiles, "id", "name", true, "Auto (active profile)", active?.id ?? "");
      }

      function renderAttachmentTray() {
        const tray = document.getElementById("chatAttachments");
        if (!tray) return;
        if (!appState.pendingAttachments.length) {
          tray.innerHTML = "";
          return;
        }
        tray.innerHTML = appState.pendingAttachments.map((file, idx) => `
          <button type="button" class="attachment-pill" data-remove-attachment="${idx}">
            ${file.name} (${Math.max(1, Math.round(file.size / 1024))} KB) ×
          </button>
        `).join("");
        tray.querySelectorAll("[data-remove-attachment]").forEach((btn) => {
          btn.onclick = () => {
            const idx = Number(btn.dataset.removeAttachment);
            appState.pendingAttachments = appState.pendingAttachments.filter((_, i) => i !== idx);
            renderAttachmentTray();
          };
        });
      }

      function renderChatQuickActions() {
        const bar = document.getElementById("chatQuickActionBar");
        if (!bar) return;
        const prompts = [
          "Summarize current data quality and gaps.",
          "Run a 14 day revenue forecast and explain confidence.",
          "Generate actions for leadership this week."
        ];
        bar.innerHTML = prompts.map((prompt, idx) => `<button type="button" data-chat-quick="${idx}">${prompt}</button>`).join("");
        bar.querySelectorAll("[data-chat-quick]").forEach((btn) => {
          btn.onclick = () => {
            const prompt = prompts[Number(btn.dataset.chatQuick)];
            document.getElementById("chatInput").value = prompt;
            document.getElementById("chatInput").focus();
          };
        });
      }

      function setRightRailTab(tab) {
        appState.activeRightRailTab = tab;
        const workingBtn = document.getElementById("rightRailTabWorking");
        const attachmentsBtn = document.getElementById("rightRailTabAttachments");
        const notificationsBtn = document.getElementById("rightRailTabNotifications");
        if (workingBtn) workingBtn.classList.toggle("active", tab === "working");
        if (attachmentsBtn) attachmentsBtn.classList.toggle("active", tab === "attachments");
        if (notificationsBtn) notificationsBtn.classList.toggle("active", tab === "notifications");
        const workingPanel = document.getElementById("rightRailWorkingPanel");
        const attachmentsPanel = document.getElementById("rightRailAttachmentsPanel");
        const notificationsPanel = document.getElementById("rightRailNotificationsPanel");
        const contextTabs = document.getElementById("contextTabsCard");
        const contextBody = document.getElementById("contextBody");
        if (workingPanel) workingPanel.style.display = tab === "working" ? "block" : "none";
        if (attachmentsPanel) attachmentsPanel.style.display = tab === "attachments" ? "block" : "none";
        if (notificationsPanel) notificationsPanel.style.display = tab === "notifications" ? "block" : "none";
        if (contextTabs) contextTabs.style.display = tab === "working" ? "flex" : "none";
        if (contextBody) contextBody.style.display = tab === "working" ? "block" : "none";
      }

      function renderRightAttachments() {
        const list = document.getElementById("rightAttachmentsList");
        if (!list) return;
        const threadId = appState.activeThreadId;
        const attachments = threadId ? (appState.threadAttachmentsByThread[threadId] || []) : [];
        if (!attachments.length) {
          list.innerHTML = `<div class="item">No files or screenshots yet.</div>`;
          return;
        }
        list.innerHTML = attachments.map((attachment) => `
          <div class="item">
            <div><strong>${escapeHtml(attachment.name)}</strong></div>
            <div class="subtle">${attachment.type || "file"} • ${Math.max(1, Math.round((attachment.size || 0) / 1024))} KB</div>
            <div class="subtle">from ${escapeHtml(attachment.authorName || "unknown")} • ${new Date(attachment.createdAt).toLocaleString()}</div>
          </div>
        `).join("");
      }

      function renderRightNotifications() {
        const list = document.getElementById("rightNotificationsList");
        if (!list) return;
        if (!appState.notifications.length) {
          list.innerHTML = `<div class="item">No notifications.</div>`;
          return;
        }
        list.innerHTML = appState.notifications.slice(0, 40).map((notification) => `
          <div class="item">
            <div><strong>${escapeHtml(notification.title)}</strong> ${notification.read ? "" : "<span class='status mono'>new</span>"}</div>
            <div class="subtle">${notification.kind} • ${new Date(notification.createdAt).toLocaleString()}</div>
            <div class="toolbar" style="margin-top:6px">
              ${notification.read ? "" : `<button type="button" data-mark-notification-read="${notification.id}">Mark Read</button>`}
            </div>
          </div>
        `).join("");
        list.querySelectorAll("[data-mark-notification-read]").forEach((btn) => {
          btn.onclick = async () => {
            await api(`/v1/workspace/notifications/${encodeURIComponent(btn.dataset.markNotificationRead)}/read`, {
              method: "POST"
            });
            await loadAll();
            setRightRailTab("notifications");
          };
        });
      }

      function renderRightRail() {
        renderRightAttachments();
        renderRightNotifications();
        setRightRailTab(appState.activeRightRailTab || "working");
      }

      async function applyStarterPack() {
        try {
          const hasSource = Array.isArray(appState.connections) && appState.connections.length > 0;
          if (!hasSource) {
            await api("/v1/integrations/quick-add", {
              method: "POST",
              body: JSON.stringify({
                integrationKey: "google_ads",
                authRef: "starter_demo_token",
                periodDays: 21,
                runInitialSync: true
              })
            });
          }

          const hasReport = Array.isArray(appState.reportTypes) && appState.reportTypes.length > 0;
          if (!hasReport) {
            await api("/v1/reports/types", {
              method: "POST",
              body: JSON.stringify({
                name: "Starter Executive Brief",
                sections: ["kpi_snapshot", "trend_chart", "narrative", "actions"],
                defaultChannels: ["email"],
                defaultFormat: "html"
              })
            });
          }

          await loadAll();
          if (!appState.activeRunId) {
            await createDraftRunFromBuilder();
          }
          appendMessage("Starter pack applied. You can execute a run now.");
        } catch (error) {
          appendMessage(`Starter pack error: ${error.message}`);
        }
      }

      function renderOnboarding() {
        const checklist = appState.settings?.checklist || {};
        const done = Object.values(checklist).filter(Boolean).length;
        const total = Object.keys(checklist).length || 4;
        const pct = total ? Math.round((done / total) * 100) : 0;
        const nextStep = !checklist.connectionsConfigured
          ? "Open Settings > Connections to link your first source."
          : !checklist.modelProfileConfigured
            ? "Open Settings > Models to activate a model profile."
            : !checklist.reportTypeConfigured
              ? "Open Settings > Reports to create a report type."
              : !checklist.channelsConfigured
                ? "Open Settings > Channels to configure delivery."
                : "Checklist complete. Create and execute your first guided run.";
        document.getElementById("onboardingChecklist").innerHTML = `
          <strong>Onboarding Checklist</strong> (${done}/${total})
          <div class="progress-track" style="margin-top:6px"><div class="progress-fill" style="width:${pct}%"></div></div>
          <div class="subtle" style="margin-top:6px">Connections: ${checklist.connectionsConfigured ? "Done" : "Pending"} | 
          Model: ${checklist.modelProfileConfigured ? "Done" : "Pending"} | 
          Report: ${checklist.reportTypeConfigured ? "Done" : "Pending"} | 
          Channels: ${checklist.channelsConfigured ? "Done" : "Pending"}</div>
          <div class="toolbar" style="margin-top:8px">
            <button type="button" id="onboardGoIntegrationsBtn">Connect Data</button>
            <button type="button" id="onboardGoModelsBtn">Choose Model</button>
            <button type="button" id="onboardGoChannelsBtn">Delivery</button>
            <button type="button" id="onboardStarterPackBtn" class="primary">Load Starter Pack</button>
          </div>
          <span class="subtle">${nextStep}</span>
        `;
        const goIntegrations = document.getElementById("onboardGoIntegrationsBtn");
        if (goIntegrations) goIntegrations.onclick = () => openSettingsTab("integrations");
        const goModels = document.getElementById("onboardGoModelsBtn");
        if (goModels) goModels.onclick = () => openSettingsTab("models");
        const goChannels = document.getElementById("onboardGoChannelsBtn");
        if (goChannels) goChannels.onclick = () => openSettingsTab("channels");
        const starterPack = document.getElementById("onboardStarterPackBtn");
        if (starterPack) {
          starterPack.onclick = async () => {
            await applyStarterPack();
          };
        }
      }

      function renderRunContextList() {
        const box = document.getElementById("runContextList");
        box.innerHTML = "";
        if (!appState.runs.length) {
          box.innerHTML = `<div class="item">No analysis runs yet</div>`;
          return;
        }
        appState.runs.slice().reverse().forEach((run) => {
          const health = sourceHealthForConnection(run.sourceConnectionId);
          const btn = document.createElement("button");
          btn.className = `item clickable ${run.id === appState.activeRunId ? "active" : ""}`;
          btn.innerHTML = `
            <div class="mono">${run.id.slice(0, 18)}...</div>
            <div>${formatStatus(run.status)}</div>
            <div class="badges" style="margin-top:6px">
              <span class="badge ${health.freshnessClass}">${health.freshnessLabel}</span>
              <span class="badge ${health.qualityClass}">${health.qualityLabel}</span>
            </div>
          `;
          btn.onclick = async () => {
            appState.activeRunId = run.id;
            await refreshRunArtifacts();
            renderRunContextList();
            renderDataContextStrip();
            renderContextPanel();
            renderRunDetail();
          };
          box.appendChild(btn);
        });
      }

      function renderKPIs() {
        const grid = document.getElementById("kpiGrid");
        if (!grid) return;
        grid.innerHTML = "";
        ["revenue", "profit", "spend"].forEach((metric) => {
          const value = appState.metrics[metric] || 0;
          const el = document.createElement("div");
          el.className = "kpi";
          el.innerHTML = `<div class="subtle mono">${metric}</div><div class="val">${Math.round(value)}</div>`;
          grid.appendChild(el);
        });
      }

      function currentRun() {
        return appState.runs.find((item) => item.id === appState.activeRunId) || null;
      }

      function renderDataContextStrip() {
        const box = document.getElementById("dataContextStrip");
        if (!box) return;
        const run = currentRun();
        const folder = currentFolder();
        const thread = currentThread();
        const source = appState.connections.find((item) => item.id === (run?.sourceConnectionId || document.getElementById("runSourceSelect")?.value)) || null;
        const model = appState.profiles.find((item) => item.id === (run?.modelProfileId || document.getElementById("runModelSelect")?.value)) || null;
        const reportType = appState.reportTypes.find((item) => item.id === (run?.reportTypeId || document.getElementById("runReportSelect")?.value)) || null;
        const skill = appState.skillsInstalled.find((item) => item.id === (run?.skillId || document.getElementById("runSkillSelect")?.value)) || null;
        const insight = run?.artifacts?.insightId ? appState.insightById[run.artifacts.insightId] : appState.latestInsight;
        box.innerHTML = `
          <div class="subtle mono">DATA CONTEXT</div>
          <div class="context-grid" style="margin-top:8px">
            <div class="context-kv"><div class="subtle">Folder</div><div>${folder?.name || "None"}</div></div>
            <div class="context-kv"><div class="subtle">Thread</div><div>${thread?.title || "None"}</div></div>
            <div class="context-kv"><div class="subtle">Source</div><div>${source?.sourceType || "Not selected"}</div></div>
            <div class="context-kv"><div class="subtle">Model</div><div>${model?.name || "Not selected"}</div></div>
            <div class="context-kv"><div class="subtle">Report</div><div>${reportType?.name || "Not selected"}</div></div>
            <div class="context-kv"><div class="subtle">Skill</div><div>${skill?.id || "None"}</div></div>
            <div class="context-kv"><div class="subtle">Run Status</div><div>${run ? run.status : "Drafting"}</div></div>
            <div class="context-kv"><div class="subtle">Confidence</div><div>${insight?.confidence != null ? Number(insight.confidence).toFixed(2) : "n/a"}</div></div>
            <div class="context-kv"><div class="subtle">Workspace Agent</div><div>${appState.workspaceAgentProfile?.name || "InsightFoundry Agent"}</div></div>
            <div class="context-kv"><div class="subtle">Acting As</div><div>${appState.currentUserName || appState.currentUserId} (${appState.currentUserRole})</div></div>
            <div class="context-kv"><div class="subtle">Unread Notifications</div><div>${appState.notifications.filter((item) => !item.read).length}</div></div>
          </div>
        `;
      }

      function renderRunHealthBadges() {
        const box = document.getElementById("runHealthBadges");
        const run = currentRun();
        if (!run) {
          box.innerHTML = `<span class="badge warn">No active run</span>`;
          return;
        }
        const health = sourceHealthForConnection(run.sourceConnectionId);
        const insight = run.artifacts?.insightId ? appState.insightById[run.artifacts.insightId] : null;
        const confidence = insight?.confidence;
        const confidenceClass = typeof confidence === "number"
          ? (confidence >= 0.8 ? "good" : confidence >= 0.65 ? "warn" : "bad")
          : "warn";
        box.innerHTML = `
          <span class="badge ${run.status === "completed" ? "good" : run.status === "failed" ? "bad" : "warn"}">Run ${run.status}</span>
          <span class="badge ${health.freshnessClass}">${health.freshnessLabel}</span>
          <span class="badge ${health.qualityClass}">${health.qualityLabel}</span>
          <span class="badge ${confidenceClass}">Confidence ${typeof confidence === "number" ? confidence.toFixed(2) : "n/a"}</span>
        `;
      }

      function renderContextPanel() {
        const body = document.getElementById("contextBody");
        const run = currentRun();
        const tab = appState.contextTab;
        renderRunHealthBadges();

        if (tab === "summary") {
          const selectedInsight = run?.artifacts?.insightId ? appState.insightById[run.artifacts.insightId] : null;
          body.innerHTML = `
            <h4>Current Context</h4>
            <div class="subtle">${run ? `Run ${run.id}` : "No run selected"}</div>
            <div class="item" style="margin-top:8px">${selectedInsight?.summary || appState.latestInsight?.summary || "No insight yet. Configure connection, model, and report type, then execute a run."}</div>
          `;
        }

        if (tab === "evidence") {
          const selectedInsight = run?.artifacts?.insightId ? appState.insightById[run.artifacts.insightId] : null;
          const report = run?.artifacts?.reportId ? appState.reportById[run.artifacts.reportId] : null;
          const latestSourceRun = run?.sourceConnectionId ? (appState.sourceRunHistoryByConnection[run.sourceConnectionId] || [])[0] : null;
          body.innerHTML = `
            <h4>Evidence</h4>
            <div class="evidence-list">
              <div class="item">Insight ID: ${run?.artifacts?.insightId || "n/a"}</div>
              <div class="item">Confidence: ${selectedInsight?.confidence ?? "n/a"}</div>
              <div class="item">Model Quality Warnings: ${(selectedInsight?.qualityWarnings || []).join(", ") || "none"}</div>
              <div class="item">Forecast Points: ${selectedInsight?.forecast?.points?.length ?? 0}</div>
              <div class="item">Source Run: ${latestSourceRun?.id || "n/a"}</div>
              <div class="item">Source Diagnostics: quality=${latestSourceRun?.diagnostics?.qualityScore ?? "n/a"}, retries=${latestSourceRun?.diagnostics?.retries ?? "n/a"}, records=${latestSourceRun?.diagnostics?.insertedRecords ?? "n/a"}, qualityPassed=${latestSourceRun?.diagnostics?.qualityPassed ?? "n/a"}</div>
              <div class="item">Quality Checks: ${(latestSourceRun?.diagnostics?.qualityChecks || []).map((c) => `${c.check}:${c.status}`).join(", ") || "n/a"}</div>
              <div class="item">Report ID: ${run?.artifacts?.reportId || "n/a"}</div>
              <div class="item">Report Summary: ${report?.summary || "n/a"}</div>
            </div>
          `;
        }

        if (tab === "actions") {
          const actions = appState.pendingActions || [];
          const devicePending = (appState.deviceCommands || []).filter((item) => item.status === "pending_approval");
          body.innerHTML = `
            <h4>Actions</h4>
            <div class="subtle">Model/insight actions + device command approvals</div>
            <div class="list" style="margin-top:8px">
              ${actions.length
                ? actions.map((a) => `<div class="item">${a.actionType} (${a.policyDecision})</div>`).join("")
                : `<div class="item">No pending model actions</div>`}
            </div>
            <h4 style="margin-top:10px">Device Command Approvals</h4>
            <div class="list">
              ${devicePending.length
                ? devicePending.map((request) => `
                    <div class="item">
                      <div><strong>${request.command}</strong> ${request.args?.length ? request.args.join(" ") : ""}</div>
                      <div class="subtle">${request.policyReason} • ${new Date(request.createdAt).toLocaleString()}</div>
                      <div class="toolbar" style="margin-top:6px">
                        <button data-approve-device-command="${request.id}">Approve & Execute</button>
                        <button data-reject-device-command="${request.id}">Reject</button>
                      </div>
                    </div>
                  `).join("")
                : `<div class="item">No pending device command approvals</div>`}
            </div>
          `;

          body.querySelectorAll("[data-approve-device-command]").forEach((btn) => {
            btn.onclick = async () => {
              await api(`/v1/agents/device-commands/${encodeURIComponent(btn.dataset.approveDeviceCommand)}/approve`, {
                method: "POST",
                body: JSON.stringify({
                  decision: "approve",
                  executeNow: true
                })
              });
              await loadAll();
              setContextTab("actions");
              appendMessage("Device command approved and executed.");
            };
          });
          body.querySelectorAll("[data-reject-device-command]").forEach((btn) => {
            btn.onclick = async () => {
              await api(`/v1/agents/device-commands/${encodeURIComponent(btn.dataset.rejectDeviceCommand)}/approve`, {
                method: "POST",
                body: JSON.stringify({
                  decision: "reject",
                  executeNow: false
                })
              });
              await loadAll();
              setContextTab("actions");
              appendMessage("Device command rejected.");
            };
          });
        }

        if (tab === "artifacts") {
          body.innerHTML = run
            ? `<h4>Artifacts</h4><div class="item">Insight: ${run.artifacts?.insightId || "none"}</div><div class="item">Report: ${run.artifacts?.reportId || "none"}</div><div class="item">Channels: ${(run.artifacts?.channelEventIds || []).length}</div>`
            : `<h4>Artifacts</h4><div class="item">No run selected</div>`;
        }

        if (tab === "comments") {
          const thread = currentThread();
          const comments = thread ? (appState.messagesByThread[thread.id] || []) : [];
          body.innerHTML = `
            <h4>Thread Feed</h4>
            <div class="subtle">${thread ? thread.title : "No thread selected"}</div>
            <div class="list" style="margin-top:8px">
              ${comments.length ? comments.slice(-10).map((comment) => `
                <div class="item">
                  <div><strong style="color:${teamColorForMember(comment.authorId)}">${comment.authorName}</strong> <span class="subtle">${new Date(comment.createdAt).toLocaleString()}</span></div>
                  <div>${escapeHtml(comment.body)}</div>
                </div>
              `).join("") : `<div class="item">No comments yet</div>`}
            </div>
            <div class="toolbar" style="margin-top:8px">
              <input id="quickCommentInput" placeholder="Leave a message in this thread" />
              <button id="quickCommentBtn" type="button">Send</button>
            </div>
          `;
          const quickCommentBtn = document.getElementById("quickCommentBtn");
          if (quickCommentBtn) {
            quickCommentBtn.onclick = async () => {
              const quickCommentInput = document.getElementById("quickCommentInput");
              const text = quickCommentInput?.value?.trim() ?? "";
              if (!text || !thread) return;
              await api(`/v1/workspace/chat/threads/${encodeURIComponent(thread.id)}/messages`, {
                method: "POST",
                body: JSON.stringify({
                  authorName: "ui-user",
                  authorType: "user",
                  visibility: "shared",
                  body: text
                })
              });
              quickCommentInput.value = "";
              await loadAll();
              setContextTab("comments");
            };
          }
        }
      }

      function fillSelect(selectId, options, valueKey, labelKey, includeEmpty = false, emptyLabel = "Select...", preferredValue = null) {
        const select = document.getElementById(selectId);
        if (!select) return;
        const previous = select.value;
        select.innerHTML = "";
        if (includeEmpty) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = emptyLabel;
          select.appendChild(opt);
        }
        options.forEach((item) => {
          const opt = document.createElement("option");
          opt.value = item[valueKey];
          opt.textContent = item[labelKey];
          select.appendChild(opt);
        });
        const candidate = preferredValue ?? previous;
        if (candidate != null) {
          select.value = String(candidate);
        }
      }

      function renderRunBuilder() {
        const run = currentRun();
        fillSelect("runSourceSelect", appState.connections, "id", "sourceType", true, "Select...", run?.sourceConnectionId ?? null);
        fillSelect("runModelSelect", appState.profiles, "id", "name", true, "Select...", run?.modelProfileId ?? null);
        fillSelect("runReportSelect", appState.reportTypes, "id", "name", true, "Select...", run?.reportTypeId ?? null);

        const skillOptions = [{ id: "", name: "No skill" }, ...appState.skillsInstalled.map((s) => ({ id: s.id, name: s.id }))];
        fillSelect("runSkillSelect", skillOptions, "id", "name", false, "Select...", run?.skillId ?? "");
        if (run?.channels?.length) {
          document.getElementById("runChannelsInput").value = run.channels.join(",");
        }
        renderChatModelSelect();
        renderDataContextStrip();
      }

      function renderRunPreviews() {
        document.getElementById("runReportPreview").textContent = appState.runPreview.reportText;
        document.getElementById("runChannelPreview").textContent = appState.runPreview.channelText;
      }

      async function previewCurrentRunOutput() {
        const reportTypeId = document.getElementById("runReportSelect").value;
        const channels = document.getElementById("runChannelsInput").value.split(",").map((s) => s.trim()).filter(Boolean);
        if (!reportTypeId) {
          appState.runPreview.reportText = "Select a report type to preview.";
          appState.runPreview.channelText = "Select channels to preview delivery.";
          renderRunPreviews();
          return;
        }

        const preview = await api(`/v1/reports/types/${encodeURIComponent(reportTypeId)}/preview`, {
          method: "POST"
        });
        appState.runPreview.reportText = preview.preview;

        const run = currentRun();
        const insight = run?.artifacts?.insightId ? appState.insightById[run.artifacts.insightId] : appState.latestInsight;
        const confidence = insight?.confidence != null ? Number(insight.confidence).toFixed(2) : "n/a";
        const summary = insight?.summary || "No insight summary yet. Execute run to generate narrative.";
        const reportType = appState.reportTypes.find((item) => item.id === reportTypeId) || null;
        const reportName = reportType?.name || "Selected report";
        const deliveryPreview = await api(`/v1/reports/types/${encodeURIComponent(reportTypeId)}/delivery-preview`, {
          method: "POST",
          body: JSON.stringify({
            channels,
            reportTitle: reportName,
            reportSummary: summary,
            context: {
              runId: run?.id || "draft",
              insightId: insight?.id || "n/a",
              confidence,
              actionsCount: insight?.recommendedActions?.length ?? 0
            }
          })
        });
        const channelLines = (deliveryPreview.previews || []).map((previewItem) => {
          const readiness = previewItem.ready ? "ready" : `not_ready(${previewItem.reason || "unknown"})`;
          return `- ${previewItem.channel} [${readiness}]: ${previewItem.message}`;
        });

        appState.runPreview.channelText = [
          `Delivery Channels: ${channels.join(", ") || "none selected"}`,
          `Report: ${reportName}`,
          `Confidence: ${confidence}`,
          "",
          ...channelLines
        ].join("\n");
        renderRunPreviews();
      }

      function renderRunList() {
        const box = document.getElementById("runList");
        box.innerHTML = "";
        if (!appState.runs.length) {
          box.innerHTML = `<div class="item">No runs created</div>`;
          return;
        }
        appState.runs.slice().reverse().forEach((run) => {
          const health = sourceHealthForConnection(run.sourceConnectionId);
          const btn = document.createElement("button");
          btn.className = "item clickable";
          btn.innerHTML = `
            <div class="mono">${run.id}</div>
            <div>${formatStatus(run.status)}</div>
            <div class="badges" style="margin-top:6px">
              <span class="badge ${health.freshnessClass}">${health.freshnessLabel}</span>
              <span class="badge ${health.qualityClass}">${health.qualityLabel}</span>
            </div>
          `;
          btn.onclick = async () => {
            appState.activeRunId = run.id;
            await refreshRunArtifacts();
            renderRunDetail();
            renderRunContextList();
            renderDataContextStrip();
            renderContextPanel();
          };
          box.appendChild(btn);
        });
      }

      function renderRunDetail() {
        const box = document.getElementById("runDetail");
        const run = currentRun();
        if (!run) {
          box.innerHTML = `<h3>Run Detail</h3><div class="item">Select a run to view timeline and artifacts.</div>`;
          return;
        }
        const health = sourceHealthForConnection(run.sourceConnectionId);
        const stepRows = (run.steps || []).map((step) => `
          <div class="item">
            <div><strong>${step.name}</strong> ${formatStatus(step.status)}</div>
            <div class="subtle">${step.detail || ""}</div>
          </div>
        `).join("");
        const deliveryEvents = (run.artifacts?.channelEventIds || [])
          .map((eventId) => appState.channelEvents.find((event) => event.id === eventId))
          .filter(Boolean);
        const deliveryRows = deliveryEvents.length
          ? deliveryEvents.map((event) => `
              <div class="item">
                <div><strong>${event.channel}</strong> ${formatStatus(event.status || "unknown")}</div>
                <div class="subtle">attempt ${event.attemptCount || 1}/${event.maxAttempts || 3} | http ${event.responseMetadata?.httpStatus ?? "n/a"}</div>
                <div class="subtle">${event.lastError || "ok"}</div>
                <div class="mono" style="font-size:11px; white-space:pre-wrap">${event.payload?.message || ""}</div>
                ${(event.status === "failed" || event.status === "failed_permanent") ? `<div class="toolbar" style="margin-top:6px"><button data-retry-channel-event="${event.id}">Retry</button></div>` : ""}
              </div>
            `).join("")
          : `<div class="item">No delivery events yet</div>`;

        box.innerHTML = `
          <h3>${run.id}</h3>
          <div>${formatStatus(run.status)}</div>
          <div class="badges">
            <span class="badge ${health.freshnessClass}">${health.freshnessLabel}</span>
            <span class="badge ${health.qualityClass}">${health.qualityLabel}</span>
          </div>
          <div class="item">Source: ${run.sourceConnectionId || "n/a"}</div>
          <div class="item">Model Profile: ${run.modelProfileId || "n/a"}</div>
          <div class="item">Report Type: ${run.reportTypeId || "n/a"}</div>
          <h4>Steps</h4>
          ${stepRows || `<div class="item">No step data</div>`}
          <h4>Deliveries</h4>
          ${deliveryRows}
          <h4>Timeline</h4>
          <div class="timeline">${(run.timeline || []).map((t) => `<div class="item"><div class="mono">${new Date(t.at).toLocaleTimeString()}</div><div>${t.event}</div><div class="subtle">${t.detail || ""}</div></div>`).join("")}</div>
        `;

        box.querySelectorAll("[data-retry-channel-event]").forEach((btn) => {
          btn.onclick = async () => {
            await retryDeliveryEvent(btn.dataset.retryChannelEvent);
          };
        });
      }

      function renderSettingsGeneral() {
        const settings = appState.settings || {};
        const box = document.getElementById("settings-general");
        box.innerHTML = `
          <h3>General</h3>
          <div class="form-grid">
            <label>Name<input id="generalName" value="${settings.general?.name || ""}" /></label>
            <label>Timezone<input id="generalTimezone" value="${settings.general?.timezone || "America/New_York"}" /></label>
            <label>Locale<input id="generalLocale" value="${settings.general?.locale || "en-US"}" /></label>
            <label>Brand Primary<input id="generalPrimary" value="${settings.general?.branding?.primary || "#0c8f6b"}" /></label>
            <button id="saveGeneral" class="primary">Save General</button>
          </div>
        `;
        document.getElementById("saveGeneral").onclick = async () => {
          await api("/v1/settings/general", {
            method: "PATCH",
            body: JSON.stringify({
              name: document.getElementById("generalName").value,
              timezone: document.getElementById("generalTimezone").value,
              locale: document.getElementById("generalLocale").value,
              branding: { primary: document.getElementById("generalPrimary").value }
            })
          });
          await loadAll();
          appendMessage("General settings updated.");
        };
      }

      function renderSettingsTeam() {
        const agent = appState.workspaceAgentProfile || {};
        const current = currentTeamMember();
        const box = document.getElementById("settings-team");
        box.innerHTML = `
          <h3>Users and Team</h3>
          <div class="card" style="margin-top:8px">
            <h4>Session User (Real Testing)</h4>
            <div class="subtle">Switch who the UI acts as to test role-based access, private AI visibility, and notifications.</div>
            <div class="form-grid" style="margin-top:8px">
              <label>Active User
                <select id="teamSessionUserSelect"></select>
              </label>
              <label>Role<input id="teamSessionRole" disabled value="${current?.role || appState.currentUserRole}" /></label>
              <label class="full">Status<input id="teamSessionStatus" disabled value="${current?.status || "active"}" /></label>
            </div>
          </div>
          <div class="card" style="margin-top:8px">
            <h4>Workspace Agent</h4>
            <div class="form-grid">
              <label>Name<input id="workspaceAgentName" value="${agent.name || "InsightFoundry Agent"}" /></label>
              <label>Tone
                <select id="workspaceAgentTone">
                  <option value="operator" ${agent.tonePreset === "operator" ? "selected" : ""}>operator</option>
                  <option value="analyst" ${agent.tonePreset === "analyst" ? "selected" : ""}>analyst</option>
                  <option value="executive" ${agent.tonePreset === "executive" ? "selected" : ""}>executive</option>
                </select>
              </label>
              <label>Avatar
                <select id="workspaceAgentAvatar">
                  <option value="orb" ${agent.avatarStyle === "orb" ? "selected" : ""}>orb</option>
                  <option value="badge" ${agent.avatarStyle === "badge" ? "selected" : ""}>badge</option>
                </select>
              </label>
              <button id="saveWorkspaceAgentBtn" class="primary">Save Agent</button>
            </div>
          </div>
          <div class="subtle">Add members and manage role/status/title for shared workspace threads, approvals, and automations.</div>
          <div class="form-grid" style="margin-top:8px">
            <label>Name<input id="teamName" placeholder="Alex Rivera" /></label>
            <label>Email<input id="teamEmail" placeholder="alex@firm.com" /></label>
            <label>Role
              <select id="teamRole">
                <option value="owner">owner</option>
                <option value="admin">admin</option>
                <option value="operator">operator</option>
                <option value="analyst" selected>analyst</option>
                <option value="viewer">viewer</option>
              </select>
            </label>
            <label>Title<input id="teamTitle" placeholder="RevOps Lead" /></label>
            <button id="addTeamMemberBtn" class="primary">Add Team Member</button>
          </div>
          <div class="list" id="teamList" style="margin-top:10px"></div>
        `;

        const teamList = document.getElementById("teamList");
        teamList.innerHTML = appState.team.length
          ? appState.team.map((member) => `
              <div class="item" data-member-id="${member.id}">
                <div><strong>${member.name}</strong> <span class="status mono">${member.role}</span></div>
                <div class="subtle">${member.email}${member.title ? ` • ${member.title}` : ""}</div>
                <div class="form-grid" style="margin-top:8px">
                  <label>Name<input data-member-name value="${escapeHtml(member.name)}" /></label>
                  <label>Title<input data-member-title value="${escapeHtml(member.title || "")}" /></label>
                  <label>Email<input data-member-email value="${escapeHtml(member.email || "")}" /></label>
                  <label>Role
                    <select data-member-role>
                      <option value="owner" ${member.role === "owner" ? "selected" : ""}>owner</option>
                      <option value="admin" ${member.role === "admin" ? "selected" : ""}>admin</option>
                      <option value="operator" ${member.role === "operator" ? "selected" : ""}>operator</option>
                      <option value="analyst" ${member.role === "analyst" ? "selected" : ""}>analyst</option>
                      <option value="viewer" ${member.role === "viewer" ? "selected" : ""}>viewer</option>
                    </select>
                  </label>
                  <label>Status
                    <select data-member-status>
                      <option value="active" ${member.status === "active" ? "selected" : ""}>active</option>
                      <option value="paused" ${member.status === "paused" ? "selected" : ""}>paused</option>
                      <option value="inactive" ${member.status === "inactive" ? "selected" : ""}>inactive</option>
                    </select>
                  </label>
                  <label>Color Mode
                    <select data-member-color-mode>
                      <option value="deterministic" ${(appState.teamAppearanceByMember[member.id]?.colorMode || "deterministic") === "deterministic" ? "selected" : ""}>deterministic</option>
                      <option value="manual" ${(appState.teamAppearanceByMember[member.id]?.colorMode || "deterministic") === "manual" ? "selected" : ""}>manual</option>
                    </select>
                  </label>
                  <label>Color Hex<input data-member-color value="${appState.teamAppearanceByMember[member.id]?.colorHex || teamColorForMember(member.id)}" /></label>
                  <div class="toolbar" style="grid-column:1 / -1">
                    <button data-save-member="${member.id}" class="primary">Save Member</button>
                    <button data-save-member-color="${member.id}">Save Color</button>
                    <button data-act-as-member="${member.id}">Act As This User</button>
                  </div>
                </div>
              </div>
            `).join("")
          : `<div class="item">No team members yet</div>`;

        const teamSessionUserSelect = document.getElementById("teamSessionUserSelect");
        if (teamSessionUserSelect) {
          const members = appState.team.filter((member) => member.status !== "inactive");
          teamSessionUserSelect.innerHTML = members.map((member) => `
            <option value="${member.id}" ${member.id === appState.currentUserId ? "selected" : ""}>${member.name} (${member.role})</option>
          `).join("");
          teamSessionUserSelect.onchange = async () => {
            const selected = appState.team.find((member) => member.id === teamSessionUserSelect.value);
            if (!selected) return;
            appState.currentUserId = selected.id;
            appState.currentUserRole = selected.role;
            appState.currentUserName = selected.name;
            renderSessionUserControls();
            await loadAll();
            setSettingsTab("team");
          };
        }

        const saveWorkspaceAgentBtn = document.getElementById("saveWorkspaceAgentBtn");
        if (saveWorkspaceAgentBtn) {
          saveWorkspaceAgentBtn.onclick = async () => {
            await api("/v1/settings/workspace-agent", {
              method: "PATCH",
              body: JSON.stringify({
                name: document.getElementById("workspaceAgentName").value,
                tonePreset: document.getElementById("workspaceAgentTone").value,
                avatarStyle: document.getElementById("workspaceAgentAvatar").value
              })
            });
            await loadAll();
            setSettingsTab("team");
          };
        }

        teamList.querySelectorAll("[data-save-member]").forEach((btn) => {
          btn.onclick = async () => {
            const container = btn.closest("[data-member-id]");
            if (!container) return;
            const memberId = btn.dataset.saveMember;
            const patchBody = {
              name: container.querySelector("[data-member-name]")?.value?.trim(),
              title: container.querySelector("[data-member-title]")?.value?.trim(),
              email: container.querySelector("[data-member-email]")?.value?.trim(),
              role: container.querySelector("[data-member-role]")?.value,
              status: container.querySelector("[data-member-status]")?.value
            };
            await api(`/v1/settings/team/${encodeURIComponent(memberId)}`, {
              method: "PATCH",
              body: JSON.stringify(patchBody)
            });
            const selected = appState.team.find((member) => member.id === appState.currentUserId);
            if (selected && selected.id === memberId) {
              appState.currentUserRole = patchBody.role || selected.role;
              if (patchBody.status === "inactive") {
                const fallback = appState.team.find((member) => member.id !== memberId && member.status !== "inactive");
                if (fallback) {
                  appState.currentUserId = fallback.id;
                  appState.currentUserRole = fallback.role;
                  appState.currentUserName = fallback.name;
                }
              }
            }
            await loadAll();
            setSettingsTab("team");
          };
        });

        teamList.querySelectorAll("[data-save-member-color]").forEach((btn) => {
          btn.onclick = async () => {
            const container = btn.closest("[data-member-id]");
            if (!container) return;
            const memberId = btn.dataset.saveMemberColor;
            const colorMode = container.querySelector("[data-member-color-mode]")?.value || "deterministic";
            const colorHex = container.querySelector("[data-member-color]")?.value || null;
            await api(`/v1/settings/team/${encodeURIComponent(memberId)}/appearance`, {
              method: "PATCH",
              body: JSON.stringify({ colorMode, colorHex })
            });
            await loadAll();
            setSettingsTab("team");
          };
        });

        teamList.querySelectorAll("[data-act-as-member]").forEach((btn) => {
          btn.onclick = async () => {
            const memberId = btn.dataset.actAsMember;
            const selected = appState.team.find((member) => member.id === memberId);
            if (!selected || selected.status === "inactive") return;
            appState.currentUserId = selected.id;
            appState.currentUserRole = selected.role;
            appState.currentUserName = selected.name;
            renderSessionUserControls();
            await loadAll();
            setSettingsTab("team");
          };
        });

        const addTeamMemberBtn = document.getElementById("addTeamMemberBtn");
        if (addTeamMemberBtn) {
          addTeamMemberBtn.onclick = async () => {
            await api("/v1/settings/team", {
              method: "POST",
              body: JSON.stringify({
                name: document.getElementById("teamName").value,
                email: document.getElementById("teamEmail").value,
                role: document.getElementById("teamRole").value,
                title: document.getElementById("teamTitle").value
              })
            });
            await loadAll();
            setSettingsTab("team");
            appendMessage("Team member added.");
          };
        }
      }

      function renderSettingsSetup() {
        const checklist = appState.settings?.checklist || {};
        const done = Object.values(checklist).filter(Boolean).length;
        const total = Object.keys(checklist).length || 4;
        const pct = total ? Math.round((done / total) * 100) : 0;
        const box = document.getElementById("settings-setup");
        box.innerHTML = `
          <h3>Setup</h3>
          <div class="subtle">Complete the core setup path for fast adoption.</div>
          <div class="card" style="margin-top:8px">
            <div><strong>Progress: ${done}/${total}</strong></div>
            <div class="progress-track" style="margin-top:6px"><div class="progress-fill" style="width:${pct}%"></div></div>
            <div class="list" style="margin-top:8px">
              <div class="item">1. Data Integrations: ${checklist.connectionsConfigured ? "Done" : "Pending"}</div>
              <div class="item">2. Model Profile: ${checklist.modelProfileConfigured ? "Done" : "Pending"}</div>
              <div class="item">3. Report Type: ${checklist.reportTypeConfigured ? "Done" : "Pending"}</div>
              <div class="item">4. Channel Delivery: ${checklist.channelsConfigured ? "Done" : "Pending"}</div>
            </div>
            <div class="toolbar" style="margin-top:8px">
              <button id="setupGoIntegrationsBtn">Integrations</button>
              <button id="setupGoModelsBtn">Models</button>
              <button id="setupGoReportsBtn">Reports</button>
              <button id="setupGoChannelsBtn">Channels</button>
              <button id="setupStarterPackBtn" class="primary">Apply Starter Pack</button>
            </div>
          </div>
        `;
        const setupGoIntegrationsBtn = document.getElementById("setupGoIntegrationsBtn");
        if (setupGoIntegrationsBtn) setupGoIntegrationsBtn.onclick = () => setSettingsTab("integrations");
        const setupGoModelsBtn = document.getElementById("setupGoModelsBtn");
        if (setupGoModelsBtn) setupGoModelsBtn.onclick = () => setSettingsTab("models");
        const setupGoReportsBtn = document.getElementById("setupGoReportsBtn");
        if (setupGoReportsBtn) setupGoReportsBtn.onclick = () => setSettingsTab("reports");
        const setupGoChannelsBtn = document.getElementById("setupGoChannelsBtn");
        if (setupGoChannelsBtn) setupGoChannelsBtn.onclick = () => setSettingsTab("channels");
        const setupStarterPackBtn = document.getElementById("setupStarterPackBtn");
        if (setupStarterPackBtn) setupStarterPackBtn.onclick = applyStarterPack;
      }

      function renderSettingsMcpAgents() {
        const box = document.getElementById("settings-mcp-agents");
        box.innerHTML = `
          <h3>MCP & Agents</h3>
          <div class="subtle">Configure MCP servers and inspect agent/device-command activity.</div>
          <div class="card" style="margin-top:8px">
            <h4>Add MCP Server</h4>
            <div class="form-grid">
              <label>Provider
                <select id="mcpProviderSelect"></select>
              </label>
              <label>Name<input id="mcpServerName" placeholder="Primary Filesystem MCP" /></label>
              <label class="full">Endpoint<input id="mcpServerEndpoint" placeholder="http://localhost:9000/mcp" /></label>
              <label>Auth Ref<input id="mcpAuthRef" placeholder="secret_ref_..." /></label>
              <label class="full">Allowed Folder IDs (comma separated)<input id="mcpAllowedFolders" placeholder="workspace_folder_..." /></label>
              <button id="addMcpServerBtn" class="primary">Add MCP Server</button>
            </div>
          </div>
          <div class="card" style="margin-top:8px">
            <h4>Configured MCP Servers</h4>
            <div class="list" id="mcpServerList"></div>
          </div>
          <div class="card" style="margin-top:8px">
            <h4>Agent Job History</h4>
            <div class="list" id="agentJobList"></div>
          </div>
          <div class="card" style="margin-top:8px">
            <h4>Device Commands</h4>
            <div class="list" id="deviceCommandList"></div>
          </div>
        `;

        fillSelect("mcpProviderSelect", appState.mcpProviders, "provider", "displayName", false);
        const mcpServerList = document.getElementById("mcpServerList");
        mcpServerList.innerHTML = appState.mcpServers.length
          ? appState.mcpServers.map((server) => `
              <div class="item">
                <div><strong>${server.name}</strong> <span class="status mono">${server.provider}</span> ${formatStatus(server.status)}</div>
                <div class="subtle">${server.endpoint || "(no endpoint)"} | folders=${(server.allowedFolderIds || []).length}</div>
                <div class="toolbar" style="margin-top:6px">
                  <button data-test-mcp-server="${server.id}">Test</button>
                </div>
              </div>
            `).join("")
          : `<div class="item">No MCP servers configured</div>`;

        mcpServerList.querySelectorAll("[data-test-mcp-server]").forEach((btn) => {
          btn.onclick = async () => {
            await api(`/v1/settings/mcp/servers/${encodeURIComponent(btn.dataset.testMcpServer)}/test`, { method: "POST" });
            await loadAll();
            setSettingsTab("mcp-agents");
            appendMessage("MCP server test complete.");
          };
        });

        document.getElementById("addMcpServerBtn").onclick = async () => {
          await api("/v1/settings/mcp/servers", {
            method: "POST",
            body: JSON.stringify({
              provider: document.getElementById("mcpProviderSelect").value,
              name: document.getElementById("mcpServerName").value,
              endpoint: document.getElementById("mcpServerEndpoint").value,
              authRef: document.getElementById("mcpAuthRef").value,
              allowedFolderIds: document.getElementById("mcpAllowedFolders").value
                .split(",")
                .map((value) => value.trim())
                .filter(Boolean)
            })
          });
          await loadAll();
          setSettingsTab("mcp-agents");
          appendMessage("MCP server configured.");
        };

        const agentJobList = document.getElementById("agentJobList");
        agentJobList.innerHTML = appState.agentJobs.length
          ? appState.agentJobs.slice(0, 20).map((job) => `
              <div class="item">
                <div><strong>${job.jobType}</strong> ${formatStatus(job.status)}</div>
                <div class="subtle">${job.folderId || "no-folder"} • ${job.threadId || "no-thread"} • ${new Date(job.createdAt).toLocaleString()}</div>
              </div>
            `).join("")
          : `<div class="item">No agent jobs yet</div>`;

        const deviceCommandList = document.getElementById("deviceCommandList");
        deviceCommandList.innerHTML = appState.deviceCommands.length
          ? appState.deviceCommands.slice(0, 20).map((request) => `
              <div class="item">
                <div><strong>${request.command}</strong> ${request.args?.join(" ") || ""} ${formatStatus(request.status)}</div>
                <div class="subtle">${request.policyReason} • ${new Date(request.createdAt).toLocaleString()}</div>
                ${request.output ? `<pre class="mono" style="white-space:pre-wrap">${request.output}</pre>` : ""}
                ${request.error ? `<div class="subtle">${request.error}</div>` : ""}
              </div>
            `).join("")
          : `<div class="item">No device command requests yet</div>`;
      }

      function renderSettingsIntegrations() {
        const box = document.getElementById("settings-integrations");
        box.innerHTML = `
          <h3>Quick Add Integrations</h3>
          <div class="subtle">Connect tools your team already uses in a few clicks.</div>
          <div class="list" id="integrationQuickAddList" style="margin-top:8px"></div>
        `;

        const list = document.getElementById("integrationQuickAddList");
        if (!appState.integrationCatalog.length) {
          list.innerHTML = `<div class="item">No integration presets available</div>`;
          return;
        }

        list.innerHTML = appState.integrationCatalog.map((integration) => {
          if (integration.kind === "source") {
            return `
              <div class="item" data-integration-key="${integration.key}">
                <div><strong>${integration.name}</strong> <span class="status mono">${integration.kind}</span></div>
                <div class="subtle">${integration.description || ""}</div>
                <div class="form-grid" style="margin-top:8px">
                  <label class="full">Credential Ref / Token<input data-int-auth-ref placeholder="secret_ref_or_token" /></label>
                  <label>Initial Sync Days<input data-int-period-days type="number" value="14" min="1" /></label>
                  <label>Run Initial Sync
                    <select data-int-run-sync>
                      <option value="true" selected>true</option>
                      <option value="false">false</option>
                    </select>
                  </label>
                  <button data-int-quick-add="${integration.key}" class="primary">Connect ${integration.name}</button>
                </div>
              </div>
            `;
          }
          if (integration.kind === "channel" && integration.channel === "slack") {
            return `
              <div class="item" data-integration-key="${integration.key}">
                <div><strong>${integration.name}</strong> <span class="status mono">${integration.kind}</span></div>
                <div class="subtle">${integration.description || ""}</div>
                <div class="form-grid" style="margin-top:8px">
                  <label class="full">Slack Webhook Ref<input data-int-slack-webhook placeholder="slack_webhook_ref" /></label>
                  <button data-int-quick-add="${integration.key}" class="primary">Enable Slack</button>
                </div>
              </div>
            `;
          }
          if (integration.kind === "channel" && integration.channel === "telegram") {
            return `
              <div class="item" data-integration-key="${integration.key}">
                <div><strong>${integration.name}</strong> <span class="status mono">${integration.kind}</span></div>
                <div class="subtle">${integration.description || ""}</div>
                <div class="form-grid" style="margin-top:8px">
                  <label>Bot Token Ref<input data-int-telegram-token placeholder="telegram_bot_token_ref" /></label>
                  <label>Chat ID<input data-int-telegram-chat placeholder="123456789" /></label>
                  <button data-int-quick-add="${integration.key}" class="primary">Enable Telegram</button>
                </div>
              </div>
            `;
          }
          if (integration.kind === "mcp") {
            return `
              <div class="item" data-integration-key="${integration.key}">
                <div><strong>${integration.name}</strong> <span class="status mono">${integration.kind}</span></div>
                <div class="subtle">${integration.description || ""}</div>
                <div class="form-grid" style="margin-top:8px">
                  <label class="full">Endpoint<input data-int-mcp-endpoint value="${integration.defaultEndpoint || ""}" placeholder="mcp endpoint" /></label>
                  <label>Auth Ref<input data-int-mcp-auth placeholder="secret_ref" /></label>
                  <label>Folder IDs<input data-int-mcp-folders placeholder="${(appState.folders || []).slice(0, 2).map((f) => f.id).join(",")}" /></label>
                  <button data-int-quick-add="${integration.key}" class="primary">Connect ${integration.name}</button>
                </div>
              </div>
            `;
          }
          return `
            <div class="item" data-integration-key="${integration.key}">
              <div><strong>${integration.name}</strong></div>
              <div class="subtle">${integration.description || ""}</div>
              <button data-int-quick-add="${integration.key}" class="primary" style="margin-top:8px">Quick Add</button>
            </div>
          `;
        }).join("");

        list.querySelectorAll("[data-int-quick-add]").forEach((btn) => {
          btn.onclick = async () => {
            const integrationKey = btn.dataset.intQuickAdd;
            const container = btn.closest("[data-integration-key]");
            if (!container) return;

            const payload = { integrationKey };
            const authRef = container.querySelector("[data-int-auth-ref]")?.value?.trim();
            if (authRef) payload.authRef = authRef;
            const periodDays = Number(container.querySelector("[data-int-period-days]")?.value ?? 14);
            if (Number.isFinite(periodDays)) payload.periodDays = periodDays;
            const runInitialSync = container.querySelector("[data-int-run-sync]")?.value;
            if (runInitialSync) payload.runInitialSync = runInitialSync === "true";
            const webhookRef = container.querySelector("[data-int-slack-webhook]")?.value?.trim();
            if (webhookRef) payload.webhookRef = webhookRef;
            const botTokenRef = container.querySelector("[data-int-telegram-token]")?.value?.trim();
            if (botTokenRef) payload.botTokenRef = botTokenRef;
            const chatId = container.querySelector("[data-int-telegram-chat]")?.value?.trim();
            if (chatId) payload.chatId = chatId;
            const endpoint = container.querySelector("[data-int-mcp-endpoint]")?.value?.trim();
            if (endpoint) payload.endpoint = endpoint;
            const mcpAuthRef = container.querySelector("[data-int-mcp-auth]")?.value?.trim();
            if (mcpAuthRef) payload.authRef = mcpAuthRef;
            const folderIds = (container.querySelector("[data-int-mcp-folders]")?.value ?? "")
              .split(",")
              .map((value) => value.trim())
              .filter(Boolean);
            if (folderIds.length) payload.allowedFolderIds = folderIds;

            await api("/v1/integrations/quick-add", {
              method: "POST",
              body: JSON.stringify(payload)
            });
            await loadAll();
            setSettingsTab("integrations");
            appendMessage(`Integration connected: ${integrationKey}`);
          };
        });
      }

      function renderSettingsConnections() {
        const box = document.getElementById("settings-connections");
        box.innerHTML = `
          <h3>Connections</h3>
          <div class="form-grid">
            <label>Source Type
              <select id="connectionType"></select>
            </label>
            <label>Mode
              <select id="connectionMode">
                <option value="hybrid">hybrid</option>
                <option value="ingest">ingest</option>
                <option value="live">live</option>
              </select>
            </label>
            <label>Owner<input id="connectionOwner" value="data-team" /></label>
            <label>Freshness SLA (hours)<input id="connectionSlaHours" value="24" type="number" min="1" /></label>
            <label>Min Quality Score<input id="connectionMinQuality" value="0.75" type="number" min="0" max="1" step="0.01" /></label>
            <label>Block Run On Low Quality
              <select id="connectionBlockLowQuality">
                <option value="false" selected>false</option>
                <option value="true">true</option>
              </select>
            </label>
            <label class="full">Quality Checks (comma separated)<input id="connectionQualityChecks" value="null_check,duplicate_guard,spike_check" /></label>
            <label class="full">Credential Token<input id="connectionToken" placeholder="token or key ref" /></label>
            <button id="addConnection" class="primary">Add Connection</button>
          </div>
          <div class="list" id="connectionsList"></div>
        `;

        api("/v1/sources/catalog").then((data) => {
          fillSelect("connectionType", data.sources, "sourceType", "sourceType");
        }).catch(() => {});

        document.getElementById("addConnection").onclick = async () => {
          await api("/v1/sources/connections", {
            method: "POST",
            body: JSON.stringify({
              sourceType: document.getElementById("connectionType").value,
              mode: document.getElementById("connectionMode").value,
              auth: { token: document.getElementById("connectionToken").value },
              syncPolicy: {
                intervalMinutes: 60,
                backfillDays: 30,
                freshnessSlaHours: Number(document.getElementById("connectionSlaHours").value)
              },
              qualityPolicy: {
                minQualityScore: Number(document.getElementById("connectionMinQuality").value),
                blockModelRun: document.getElementById("connectionBlockLowQuality").value === "true"
              },
              metadata: {
                owner: document.getElementById("connectionOwner").value,
                qualityChecks: document.getElementById("connectionQualityChecks").value
                  .split(",")
                  .map((s) => s.trim())
                  .filter(Boolean)
              }
            })
          });
          await loadAll();
          appendMessage("Connection created.");
        };

        const list = document.getElementById("connectionsList");
        if (!appState.connections.length) {
          list.innerHTML = `<div class="item">No connections configured</div>`;
        } else {
          list.innerHTML = appState.connections.map((c) => `
            <div class="item" data-connection-id="${c.id}">
              <div><strong>${c.sourceType}</strong> (${c.mode}) ${formatStatus(c.status)}</div>
              <div class="subtle">Owner: ${c.metadata?.owner || "unassigned"} | SLA: ${c.syncPolicy?.freshnessSlaHours ?? 24}h | Min Quality: ${c.qualityPolicy?.minQualityScore ?? 0.75}</div>
              <div class="subtle">Checks: ${(c.metadata?.qualityChecks || []).join(", ") || "none"}</div>
              <div class="form-grid" style="margin-top:8px">
                <label>Owner<input data-conn-owner value="${c.metadata?.owner || ""}" /></label>
                <label>Freshness SLA (hours)<input data-conn-sla value="${c.syncPolicy?.freshnessSlaHours ?? 24}" type="number" min="1" /></label>
                <label>Min Quality Score<input data-conn-quality value="${c.qualityPolicy?.minQualityScore ?? 0.75}" type="number" min="0" max="1" step="0.01" /></label>
                <label>Block Run On Low Quality
                  <select data-conn-block>
                    <option value="false" ${!c.qualityPolicy?.blockModelRun ? "selected" : ""}>false</option>
                    <option value="true" ${c.qualityPolicy?.blockModelRun ? "selected" : ""}>true</option>
                  </select>
                </label>
                <label class="full">Quality Checks<input data-conn-checks value="${(c.metadata?.qualityChecks || []).join(",")}" /></label>
              </div>
              <div class="toolbar" style="margin-top:6px">
                <button data-test-connection="${c.id}">Test</button>
                <button data-sync-connection="${c.id}">Sync</button>
                <button data-save-connection="${c.id}">Save Config</button>
              </div>
            </div>
          `).join("");
        }

        list.querySelectorAll("[data-test-connection]").forEach((btn) => {
          btn.onclick = async () => {
            await api(`/v1/sources/connections/${encodeURIComponent(btn.dataset.testConnection)}/test`, { method: "POST" });
            await loadAll();
            appendMessage("Connection test complete.");
          };
        });

        list.querySelectorAll("[data-sync-connection]").forEach((btn) => {
          btn.onclick = async () => {
            await api(`/v1/sources/connections/${encodeURIComponent(btn.dataset.syncConnection)}/sync`, {
              method: "POST",
              body: JSON.stringify({ periodDays: 30 })
            });
            await loadAll();
            appendMessage("Connection sync complete.");
          };
        });

        list.querySelectorAll("[data-save-connection]").forEach((btn) => {
          btn.onclick = async () => {
            const container = btn.closest("[data-connection-id]");
            if (!container) return;
            const owner = container.querySelector("[data-conn-owner]")?.value ?? "unassigned";
            const freshnessSlaHours = Number(container.querySelector("[data-conn-sla]")?.value ?? 24);
            const minQualityScore = Number(container.querySelector("[data-conn-quality]")?.value ?? 0.75);
            const blockModelRun = (container.querySelector("[data-conn-block]")?.value ?? "false") === "true";
            const qualityChecks = (container.querySelector("[data-conn-checks]")?.value ?? "")
              .split(",")
              .map((s) => s.trim())
              .filter(Boolean);
            await api(`/v1/sources/connections/${encodeURIComponent(btn.dataset.saveConnection)}`, {
              method: "PATCH",
              body: JSON.stringify({
                metadata: { owner, qualityChecks },
                syncPolicy: { freshnessSlaHours },
                qualityPolicy: { minQualityScore, blockModelRun }
              })
            });
            await loadAll();
            appendMessage("Connection config updated.");
          };
        });
      }

      function renderSettingsCredentials() {
        const prefs = appState.settings?.modelPreferences || {};
        const box = document.getElementById("settings-credentials");
        box.innerHTML = `
          <h3>Credentials</h3>
          <div class="form-grid">
            <label>LLM Mode
              <select id="credMode">
                <option value="managed" ${prefs.llmMode === "managed" ? "selected" : ""}>managed</option>
                <option value="byo" ${prefs.llmMode === "byo" ? "selected" : ""}>byo</option>
              </select>
            </label>
            <label>Default Provider<input id="credProvider" value="${prefs.defaultProvider || "managed"}" /></label>
            <label class="full">BYO Key Refs (comma separated)<input id="credRefs" value="${(prefs.byoKeyRefs || []).join(",")}" /></label>
            <button id="saveCredentials" class="primary">Save Credentials</button>
          </div>
        `;
        document.getElementById("saveCredentials").onclick = async () => {
          await api("/v1/settings/model-preferences", {
            method: "PATCH",
            body: JSON.stringify({
              llmMode: document.getElementById("credMode").value,
              defaultProvider: document.getElementById("credProvider").value,
              byoKeyRefs: document.getElementById("credRefs").value.split(",").map((s) => s.trim()).filter(Boolean)
            })
          });
          await loadAll();
          appendMessage("Credential preferences saved.");
        };
      }

      function renderSettingsModels() {
        const box = document.getElementById("settings-models");
        box.innerHTML = `
          <h3>Models</h3>
          <div class="form-grid">
            <label>Name<input id="profileName" value="Custom Forecast" /></label>
            <label>Objective
              <select id="profileObjective">
                <option value="forecast">forecast</option>
                <option value="anomaly">anomaly</option>
                <option value="segmentation">segmentation</option>
                <option value="attribution">attribution</option>
              </select>
            </label>
            <label>Target Metric<input id="profileMetric" value="revenue" /></label>
            <label>Horizon Days<input id="profileHorizon" value="14" type="number" /></label>
            <button id="createProfile" class="primary">Create Model Profile</button>
          </div>
          <div class="list" id="profilesList"></div>
        `;

        document.getElementById("createProfile").onclick = async () => {
          await api("/v1/models/profiles", {
            method: "POST",
            body: JSON.stringify({
              name: document.getElementById("profileName").value,
              objective: document.getElementById("profileObjective").value,
              targetMetricId: document.getElementById("profileMetric").value,
              horizonDays: Number(document.getElementById("profileHorizon").value),
              provider: "managed"
            })
          });
          await loadAll();
          appendMessage("Model profile created.");
        };

        const list = document.getElementById("profilesList");
        list.innerHTML = appState.profiles.map((p) => `
          <div class="item">
            <strong>${p.name}</strong> ${p.active ? "<span class='status'>active</span>" : ""}
            <div class="subtle">${p.objective} / ${p.targetMetricId} / ${p.horizonDays}d</div>
            <div class="toolbar" style="margin-top:6px"><button data-activate-profile="${p.id}">Activate</button></div>
          </div>
        `).join("");

        list.querySelectorAll("[data-activate-profile]").forEach((btn) => {
          btn.onclick = async () => {
            await api(`/v1/models/profiles/${encodeURIComponent(btn.dataset.activateProfile)}/activate`, { method: "POST" });
            await loadAll();
            appendMessage("Model profile activated.");
          };
        });
      }

      function renderSettingsTraining() {
        const training = appState.settings?.training || {};
        const box = document.getElementById("settings-training");
        box.innerHTML = `
          <h3>Training</h3>
          <div class="form-grid">
            <label>Opt-in
              <select id="trainingOptIn">
                <option value="true" ${training.optIn ? "selected" : ""}>true</option>
                <option value="false" ${!training.optIn ? "selected" : ""}>false</option>
              </select>
            </label>
            <label>Allow Tenant Fine-Tuning
              <select id="trainingFineTune">
                <option value="true" ${training.allowTenantFineTuning ? "selected" : ""}>true</option>
                <option value="false" ${!training.allowTenantFineTuning ? "selected" : ""}>false</option>
              </select>
            </label>
            <label>Schedule (hours)<input id="trainingInterval" value="${training.schedule?.intervalHours || 24}" type="number" /></label>
            <button id="saveTraining" class="primary">Save Training</button>
          </div>
        `;

        document.getElementById("saveTraining").onclick = async () => {
          await api("/v1/settings/training", {
            method: "PATCH",
            body: JSON.stringify({
              optIn: document.getElementById("trainingOptIn").value === "true",
              allowTenantFineTuning: document.getElementById("trainingFineTune").value === "true",
              schedule: { intervalHours: Number(document.getElementById("trainingInterval").value) }
            })
          });
          await loadAll();
          appendMessage("Training settings saved.");
        };
      }

      function renderSettingsReports() {
        const box = document.getElementById("settings-reports");
        box.innerHTML = `
          <h3>Report Types</h3>
          <div class="toolbar">
            <button id="installFounderReportType" type="button">Add Founder Mode Template</button>
          </div>
          <div class="form-grid">
            <label>Name<input id="reportTypeName" value="Client Digest" /></label>
            <label>Format
              <select id="reportTypeFormat">
                <option value="pdf">pdf</option>
                <option value="html">html</option>
              </select>
            </label>
            <label class="full">Sections (comma separated)<input id="reportTypeSections" value="kpi_snapshot,trend_chart,narrative,actions" /></label>
            <label class="full">Channels (comma separated)<input id="reportTypeChannels" value="email,slack" /></label>
            <label class="full">Email Template<textarea id="reportTemplateEmail">[{{channel}}] {{reportTitle}}\n{{reportSummary}}\nRun={{runId}}</textarea></label>
            <label class="full">Slack Template<textarea id="reportTemplateSlack">[{{channel}}] {{reportTitle}} | {{reportSummary}} | confidence={{confidence}}</textarea></label>
            <label class="full">Telegram Template<textarea id="reportTemplateTelegram">[{{channel}}] {{reportTitle}} | {{reportSummary}}</textarea></label>
            <button id="createReportType" class="primary">Create Report Type</button>
          </div>
          <div class="list" id="reportTypeList"></div>
          <div class="card" id="reportPreviewBox"><h4>Preview</h4><pre class="mono" id="reportPreview" style="white-space:pre-wrap"></pre></div>
        `;

        document.getElementById("installFounderReportType").onclick = async () => {
          const exists = appState.reportTypes.some((item) => item.name === "Founder Growth and Cash Cockpit");
          if (exists) {
            appendMessage("Founder-mode template already exists.");
            return;
          }
          await api("/v1/reports/types", {
            method: "POST",
            body: JSON.stringify({
              name: "Founder Growth and Cash Cockpit",
              defaultFormat: "html",
              sections: ["kpi_snapshot", "trend_chart", "narrative", "actions", "appendix"],
              defaultChannels: ["slack", "email"],
              schedule: { intervalMinutes: 1440 },
              deliveryTemplates: {
                email: "[{{channel}}] {{reportTitle}}\n{{reportSummary}}\nRun={{runId}}",
                slack: "[{{channel}}] {{reportTitle}} | {{reportSummary}} | confidence={{confidence}} | actions={{actionsCount}}",
                telegram: "[{{channel}}] {{reportTitle}} | {{reportSummary}}"
              }
            })
          });
          await loadAll();
          appendMessage("Founder-mode report template installed.");
        };

        document.getElementById("createReportType").onclick = async () => {
          await api("/v1/reports/types", {
            method: "POST",
            body: JSON.stringify({
              name: document.getElementById("reportTypeName").value,
              defaultFormat: document.getElementById("reportTypeFormat").value,
              sections: document.getElementById("reportTypeSections").value.split(",").map((s) => s.trim()).filter(Boolean),
              defaultChannels: document.getElementById("reportTypeChannels").value.split(",").map((s) => s.trim()).filter(Boolean),
              deliveryTemplates: {
                email: document.getElementById("reportTemplateEmail").value,
                slack: document.getElementById("reportTemplateSlack").value,
                telegram: document.getElementById("reportTemplateTelegram").value
              }
            })
          });
          await loadAll();
          appendMessage("Report type created.");
        };

        const list = document.getElementById("reportTypeList");
        list.innerHTML = appState.reportTypes.map((t) => `
          <div class="item" data-report-type-id="${t.id}">
            <strong>${t.name}</strong>
            <div class="subtle">${t.defaultFormat} | ${t.sections.join(" / ")}</div>
            <div class="form-grid" style="margin-top:8px">
              <label class="full">Email Template<textarea data-report-template-email>${t.deliveryTemplates?.email || ""}</textarea></label>
              <label class="full">Slack Template<textarea data-report-template-slack>${t.deliveryTemplates?.slack || ""}</textarea></label>
              <label class="full">Telegram Template<textarea data-report-template-telegram>${t.deliveryTemplates?.telegram || ""}</textarea></label>
            </div>
            <div class="toolbar" style="margin-top:6px">
              <button data-preview-report-type="${t.id}">Preview</button>
              <button data-save-report-templates="${t.id}">Save Templates</button>
            </div>
          </div>
        `).join("");

        list.querySelectorAll("[data-preview-report-type]").forEach((btn) => {
          btn.onclick = async () => {
            const response = await api(`/v1/reports/types/${encodeURIComponent(btn.dataset.previewReportType)}/preview`, { method: "POST" });
            document.getElementById("reportPreview").textContent = response.preview;
          };
        });

        list.querySelectorAll("[data-save-report-templates]").forEach((btn) => {
          btn.onclick = async () => {
            const container = btn.closest("[data-report-type-id]");
            if (!container) return;
            await api(`/v1/reports/types/${encodeURIComponent(btn.dataset.saveReportTemplates)}`, {
              method: "PATCH",
              body: JSON.stringify({
                deliveryTemplates: {
                  email: container.querySelector("[data-report-template-email]")?.value ?? "",
                  slack: container.querySelector("[data-report-template-slack]")?.value ?? "",
                  telegram: container.querySelector("[data-report-template-telegram]")?.value ?? ""
                }
              })
            });
            await loadAll();
            appendMessage("Report templates updated.");
          };
        });
      }

      function renderSettingsSkills() {
        const box = document.getElementById("settings-skills");
        box.innerHTML = `
          <h3>Skills</h3>
          <div class="card">
            <h4>Installed Skills</h4>
            <div class="list" id="installedSkillsList"></div>
          </div>
          <div class="card">
            <h4>Built-in Processing Tools</h4>
            <div class="list" id="skillToolCatalogList"></div>
          </div>
          <div class="card">
            <h4>Guided Skill Wizard</h4>
            <div class="form-grid">
              <label>Name<input id="skillDraftName" value="Custom Ops Skill" /></label>
              <label>Version<input id="skillDraftVersion" value="1.0.0" /></label>
              <label class="full">Intent (single)<input id="skillDraftIntent" value="ops_followup" /></label>
              <label class="full">Channels (comma separated)<input id="skillDraftChannels" value="web,slack,api" /></label>
              <label class="full">Tools (comma separated)<input id="skillDraftTools" value="compute.data_quality_snapshot,model.run,reports.generate" /></label>
              <label class="full">System Prompt<textarea id="skillDraftPrompt">Prioritize concise, actionable operating recommendations.</textarea></label>
              <button id="createSkillDraftBtn" class="primary">Create Draft</button>
            </div>
            <div class="toolbar" style="margin-top:8px">
              <button id="validateDraftBtn">Validate Latest Draft</button>
              <button id="publishDraftBtn">Publish Latest Draft</button>
            </div>
            <div class="list" id="skillDraftList" style="margin-top:8px"></div>
          </div>
          <div class="card">
            <h4>Skill Testing Sandbox</h4>
            <div class="form-grid">
              <label>Skill
                <select id="skillSandboxSkill"></select>
              </label>
              <label>Channel
                <select id="skillSandboxChannel">
                  <option value="web">web</option>
                  <option value="slack">slack</option>
                  <option value="telegram">telegram</option>
                  <option value="api">api</option>
                </select>
              </label>
              <label class="full">Intent<input id="skillSandboxIntent" value="analysis_run" /></label>
              <label class="full">Requested Tools (comma separated)<input id="skillSandboxTools" value="compute.data_quality_snapshot,model.run" /></label>
              <label>Estimated Tokens<input id="skillSandboxTokens" type="number" value="900" min="0" /></label>
              <label>Timeout (ms)<input id="skillSandboxTimeout" type="number" value="2500" min="1" /></label>
              <label>Generate Report
                <select id="skillSandboxGenerateReport">
                  <option value="false" selected>false</option>
                  <option value="true">true</option>
                </select>
              </label>
              <button id="runSkillSandboxBtn" class="primary">Run Sandbox Test</button>
            </div>
            <pre class="mono" id="skillSandboxTrace" style="white-space:pre-wrap; margin-top:8px">Run a sandbox test to view routing, tools, and guardrail trace.</pre>
          </div>
        `;

        const installedList = document.getElementById("installedSkillsList");
        installedList.innerHTML = appState.skillsInstalled.length
          ? appState.skillsInstalled.map((s) => `
              <div class="item" data-installed-skill-id="${s.id}">
                <div><strong>${s.id}</strong> ${s.active ? "<span class='status'>active</span>" : ""}</div>
                <div class="subtle">${s.manifest?.description || ""}</div>
                <div class="form-grid" style="margin-top:8px">
                  <label class="full">System Prompt<textarea data-skill-prompt>${s.manifest?.prompts?.system || ""}</textarea></label>
                  <label>Confidence Min<input data-skill-confidence type="number" min="0" max="1" step="0.01" value="${s.manifest?.guardrails?.confidenceMin ?? 0.7}" /></label>
                  <label>Token Budget<input data-skill-token type="number" min="1" value="${s.manifest?.guardrails?.tokenBudget ?? 2500}" /></label>
                  <label class="full">Allowed Tools (comma separated)<input data-skill-tools value="${(s.manifest?.tools || []).filter((t) => t.allow).map((t) => t.id).join(",")}" /></label>
                </div>
                <div class="toolbar" style="margin-top:6px">
                  <button data-activate-skill="${s.id}">Activate</button>
                  <button data-deactivate-skill="${s.id}">Deactivate</button>
                  <button data-save-skill="${s.id}">Save</button>
                </div>
              </div>
            `).join("")
          : `<div class="item">No installed skills</div>`;

        const skillToolCatalogList = document.getElementById("skillToolCatalogList");
        skillToolCatalogList.innerHTML = appState.skillTools.length
          ? appState.skillTools.map((tool) => `
              <div class="item">
                <div><strong>${tool.id}</strong> <span class="subtle">(${tool.domain})</span></div>
                <div class="subtle">${tool.description}</div>
              </div>
            `).join("")
          : `<div class="item">No tool catalog loaded</div>`;

        installedList.querySelectorAll("[data-activate-skill]").forEach((btn) => {
          btn.onclick = async () => {
            await api(`/v1/skills/${encodeURIComponent(btn.dataset.activateSkill)}/activate`, { method: "POST" });
            await loadAll();
            appendMessage("Skill activated.");
          };
        });

        installedList.querySelectorAll("[data-deactivate-skill]").forEach((btn) => {
          btn.onclick = async () => {
            await api(`/v1/skills/${encodeURIComponent(btn.dataset.deactivateSkill)}/deactivate`, { method: "POST" });
            await loadAll();
            appendMessage("Skill deactivated.");
          };
        });

        installedList.querySelectorAll("[data-save-skill]").forEach((btn) => {
          btn.onclick = async () => {
            const container = btn.closest("[data-installed-skill-id]");
            if (!container) return;
            const toolIds = (container.querySelector("[data-skill-tools]")?.value ?? "")
              .split(",")
              .map((value) => value.trim())
              .filter(Boolean);
            await api(`/v1/skills/installed/${encodeURIComponent(btn.dataset.saveSkill)}`, {
              method: "PATCH",
              body: JSON.stringify({
                manifest: {
                  prompts: {
                    system: container.querySelector("[data-skill-prompt]")?.value ?? ""
                  },
                  guardrails: {
                    confidenceMin: Number(container.querySelector("[data-skill-confidence]")?.value ?? 0.7),
                    tokenBudget: Number(container.querySelector("[data-skill-token]")?.value ?? 2500)
                  },
                  tools: toolIds.map((id) => ({ id, allow: true }))
                }
              })
            });
            await loadAll();
            appendMessage("Skill configuration saved.");
          };
        });

        document.getElementById("createSkillDraftBtn").onclick = async () => {
          const draft = await api("/v1/skills/drafts", {
            method: "POST",
            body: JSON.stringify({
              manifest: {
                id: document.getElementById("skillDraftName").value.toLowerCase().replace(/\s+/g, "-"),
                version: document.getElementById("skillDraftVersion").value,
                name: document.getElementById("skillDraftName").value,
                description: "Tenant guided skill",
                triggers: {
                  intents: [document.getElementById("skillDraftIntent").value],
                  channels: document.getElementById("skillDraftChannels").value.split(",").map((s) => s.trim()).filter(Boolean)
                },
                tools: document.getElementById("skillDraftTools").value
                  .split(",")
                  .map((s) => s.trim())
                  .filter(Boolean)
                  .map((id) => ({ id, allow: true })),
                guardrails: {
                  confidenceMin: 0.7,
                  humanApprovalFor: ["adjust_budget"],
                  budgetCapUsd: 10000,
                  tokenBudget: 2500,
                  timeBudgetMs: 8000,
                  killSwitch: false
                },
                prompts: { system: document.getElementById("skillDraftPrompt").value },
                schedules: []
              }
            })
          });
          appState.lastDraftId = draft.draft.draftId;
          await loadAll();
          appendMessage("Skill draft created.");
        };

        document.getElementById("validateDraftBtn").onclick = async () => {
          if (!appState.lastDraftId) {
            appendMessage("Create a draft first.", "ai");
            return;
          }
          await api(`/v1/skills/drafts/${encodeURIComponent(appState.lastDraftId)}/validate`, { method: "POST" });
          await loadAll();
          appendMessage("Draft validation complete.");
        };

        document.getElementById("publishDraftBtn").onclick = async () => {
          if (!appState.lastDraftId) {
            appendMessage("Create a draft first.", "ai");
            return;
          }
          await api(`/v1/skills/drafts/${encodeURIComponent(appState.lastDraftId)}/publish`, {
            method: "POST",
            body: JSON.stringify({ active: true })
          });
          await loadAll();
          appendMessage("Draft published and installed.");
        };

        const draftList = document.getElementById("skillDraftList");
        draftList.innerHTML = appState.skillDrafts.length
          ? appState.skillDrafts.slice().reverse().map((d) => `<div class="item"><div>${d.manifest?.name || d.draftId}</div><div>${formatStatus(d.status)}</div></div>`).join("")
          : `<div class="item">No drafts yet</div>`;

        const sandboxSelect = document.getElementById("skillSandboxSkill");
        if (appState.skillsInstalled.length) {
          sandboxSelect.innerHTML = appState.skillsInstalled.map((skill) => `
            <option value="${skill.id}" ${skill.active ? "selected" : ""}>${skill.id}</option>
          `).join("");
        } else {
          sandboxSelect.innerHTML = `<option value="">No installed skills</option>`;
        }

        document.getElementById("runSkillSandboxBtn").onclick = async () => {
          const skillId = document.getElementById("skillSandboxSkill").value;
          if (!skillId) {
            appendMessage("Install a skill first to run sandbox tests.");
            return;
          }
          const payload = {
            skillId,
            intent: document.getElementById("skillSandboxIntent").value,
            channel: document.getElementById("skillSandboxChannel").value,
            requestedTools: document.getElementById("skillSandboxTools").value.split(",").map((s) => s.trim()).filter(Boolean),
            estimatedTokens: Number(document.getElementById("skillSandboxTokens").value),
            timeoutMs: Number(document.getElementById("skillSandboxTimeout").value),
            generateReport: document.getElementById("skillSandboxGenerateReport").value === "true"
          };

          try {
            const result = await api("/v1/skills/run", {
              method: "POST",
              body: JSON.stringify(payload)
            });
            document.getElementById("skillSandboxTrace").textContent = JSON.stringify({
              runId: result.run.id,
              status: result.run.status,
              confidence: result.run.confidence,
              warning: result.run.warning ?? null,
              trace: result.run.trace
            }, null, 2);
            await loadAll();
            appendMessage("Skill sandbox test complete.");
          } catch (error) {
            document.getElementById("skillSandboxTrace").textContent = JSON.stringify({
              error: error.message,
              checks: error.payload?.checks ?? null,
              details: error.payload?.details ?? null
            }, null, 2);
            appendMessage(`Skill sandbox failed: ${error.message}`);
          }
        };
      }

      function renderSettingsChannels() {
        const channels = appState.settings?.channels || { slack: {}, telegram: {} };
        const box = document.getElementById("settings-channels");
        box.innerHTML = `
          <h3>Channels</h3>
          <div class="form-grid">
            <label>Slack Enabled
              <select id="channelSlackEnabled">
                <option value="true" ${channels.slack?.enabled ? "selected" : ""}>true</option>
                <option value="false" ${!channels.slack?.enabled ? "selected" : ""}>false</option>
              </select>
            </label>
            <label>Slack Webhook Ref<input id="channelSlackRef" value="${channels.slack?.webhookRef || ""}" /></label>
            <label>Telegram Enabled
              <select id="channelTelegramEnabled">
                <option value="true" ${channels.telegram?.enabled ? "selected" : ""}>true</option>
                <option value="false" ${!channels.telegram?.enabled ? "selected" : ""}>false</option>
              </select>
            </label>
            <label>Telegram Bot Token Ref<input id="channelTelegramRef" value="${channels.telegram?.botTokenRef || ""}" /></label>
            <label class="full">Telegram Chat ID<input id="channelTelegramChat" value="${channels.telegram?.chatId || ""}" /></label>
            <button id="saveChannels" class="primary">Save Channels</button>
          </div>
        `;
        document.getElementById("saveChannels").onclick = async () => {
          await api("/v1/settings/channels", {
            method: "PATCH",
            body: JSON.stringify({
              slack: {
                enabled: document.getElementById("channelSlackEnabled").value === "true",
                webhookRef: document.getElementById("channelSlackRef").value
              },
              telegram: {
                enabled: document.getElementById("channelTelegramEnabled").value === "true",
                botTokenRef: document.getElementById("channelTelegramRef").value,
                chatId: document.getElementById("channelTelegramChat").value
              }
            })
          });
          await loadAll();
          appendMessage("Channel settings updated.");
        };
      }

      function renderSettingsPolicies() {
        const policies = appState.settings?.policies || {};
        const box = document.getElementById("settings-policies");
        box.innerHTML = `
          <h3>Policies</h3>
          <div class="form-grid">
            <label>Autonomy Mode
              <select id="policyMode">
                <option value="manual" ${policies.autonomyMode === "manual" ? "selected" : ""}>manual</option>
                <option value="policy-gated" ${policies.autonomyMode !== "manual" ? "selected" : ""}>policy-gated</option>
              </select>
            </label>
            <label>Confidence Threshold<input id="policyConfidence" value="${policies.confidenceThreshold ?? 0.76}" type="number" step="0.01" min="0" max="1" /></label>
            <label>Budget Guardrail<input id="policyBudget" value="${policies.budgetGuardrailUsd ?? 10000}" type="number" /></label>
            <label>Kill Switch
              <select id="policyKillSwitch">
                <option value="true" ${policies.killSwitch ? "selected" : ""}>true</option>
                <option value="false" ${!policies.killSwitch ? "selected" : ""}>false</option>
              </select>
            </label>
            <button id="savePolicies" class="primary">Save Policies</button>
          </div>
        `;

        document.getElementById("savePolicies").onclick = async () => {
          await api("/v1/settings/policies", {
            method: "PATCH",
            body: JSON.stringify({
              autonomyMode: document.getElementById("policyMode").value,
              confidenceThreshold: Number(document.getElementById("policyConfidence").value),
              budgetGuardrailUsd: Number(document.getElementById("policyBudget").value),
              killSwitch: document.getElementById("policyKillSwitch").value === "true"
            })
          });
          await loadAll();
          appendMessage("Policies updated.");
        };
      }

      async function renderSettings() {
        renderSettingsSetup();
        renderSettingsGeneral();
        renderSettingsTeam();
        renderSettingsMcpAgents();
        renderSettingsIntegrations();
        renderSettingsConnections();
        renderSettingsCredentials();
        renderSettingsModels();
        renderSettingsTraining();
        renderSettingsReports();
        renderSettingsSkills();
        renderSettingsChannels();
        renderSettingsPolicies();
      }

      function setSettingsTab(tab) {
        appState.settingsTab = tab;
        document.querySelectorAll("[data-settings-tab]").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.settingsTab === tab);
        });
        document.querySelectorAll(".settings-section").forEach((section) => {
          section.classList.toggle("active", section.id === `settings-${tab}`);
        });
      }

      function setContextTab(tab) {
        appState.contextTab = tab;
        document.querySelectorAll("[data-context-tab]").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.contextTab === tab);
        });
        renderContextPanel();
      }

      async function refreshMetrics() {
        const metrics = {};
        for (const id of ["revenue", "profit", "spend"]) {
          try {
            const data = await api(`/v1/metrics/query?metricId=${id}&grain=week`, { method: "GET" });
            metrics[id] = data.summary?.total || 0;
          } catch {
            metrics[id] = 0;
          }
        }
        appState.metrics = metrics;
      }

      async function refreshSourceRunHistory() {
        const connectionIds = [...new Set(
          appState.runs
            .map((run) => run.sourceConnectionId)
            .filter(Boolean)
        )];
        const entries = await Promise.all(connectionIds.map(async (connectionId) => {
          try {
            const result = await api(`/v1/sources/connections/${encodeURIComponent(connectionId)}/runs`);
            const runs = (result.runs || []).slice().sort((a, b) => (a.createdAt < b.createdAt ? 1 : -1));
            return [connectionId, runs];
          } catch {
            return [connectionId, []];
          }
        }));
        appState.sourceRunHistoryByConnection = Object.fromEntries(entries);
      }

      async function refreshThreadMessages() {
        const threadId = appState.activeThreadId;
        if (!threadId) {
          appState.messagesByThread = {};
          appState.repliesByMessage = {};
          appState.threadAttachmentsByThread = {};
          return;
        }
        try {
          const result = await api(`/v1/workspace/chat/threads/${encodeURIComponent(threadId)}/messages`);
          const messages = result.messages || [];
          appState.messagesByThread[threadId] = messages;
          const replyEntries = await Promise.all(messages.map(async (message) => {
            const replies = await api(`/v1/workspace/chat/threads/${encodeURIComponent(threadId)}/messages/${encodeURIComponent(message.id)}/replies`)
              .then((payload) => payload.replies || [])
              .catch(() => []);
            return [message.id, replies];
          }));
          appState.repliesByMessage = Object.fromEntries(replyEntries);
          const attachments = await api(`/v1/workspace/chat/threads/${encodeURIComponent(threadId)}/attachments`)
            .then((payload) => payload.attachments || [])
            .catch(() => []);
          appState.threadAttachmentsByThread[threadId] = attachments;
        } catch {
          appState.messagesByThread[threadId] = [];
          appState.repliesByMessage = {};
          appState.threadAttachmentsByThread[threadId] = [];
        }
      }

      async function refreshFolderAutomations() {
        if (!appState.activeFolderId) {
          appState.folderAutomations = [];
          return;
        }
        const response = await api(`/v1/automations/folders/${encodeURIComponent(appState.activeFolderId)}`)
          .catch(() => ({ automations: [] }));
        appState.folderAutomations = response.automations || [];
      }

      async function refreshRunArtifacts() {
        const run = currentRun();
        if (!run) return;

        if (run.artifacts?.insightId && !appState.insightById[run.artifacts.insightId]) {
          try {
            const result = await api(`/v1/insights/${encodeURIComponent(run.artifacts.insightId)}`);
            appState.insightById[run.artifacts.insightId] = result.insight;
          } catch {
            // Keep UI functional even if artifact lookup is unavailable.
          }
        }

        if (run.artifacts?.reportId && !appState.reportById[run.artifacts.reportId]) {
          try {
            const result = await api(`/v1/reports/${encodeURIComponent(run.artifacts.reportId)}`);
            appState.reportById[run.artifacts.reportId] = result.report;
          } catch {
            // Keep UI functional even if artifact lookup is unavailable.
          }
        }
      }

      async function loadAll() {
        if (!appState.tenantId) return;
        let settingsRes;
        let connRes;
        let profilesRes;
        let reportTypeRes;
        let skillsRes;
        let draftsRes;
        let runsRes;
        let insightRes;
        let actionsRes;
        let channelEventsRes;
        let teamRes;
        let foldersRes;
        let threadsRes;
        let skillToolsRes;
        let mcpCatalogRes;
        let mcpServersRes;
        let agentJobsRes;
        let deviceCommandsRes;
        let integrationsCatalogRes;
        let notificationsRes;
        let workspaceAgentRes;
        try {
          [settingsRes, connRes, profilesRes, reportTypeRes, skillsRes, draftsRes, runsRes, insightRes, actionsRes, channelEventsRes, teamRes, foldersRes, threadsRes, skillToolsRes, mcpCatalogRes, mcpServersRes, agentJobsRes, deviceCommandsRes, integrationsCatalogRes, notificationsRes, workspaceAgentRes] = await Promise.all([
            api("/v1/settings"),
            api("/v1/sources/connections"),
            api("/v1/models/profiles"),
            api("/v1/reports/types"),
            api("/v1/skills/installed"),
            api("/v1/skills/drafts").catch(() => ({ drafts: [] })),
            api("/v1/analysis-runs"),
            api("/v1/insights/latest"),
            api("/v1/agents/actions/pending"),
            api("/v1/channels/events"),
            api("/v1/settings/team").catch(() => ({ team: [] })),
            api("/v1/workspace/folders").catch(() => ({ folders: [] })),
            api("/v1/workspace/threads").catch(() => ({ threads: [] })),
            api("/v1/skills/tools").catch(() => ({ tools: [] })),
            api("/v1/settings/mcp/catalog").catch(() => ({ providers: [] })),
            api("/v1/settings/mcp/servers").catch(() => ({ servers: [] })),
            api("/v1/agents/jobs").catch(() => ({ jobs: [] })),
            api("/v1/agents/device-commands").catch(() => ({ requests: [] })),
            api("/v1/integrations/catalog").catch(() => ({ integrations: [] })),
            api("/v1/workspace/notifications").catch(() => ({ notifications: [] })),
            api("/v1/settings/workspace-agent").catch(() => ({ profile: null }))
          ]);
          setSystemAlert("");
        } catch (error) {
          if (/No route for GET \/v1\/settings/i.test(error.message)) {
            setSystemAlert("Backend/API mismatch detected. Restart the local server on latest main. Expected settings routes are missing.");
          } else {
            setSystemAlert(`Load error: ${error.message}`);
          }
          throw error;
        }

        appState.settings = settingsRes.settings;
        appState.connections = connRes.connections || [];
        appState.profiles = profilesRes.profiles || [];
        appState.reportTypes = reportTypeRes.types || [];
        appState.skillsInstalled = skillsRes.installed || [];
        appState.skillTools = skillToolsRes.tools || [];
        appState.skillDrafts = draftsRes.drafts || [];
        appState.runs = runsRes.runs || [];
        appState.latestInsight = insightRes.insight;
        appState.pendingActions = actionsRes.actions || [];
        appState.channelEvents = channelEventsRes.events || [];
        appState.team = teamRes.team || [];
        appState.teamAppearanceByMember = Object.fromEntries((teamRes.appearance || []).map((item) => [item.memberId, item]));
        appState.folders = foldersRes.folders || [];
        appState.threads = threadsRes.threads || [];
        appState.mcpProviders = mcpCatalogRes.providers || [];
        appState.mcpServers = mcpServersRes.servers || [];
        appState.agentJobs = agentJobsRes.jobs || [];
        appState.deviceCommands = deviceCommandsRes.requests || [];
        appState.integrationCatalog = integrationsCatalogRes.integrations || [];
        appState.notifications = notificationsRes.notifications || [];
        appState.workspaceAgentProfile = workspaceAgentRes.profile || null;
        renderSessionUserControls();
        renderTenantLabel();

        const checklist = appState.settings?.checklist || {};

        if (!appState.activeFolderId || !appState.folders.some((item) => item.id === appState.activeFolderId)) {
          appState.activeFolderId = appState.folders[0]?.id || null;
        }
        const folderThreads = appState.threads.filter((item) => item.folderId === appState.activeFolderId);
        if (!appState.activeThreadId || !folderThreads.some((item) => item.id === appState.activeThreadId)) {
          appState.activeThreadId = folderThreads[0]?.id || null;
        }

        if (!appState.activeRunId && appState.runs.length) {
          appState.activeRunId = appState.runs[appState.runs.length - 1].id;
        }

        await refreshMetrics();
        await refreshSourceRunHistory();
        await refreshThreadMessages();
        await refreshFolderAutomations();
        await refreshRunArtifacts();

        renderOnboarding();
        renderRunBuilder();
        renderRunPreviews();
        renderKPIs();
        renderFolderList();
        renderRunContextList();
        renderThreadList();
        renderSharedThread();
        renderSidebarSkills();
        renderSidebarAutomations();
        renderAttachmentTray();
        renderChatQuickActions();
        renderRightRail();
        renderRunList();
        renderRunDetail();
        renderContextPanel();
        renderDataContextStrip();
        renderSettings();
        applyWorkspaceLayout();
      }

      async function initTenant() {
        const tenants = await api("/v1/tenants");
        if (!appState.tenantId && tenants.tenants?.length) {
          appState.tenantId = tenants.tenants[0].id;
        }
        if (!appState.tenantId) {
          const created = await fetch("/v1/tenants", {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify({ name: "Demo Tenant" })
          }).then((r) => r.json());
          appState.tenantId = created.tenant.id;
        }
        renderTenantLabel();
      }

      async function createDraftRunFromBuilder() {
        const run = await api("/v1/analysis-runs", {
          method: "POST",
          body: JSON.stringify({
            sourceConnectionId: document.getElementById("runSourceSelect").value || null,
            modelProfileId: document.getElementById("runModelSelect").value || null,
            reportTypeId: document.getElementById("runReportSelect").value || null,
            skillId: document.getElementById("runSkillSelect").value || null,
            channels: document.getElementById("runChannelsInput").value.split(",").map((s) => s.trim()).filter(Boolean)
          })
        });
        appState.activeRunId = run.run.id;
        await loadAll();
        await previewCurrentRunOutput();
        appendMessage(`Draft analysis run created: ${run.run.id}`);
      }

      async function executeCurrentRun() {
        if (!appState.activeRunId) {
          await createDraftRunFromBuilder();
        }
        const runId = appState.activeRunId;
        const runRes = await api(`/v1/analysis-runs/${encodeURIComponent(runId)}/execute`, { method: "POST", body: JSON.stringify({ forceSync: true }) });
        appState.activeRunId = runRes.run.id;
        await loadAll();
        await previewCurrentRunOutput();
        appendMessage(`Analysis run ${runRes.run.id} ${runRes.run.status}.`);
      }

      async function deliverCurrentRun() {
        const run = currentRun();
        if (!run) {
          appendMessage("Create or select a run before delivery.");
          return;
        }
        const channels = document.getElementById("runChannelsInput").value.split(",").map((s) => s.trim()).filter(Boolean);
        await api(`/v1/analysis-runs/${encodeURIComponent(run.id)}/deliver`, {
          method: "POST",
          body: JSON.stringify({ channels })
        });
        await loadAll();
        await previewCurrentRunOutput();
        appendMessage(`Run ${run.id} delivered to ${channels.join(", ")}.`);
      }

      async function retryDeliveryEvent(eventId) {
        const run = currentRun();
        if (!run) return;
        const reportType = appState.reportTypes.find((item) => item.id === run.reportTypeId) || null;
        const insight = run?.artifacts?.insightId ? appState.insightById[run.artifacts.insightId] : appState.latestInsight;
        await api(`/v1/channels/events/${encodeURIComponent(eventId)}/retry`, {
          method: "POST",
          body: JSON.stringify({
            templates: reportType?.deliveryTemplates || {},
            context: {
              runId: run.id,
              insightId: insight?.id || "n/a",
              confidence: insight?.confidence ?? null,
              actionsCount: insight?.recommendedActions?.length ?? 0
            }
          })
        });
        await loadAll();
        renderRunDetail();
        appendMessage(`Delivery event ${eventId} retried.`);
      }

      async function postThreadMessage({ threadId, body, parentMessageId = null, visibility = "shared" }) {
        const payload = {
          body,
          parentMessageId,
          visibility,
          authorType: "user",
          authorName: "ui-user",
          attachments: appState.pendingAttachments.map((attachment, idx) => ({
            id: `${Date.now()}_${idx + 1}`,
            name: attachment.name,
            type: attachment.type,
            size: attachment.size
          }))
        };
        const response = await api(`/v1/workspace/chat/threads/${encodeURIComponent(threadId)}/messages`, {
          method: "POST",
          body: JSON.stringify(payload)
        });
        appState.pendingAttachments = [];
        renderAttachmentTray();
        return response.message;
      }

      async function askAiForMessage(messageId, visibility = "shared", responseText = "") {
        const thread = currentThread();
        if (!thread || !messageId) return;
        await api(`/v1/workspace/chat/threads/${encodeURIComponent(thread.id)}/messages/${encodeURIComponent(messageId)}/ai`, {
          method: "POST",
          body: JSON.stringify({
            visibility,
            responseText
          })
        });
        await loadAll();
      }

      async function runChatIntent(promptText, options = {}) {
        const askAi = Boolean(options.askAi);
        const aiVisibility = options.aiVisibility === "private" ? "private" : "shared";
        const modelCommandMatch = promptText.match(/^\/model\s+(.+)$/i);
        if (modelCommandMatch) {
          const query = modelCommandMatch[1].trim().toLowerCase();
          const matched = appState.profiles.find((item) => item.name.toLowerCase().includes(query) || item.id.toLowerCase().includes(query));
          if (!matched) {
            appendMessage(`No model profile matches '${modelCommandMatch[1]}'.`, "ai");
            return;
          }
          const chatModelProfileSelect = document.getElementById("chatModelProfileSelect");
          if (chatModelProfileSelect) chatModelProfileSelect.value = matched.id;
          appendMessage(`Model set to ${matched.name}.`, "ai");
          return;
        }

        const profile = selectedModelProfile();
        if (!profile) {
          appendMessage("No model profile available. Configure one in Settings > Models.");
          return;
        }

        const thread = currentThread();
        if (!thread) {
          appendMessage("Create or select a thread first.");
          return;
        }
        const fullPrompt = String(promptText || "").trim() || "Analyze attached files and screenshots.";
        const userMessage = await postThreadMessage({
          threadId: thread.id,
          body: fullPrompt
        });

        if (askAi) {
          const response = await api("/v1/models/run", {
            method: "POST",
            body: JSON.stringify({
              objective: /anomaly/i.test(promptText) ? "anomaly" : profile.objective,
              outputMetricIds: [profile.targetMetricId],
              horizonDays: profile.horizonDays,
              provider: profile.provider
            })
          });
          await askAiForMessage(userMessage.id, aiVisibility, response.insight.summary);
        } else {
          await loadAll();
        }
      }

      async function replyInMiniThread() {
        const parentMessageId = appState.miniThreadParentMessageId;
        const thread = currentThread();
        const input = document.getElementById("miniThreadReplyInput");
        const body = input?.value?.trim() || "";
        if (!thread || !parentMessageId || !body) return;
        await api(`/v1/workspace/chat/threads/${encodeURIComponent(thread.id)}/messages/${encodeURIComponent(parentMessageId)}/replies`, {
          method: "POST",
          body: JSON.stringify({
            body,
            visibility: "shared",
            authorType: "user",
            authorName: "ui-user"
          })
        });
        if (input) input.value = "";
        await loadAll();
        appState.miniThreadParentMessageId = parentMessageId;
        renderMiniThreadDrawer();
      }

      function openSettingsTab(tab) {
        setRoute("settings");
        setSettingsTab(tab);
      }

      async function runWorkspaceCommand(raw) {
        const command = String(raw || "").trim().toLowerCase();
        if (!command) return;

        if (command === "new run") {
          await createDraftRunFromBuilder();
          return;
        }
        if (command === "new thread") {
          const folderId = appState.activeFolderId || appState.folders[0]?.id;
          if (!folderId) {
            appendMessage("Create a folder first.");
            return;
          }
          await api("/v1/workspace/threads", {
            method: "POST",
            body: JSON.stringify({
              folderId,
              title: "New Workspace Thread"
            })
          });
          await loadAll();
          return;
        }
        if (command === "execute run") {
          await executeCurrentRun();
          return;
        }
        if (command === "deliver run") {
          await deliverCurrentRun();
          return;
        }
        if (command === "open settings connections") {
          openSettingsTab("connections");
          return;
        }
        if (command === "open settings channels") {
          openSettingsTab("channels");
          return;
        }
        if (command === "open settings team") {
          openSettingsTab("team");
          return;
        }
        if (command === "open settings mcp") {
          openSettingsTab("mcp-agents");
          return;
        }
        if (command === "open settings integrations") {
          openSettingsTab("integrations");
          return;
        }
        if (command === "open settings setup") {
          openSettingsTab("setup");
          return;
        }
        if (command === "open settings models") {
          openSettingsTab("models");
          return;
        }
        if (command === "open settings skills") {
          openSettingsTab("skills");
          return;
        }
        appendMessage("Unknown command. Try: new thread | new run | execute run | deliver run | open settings setup/integrations/connections/channels/team/mcp/models/skills");
      }

      function bindEvents() {
        document.querySelectorAll("[data-route-target]").forEach((btn) => {
          btn.onclick = () => setRoute(btn.dataset.routeTarget);
        });
        const sessionUserSelect = document.getElementById("sessionUserSelect");
        if (sessionUserSelect) {
          sessionUserSelect.onchange = async () => {
            const selected = appState.team.find((member) => member.id === sessionUserSelect.value);
            if (!selected) return;
            appState.currentUserId = selected.id;
            appState.currentUserRole = selected.role;
            appState.currentUserName = selected.name;
            renderSessionUserControls();
            renderTenantLabel();
            await loadAll();
          };
        }
        const leftToggle = document.getElementById("toggleLeftRailBtn");
        const rightToggle = document.getElementById("toggleRightRailBtn");
        const focusToggle = document.getElementById("toggleFocusModeBtn");
        if (focusToggle) {
          focusToggle.onclick = () => {
            appState.focusMode = !appState.focusMode;
            applyWorkspaceLayout();
          };
        }
        if (leftToggle) {
          leftToggle.onclick = () => {
            appState.leftRailCollapsed = !appState.leftRailCollapsed;
            applyWorkspaceLayout();
          };
        }
        if (rightToggle) {
          rightToggle.onclick = () => {
            appState.rightRailCollapsed = !appState.rightRailCollapsed;
            applyWorkspaceLayout();
          };
        }

        document.querySelectorAll("[data-settings-tab]").forEach((btn) => {
          btn.onclick = () => setSettingsTab(btn.dataset.settingsTab);
        });

        document.querySelectorAll("[data-context-tab]").forEach((btn) => {
          btn.onclick = () => setContextTab(btn.dataset.contextTab);
        });

        document.getElementById("rightRailTabWorking").onclick = () => setRightRailTab("working");
        document.getElementById("rightRailTabAttachments").onclick = () => setRightRailTab("attachments");
        document.getElementById("rightRailTabNotifications").onclick = () => setRightRailTab("notifications");

        document.getElementById("createRunBtn").onclick = createDraftRunFromBuilder;
        document.getElementById("executeRunBtn").onclick = executeCurrentRun;
        document.getElementById("deliverRunBtn").onclick = deliverCurrentRun;
        document.getElementById("previewRunBtn").onclick = previewCurrentRunOutput;
        document.getElementById("quickNewRunBtn").onclick = createDraftRunFromBuilder;
        document.getElementById("quickExecuteBtn").onclick = executeCurrentRun;
        document.getElementById("quickDeliverBtn").onclick = deliverCurrentRun;
        document.getElementById("quickSettingsBtn").onclick = () => openSettingsTab("setup");
        document.getElementById("chatOpenModelsBtn").onclick = () => openSettingsTab("models");
        document.getElementById("chatOpenChannelsBtn").onclick = () => openSettingsTab("channels");
        document.getElementById("leftNewThreadBtn").onclick = () => {
          document.getElementById("newThreadTitleInput").focus();
        };
        document.getElementById("leftNewSkillBtn").onclick = () => openSettingsTab("skills");
        document.getElementById("leftNewAutomationBtn").onclick = async () => {
          if (!appState.activeFolderId) {
            appendMessage("Select a folder first.");
            return;
          }
          const defaultThreadId = appState.activeThreadId || appState.threads.find((thread) => thread.folderId === appState.activeFolderId)?.id || null;
          await api(`/v1/automations/folders/${encodeURIComponent(appState.activeFolderId)}`, {
            method: "POST",
            body: JSON.stringify({
              name: "Folder Heartbeat",
              triggerType: "heartbeat",
              heartbeatContent: `---
enabled: true
intervalMinutes: 5
targetThreadId: ${defaultThreadId || ""}
triggers:
  - id: stale_data
    when: source_freshness_hours() > 24
    action: run_agent_job
    cooldownMinutes: 30
---
Automation notes.`,
              actionType: "run_agent_job",
              actionPayload: {
                jobType: "cowork_thread",
                input: "Heartbeat trigger fired. Summarize latest blockers."
              },
              targetThreadId: defaultThreadId
            })
          });
          await loadAll();
          appendMessage("Automation created for active folder.");
        };
        document.getElementById("runCoworkAgentBtn").onclick = async () => {
          if (!appState.activeFolderId) {
            appendMessage("Select a folder first.", "ai");
            return;
          }
          const prompt = (document.getElementById("agentCoworkPrompt").value || "").trim() || "Summarize this thread and suggest next steps.";
          await api("/v1/agents/jobs", {
            method: "POST",
            body: JSON.stringify({
              jobType: "cowork_thread",
              folderId: appState.activeFolderId,
              threadId: appState.activeThreadId,
              input: prompt
            })
          });
          await loadAll();
          appendMessage("Agent cowork run completed for active thread.");
        };
        document.getElementById("requestDeviceCommandBtn").onclick = async () => {
          const command = (document.getElementById("deviceCommandInput").value || "").trim();
          const args = (document.getElementById("deviceCommandArgsInput").value || "")
            .split(" ")
            .map((value) => value.trim())
            .filter(Boolean);
          if (!command) {
            appendMessage("Enter a command to request.", "ai");
            return;
          }
          await api("/v1/agents/device-commands", {
            method: "POST",
            body: JSON.stringify({
              folderId: appState.activeFolderId,
              threadId: appState.activeThreadId,
              command,
              args
            })
          });
          document.getElementById("deviceCommandInput").value = "";
          document.getElementById("deviceCommandArgsInput").value = "";
          await loadAll();
          setContextTab("actions");
          appendMessage("Device command request submitted for approval.");
        };

        document.getElementById("newFolderBtn").onclick = async () => {
          const input = document.getElementById("newFolderNameInput");
          const name = input.value.trim();
          if (!name) return;
          await api("/v1/workspace/folders", {
            method: "POST",
            body: JSON.stringify({ name })
          });
          input.value = "";
          await loadAll();
        };
        document.getElementById("newThreadBtn").onclick = async () => {
          const input = document.getElementById("newThreadTitleInput");
          const title = input.value.trim();
          if (!title || !appState.activeFolderId) return;
          await api("/v1/workspace/threads", {
            method: "POST",
            body: JSON.stringify({
              folderId: appState.activeFolderId,
              title
            })
          });
          input.value = "";
          await loadAll();
        };

        document.getElementById("closeMiniThreadBtn").onclick = () => {
          appState.miniThreadParentMessageId = null;
          renderMiniThreadDrawer();
        };
        document.getElementById("miniThreadReplyBtn").onclick = replyInMiniThread;
        document.getElementById("miniThreadReplyInput").addEventListener("keydown", async (event) => {
          if (event.key !== "Enter") return;
          event.preventDefault();
          await replyInMiniThread();
        });

        const attachFilesBtn = document.getElementById("attachFilesBtn");
        const chatFileInput = document.getElementById("chatFileInput");
        if (attachFilesBtn && chatFileInput) {
          attachFilesBtn.onclick = () => chatFileInput.click();
          chatFileInput.onchange = () => {
            const files = Array.from(chatFileInput.files || []);
            if (!files.length) return;
            appState.pendingAttachments.push(...files.map((file) => ({
              name: file.name,
              type: file.type,
              size: file.size
            })));
            chatFileInput.value = "";
            renderAttachmentTray();
          };
        }

        document.getElementById("askAiSharedBtn").onclick = async () => {
          const input = document.getElementById("chatInput");
          const text = input.value.trim();
          if (!text && !appState.pendingAttachments.length) return;
          input.value = "";
          await runChatIntent(text || "Analyze attached files and screenshots.", { askAi: true, aiVisibility: "shared" });
        };
        document.getElementById("askAiPrivateBtn").onclick = async () => {
          const input = document.getElementById("chatInput");
          const text = input.value.trim();
          if (!text && !appState.pendingAttachments.length) return;
          input.value = "";
          await runChatIntent(text || "Analyze attached files and screenshots.", { askAi: true, aiVisibility: "private" });
        };

        ["runSourceSelect", "runModelSelect", "runReportSelect", "runSkillSelect", "runChannelsInput"].forEach((id) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener("change", () => {
            renderDataContextStrip();
            previewCurrentRunOutput().catch((error) => appendMessage(`Preview error: ${error.message}`));
          });
        });
        const chatModelProfileSelect = document.getElementById("chatModelProfileSelect");
        if (chatModelProfileSelect) {
          chatModelProfileSelect.addEventListener("change", () => {
            renderDataContextStrip();
          });
        }

        document.getElementById("commandForm").addEventListener("submit", async (event) => {
          event.preventDefault();
          const input = document.getElementById("commandInput");
          const text = input.value.trim();
          input.value = "";
          await runWorkspaceCommand(text);
        });

        window.addEventListener("keydown", (event) => {
          const isCommandPalette = (event.metaKey || event.ctrlKey) && event.key.toLowerCase() === "k";
          const isNewThread = event.key.toLowerCase() === "t" && event.altKey;
          const isNewAutomation = event.key.toLowerCase() === "a" && event.altKey;
          if (isCommandPalette) {
            event.preventDefault();
            const input = document.getElementById("commandInput");
            input.focus();
            input.select();
            return;
          }
          if (isNewThread) {
            event.preventDefault();
            document.getElementById("newThreadTitleInput").focus();
            return;
          }
          if (isNewAutomation) {
            event.preventDefault();
            document.getElementById("leftNewAutomationBtn").click();
          }
        });
        document.getElementById("chatInput").addEventListener("paste", (event) => {
          const files = Array.from(event.clipboardData?.files || []);
          if (!files.length) return;
          appState.pendingAttachments.push(...files.map((file) => ({
            name: file.name || "pasted-image.png",
            type: file.type,
            size: file.size
          })));
          renderAttachmentTray();
        });

        document.getElementById("chatForm").addEventListener("submit", async (event) => {
          event.preventDefault();
          const input = document.getElementById("chatInput");
          const text = input.value.trim();
          if (!text && !appState.pendingAttachments.length) return;
          input.value = "";
          await runChatIntent(text || "Analyze attached files and screenshots.", { askAi: false });
        });
      }

      async function boot() {
        bindEvents();
        applyWorkspaceLayout();
        renderSessionUserControls();
        renderSavedPrompts();
        renderThreadList();
        await initTenant();
        appendMessage("Welcome to InsightFoundry. Start by reviewing onboarding, then create a guided analysis run.");
        try {
          await loadAll();
          await previewCurrentRunOutput();
        } catch {
          // Surface errors via system alert without spamming chat with stack-like noise.
        }
      }

      boot().catch((error) => {
        setSystemAlert(`Initialization error: ${error.message}`);
      });
    </script>
  </body>
</html>
