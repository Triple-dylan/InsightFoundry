<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>InsightFoundry</title>
    <style>
      :root {
        --bg: #f5f5f7;
        --panel: #ffffff;
        --panel-muted: #fafafc;
        --line: #e4e6ea;
        --line-strong: #d4d9e1;
        --text: #18181b;
        --muted: #6b7280;
        --soft: #8f96a3;
        --ink: #111827;
        --shadow: 0 18px 40px rgba(16, 24, 40, 0.16);
        --left-w: 292px;
        --right-w: 292px;
        --composer-w: 860px;
      }

      * { box-sizing: border-box; }

      html,
      body {
        margin: 0;
        width: 100%;
        height: 100%;
      }

      body {
        font-family: "Sohne", "SÃ¶hne", "SF Pro Text", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: var(--bg);
        color: var(--text);
        overflow: hidden;
      }

      button,
      input,
      textarea,
      select {
        font: inherit;
        color: inherit;
      }

      button:active {
        transform: translateY(0.5px);
      }

      button:focus,
      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
      }

      button:focus-visible,
      input:focus-visible,
      textarea:focus-visible,
      select:focus-visible {
        box-shadow: 0 0 0 2px rgba(17, 24, 39, 0.18);
      }

      .app {
        position: relative;
        width: 100%;
        height: 100vh;
        overflow: hidden;
        isolation: isolate;
      }

      .corner-toggle {
        position: fixed;
        top: 12px;
        z-index: 160;
        width: 32px;
        height: 32px;
        border: 0;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.9);
        color: #5a6271;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: border-color 120ms ease, background 120ms ease, color 120ms ease;
      }

      .corner-toggle:hover {
        background: #fff;
      }

      .corner-toggle:focus-visible {
        box-shadow: none;
      }

      .corner-toggle.left { left: 12px; }
      .corner-toggle.right { right: 12px; }

      .app.left-open .corner-toggle.left,
      .app.right-open .corner-toggle.right {
        opacity: 0;
        pointer-events: none;
      }

      .edge-toggle {
        position: fixed;
        top: 50%;
        z-index: 10000;
        transform: translateY(-50%);
        width: 28px;
        height: 54px;
        border: 1px solid var(--line);
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.95);
        color: #6a7180;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        pointer-events: auto !important;
      }

      .edge-toggle:hover {
        border-color: var(--line-strong);
        background: #fff;
      }

      .edge-toggle.left { left: 0; }
      .edge-toggle.right { right: 0; }

      .app.left-open .edge-toggle.left { left: calc(var(--left-w) + 8px); }
      .app.right-open .edge-toggle.right { right: calc(var(--right-w) + 8px); }
      .app.left-open .edge-toggle.left svg { transform: rotate(180deg); }
      .app.right-open .edge-toggle.right svg { transform: rotate(180deg); }
      .edge-toggle svg { pointer-events: none; }

      .left-rail,
      .right-rail {
        position: fixed;
        top: 0;
        bottom: 0;
        z-index: 70;
        background: var(--panel-muted);
        box-shadow: var(--shadow);
        display: grid;
        pointer-events: none;
      }

      .left-rail {
        left: 0;
        width: var(--left-w);
        border-right: 1px solid var(--line);
        grid-template-rows: auto 1fr auto;
        transform: translateX(calc(-1 * var(--left-w) - 12px));
        transition: transform 160ms ease;
      }

      .app.left-open .left-rail {
        transform: translateX(0);
        pointer-events: auto;
      }

      .right-rail {
        right: 0;
        width: var(--right-w);
        border-left: 1px solid var(--line);
        grid-template-rows: auto 1fr;
        transform: translateX(calc(var(--right-w) + 12px));
        transition: transform 160ms ease;
      }

      .app.right-open .right-rail {
        transform: translateX(0);
        pointer-events: auto;
      }

      .rail-head {
        height: 50px;
        padding: 8px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        border-bottom: 1px solid var(--line);
      }

      .rail-scroll {
        overflow: auto;
        padding: 8px 6px;
      }

      .rail-footer {
        padding: 8px 6px;
        border-top: 1px solid var(--line);
      }

      .rail-row {
        width: 100%;
        min-height: 32px;
        border: 0;
        background: transparent;
        border-radius: 9px;
        padding: 6px 10px;
        display: flex;
        align-items: center;
        gap: 8px;
        text-align: left;
        cursor: pointer;
        color: #2a3142;
      }

      .rail-row:hover { background: #edf0f7; }
      .rail-row.active { background: #e6ebf7; }

      .section-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 14px 8px 6px;
      }

      .section-label {
        font-size: 11px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.04em;
        font-weight: 600;
      }

      .ghost-icon {
        width: 24px;
        height: 24px;
        border: 0;
        border-radius: 7px;
        background: transparent;
        color: var(--soft);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .ghost-icon:hover {
        background: #eceff6;
        color: #4a5262;
      }

      .folder-name {
        margin: 0 10px 4px;
        font-size: 12px;
        color: var(--muted);
      }

      .thread-row {
        width: 100%;
        min-height: 32px;
        border: 0;
        border-radius: 9px;
        background: transparent;
        padding: 6px 10px 6px 22px;
        font-size: 14px;
        text-align: left;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .thread-row:hover { background: #edf0f7; }
      .thread-row.active { background: #e6ebf7; }

      .workspace {
        position: relative;
        width: 100%;
        height: 100vh;
      }

      .feed-wrap {
        position: absolute;
        inset: 0;
        overflow: auto;
        padding: 20px 24px 184px;
      }

      .feed {
        max-width: 860px;
        margin: 0 auto;
      }

      .thread-title {
        margin: 2px 0 16px;
        font-size: 30px;
        line-height: 1.08;
        font-weight: 600;
        letter-spacing: -0.018em;
      }

      .empty {
        margin-top: 40px;
        color: var(--muted);
      }

      .onboarding-card {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        background: #fff;
        padding: 8px;
        margin-bottom: 14px;
      }

      .onboarding-title {
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 4px;
        color: #4b5563;
      }

      .onboarding-step {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        min-height: 34px;
        border-radius: 8px;
        padding: 4px 2px;
      }

      .onboarding-step + .onboarding-step {
        border-top: 1px solid #f0f1f4;
      }

      .mini-action {
        min-height: 26px;
        border: 0;
        background: #fff;
        border-radius: 7px;
        padding: 0 8px;
        cursor: pointer;
        font-size: 12px;
        color: #4d5a73;
      }

      .mini-action:hover {
        background: #f4f7fc;
      }

      .hf-accordion {
        display: grid;
        gap: 8px;
      }

      .hf-acc-item {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        background: #fff;
      }

      .hf-acc-item > summary {
        list-style: none;
      }

      .hf-acc-item > summary::-webkit-details-marker {
        display: none;
      }

      .hf-acc-summary {
        min-height: 40px;
        padding: 0 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        cursor: pointer;
        color: #111827;
        font-size: 14px;
        font-weight: 500;
      }

      .hf-acc-summary:hover {
        background: #f9fafb;
      }

      .hf-acc-chevron {
        width: 18px;
        height: 18px;
        color: #6b7280;
        flex-shrink: 0;
        transition: transform 180ms ease;
      }

      .hf-acc-item[open] .hf-acc-chevron {
        transform: rotate(-180deg);
      }

      .hf-acc-body {
        padding: 10px 12px 12px;
      }

      .hf-detail-list {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        background: #fff;
      }

      .hf-detail-row {
        display: grid;
        grid-template-columns: minmax(120px, 1fr) minmax(0, 2fr);
        gap: 8px;
        padding: 9px 10px;
      }

      .hf-detail-row + .hf-detail-row {
        border-top: 1px solid #eef0f4;
      }

      .hf-detail-key {
        font-size: 12px;
        font-weight: 500;
        color: #374151;
      }

      .hf-detail-val {
        font-size: 13px;
        color: #111827;
        word-break: break-word;
      }

      .hf-stats {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
      }

      .hf-stat {
        border: 1px solid #eceef3;
        border-radius: 10px;
        background: #fff;
        padding: 10px;
      }

      .hf-stat-kicker {
        font-size: 11px;
        color: #6b7280;
      }

      .hf-stat-value {
        margin-top: 4px;
        font-size: 18px;
        font-weight: 600;
        color: #111827;
      }

      .hf-stat-trend {
        margin-top: 4px;
        font-size: 11px;
        color: #6b7280;
      }

      .hf-table-wrap {
        overflow-x: auto;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        background: #fff;
      }

      .hf-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 420px;
      }

      .hf-table th {
        text-align: left;
        padding: 8px 10px;
        border-bottom: 1px solid #e5e7eb;
        font-size: 12px;
        font-weight: 600;
        color: #374151;
        white-space: nowrap;
      }

      .hf-table td {
        padding: 8px 10px;
        border-bottom: 1px solid #eef0f4;
        font-size: 12px;
        color: #111827;
        vertical-align: top;
      }

      .hf-table tr:last-child td {
        border-bottom: 0;
      }

      .hf-timeline {
        position: relative;
        margin: 0;
        padding: 0 0 0 10px;
        list-style: none;
      }

      .hf-timeline::before {
        content: "";
        position: absolute;
        left: 1px;
        top: 4px;
        bottom: 4px;
        width: 2px;
        background: #e5e7eb;
        border-radius: 999px;
      }

      .hf-timeline-item {
        position: relative;
        padding-left: 14px;
        margin-bottom: 10px;
      }

      .hf-timeline-item::before {
        content: "";
        position: absolute;
        left: -1px;
        top: 6px;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #2563eb;
      }

      .hf-timeline-time {
        font-size: 11px;
        color: #6b7280;
      }

      .hf-timeline-title {
        margin-top: 2px;
        font-size: 13px;
        font-weight: 600;
        color: #111827;
      }

      .hf-timeline-copy {
        margin-top: 3px;
        font-size: 12px;
        color: #4b5563;
      }

      .hf-notes {
        display: grid;
        gap: 6px;
      }

      .hf-notes label {
        font-size: 12px;
        font-weight: 500;
        color: #374151;
      }

      .hf-notes textarea {
        width: 100%;
        min-height: 82px;
        resize: none;
        border: 1px solid #d7dbe3;
        border-radius: 10px;
        background: #fff;
        padding: 8px 10px;
      }

      .hf-upload {
        border: 1px solid #d6d9e0;
        border-radius: 10px;
        background: #fff;
        padding: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        color: #111827;
      }

      .hf-upload:hover {
        background: #f9fafb;
      }

      .hf-radio-group {
        display: grid;
        gap: 8px;
      }

      .hf-radio {
        border: 1px solid #d1d5db;
        border-radius: 10px;
        background: #fff;
        min-height: 42px;
        padding: 8px 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        cursor: pointer;
      }

      .hf-radio.active {
        border-color: #2563eb;
        box-shadow: inset 0 0 0 1px #2563eb;
      }

      .hf-radio-title {
        font-size: 13px;
        color: #111827;
      }

      .hf-radio-meta {
        font-size: 12px;
        color: #6b7280;
      }

      .hf-toggle {
        position: relative;
        display: inline-block;
        width: 48px;
        height: 28px;
      }

      .hf-toggle input {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
      }

      .hf-toggle-track {
        position: absolute;
        inset: 0;
        border-radius: 999px;
        background: #d1d5db;
        transition: background 150ms ease;
      }

      .hf-toggle-knob {
        position: absolute;
        top: 3px;
        left: 3px;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: #4b5563;
        transition: transform 150ms ease, background 150ms ease;
      }

      .hf-toggle input:checked + .hf-toggle-track {
        background: #bfdbfe;
      }

      .hf-toggle input:checked + .hf-toggle-track .hf-toggle-knob {
        transform: translateX(20px);
        background: #2563eb;
      }

      .message {
        margin-bottom: 18px;
      }

      .message-head {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
      }

      .author {
        font-size: 13px;
        font-weight: 600;
      }

      .stamp {
        font-size: 12px;
        color: var(--muted);
      }

      .message-body {
        font-size: 16px;
        line-height: 1.45;
        letter-spacing: -0.006em;
        white-space: pre-wrap;
      }

      .message-actions {
        display: flex;
        gap: 10px;
        margin-top: 6px;
      }

      .message-reactions {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
      }

      .reaction-chip {
        min-height: 24px;
        border: 1px solid var(--line);
        border-radius: 999px;
        background: #fff;
        padding: 0 8px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: #374151;
        cursor: pointer;
      }

      .reaction-chip.mine {
        border-color: #b8c2d9;
        background: #eef2ff;
      }

      .reaction-add {
        min-height: 24px;
        border: 1px dashed var(--line-strong);
        border-radius: 999px;
        background: transparent;
        padding: 0 8px;
        font-size: 12px;
        color: #64748b;
        cursor: pointer;
      }

      .reaction-picker {
        display: none;
        gap: 6px;
        flex-wrap: wrap;
        margin-top: 6px;
      }

      .reaction-picker.open {
        display: flex;
      }

      .emoji-btn {
        min-width: 30px;
        min-height: 26px;
        border: 1px solid var(--line);
        border-radius: 8px;
        background: #fff;
        cursor: pointer;
      }

      .link-btn {
        border: 0;
        background: transparent;
        color: #64708a;
        font-size: 12px;
        padding: 0;
        cursor: pointer;
      }

      .link-btn:hover { color: #202a40; }

      .inline-reply {
        margin-top: 8px;
        margin-left: 18px;
        padding-left: 10px;
        border-left: 1px solid var(--line);
      }

      .bottom-dock {
        position: fixed;
        left: 50%;
        bottom: 104px;
        transform: translateX(-50%);
        width: min(var(--composer-w), calc(100vw - 22px));
        border: 1px solid var(--line);
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.98);
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.12);
        z-index: 95;
        display: none;
        overflow: hidden;
      }

      .bottom-dock.open {
        display: grid;
        grid-template-rows: auto 1fr;
      }

      .dock-head {
        min-height: 40px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px 8px;
        border-bottom: 1px solid var(--line);
      }

      .dock-tabs {
        display: flex;
        gap: 5px;
      }

      .tab-pill {
        min-height: 28px;
        border: 0;
        border-radius: 8px;
        background: transparent;
        padding: 0 10px;
        cursor: pointer;
      }

      .tab-pill:hover {
        background: #edf1f8;
      }

      .tab-pill.active {
        background: #e7ecf8;
      }

      .dock-body {
        max-height: 280px;
        overflow: auto;
        padding: 8px;
      }

      .dock-panel { display: none; }
      .dock-panel.active { display: block; }

      .doc-preview-frame {
        width: 100%;
        min-height: 220px;
        border: 1px solid var(--line);
        border-radius: 10px;
        background: #fff;
      }

      .table-grid-wrap {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        background: #fff;
        overflow: auto;
      }

      .table-grid {
        width: 100%;
        border-collapse: collapse;
        min-width: 620px;
      }

      .table-grid th,
      .table-grid td {
        border-bottom: 1px solid #eef0f4;
        border-right: 1px solid #f0f3f8;
        padding: 7px 8px;
        font-size: 12px;
        vertical-align: top;
      }

      .table-grid th:last-child,
      .table-grid td:last-child {
        border-right: 0;
      }

      .table-grid tbody tr:last-child td {
        border-bottom: 0;
      }

      .table-cell-input {
        width: 100%;
        border: 1px solid transparent;
        border-radius: 6px;
        padding: 4px 6px;
        background: transparent;
      }

      .table-cell-input:focus {
        border-color: #c7d2fe;
        background: #fff;
      }

      .list-row {
        border: 0;
        border-radius: 10px;
        background: transparent;
        padding: 8px 9px;
        margin-bottom: 4px;
        font-size: 13px;
      }

      .list-row:hover {
        background: #f2f4f9;
      }

      .list-row .meta {
        margin-top: 4px;
        font-size: 12px;
        color: var(--muted);
      }

      .line-actions {
        display: flex;
        gap: 6px;
        margin-top: 6px;
      }

      .line-btn {
        min-height: 30px;
        border: 1px solid var(--line);
        border-radius: 8px;
        background: #fff;
        padding: 0 9px;
        cursor: pointer;
        font-size: 12px;
      }

      .line-btn:hover { background: #f4f7fc; }

      .composer-wrap {
        position: fixed;
        left: 50%;
        bottom: 12px;
        transform: translateX(-50%);
        width: min(var(--composer-w), calc(100vw - 22px));
        z-index: 70;
      }

      .composer-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 8px;
      }

      .chip {
        min-height: 26px;
        border: 1px solid var(--line);
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.94);
        padding: 4px 9px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
      }

      .chip-x {
        border: 0;
        background: transparent;
        color: var(--muted);
        cursor: pointer;
        padding: 0;
      }

      .composer {
        border: 1px solid var(--line);
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.98);
        box-shadow: 0 14px 34px rgba(15, 23, 42, 0.12);
        overflow: visible;
      }

      .composer-input {
        width: 100%;
        min-height: 56px;
        max-height: 172px;
        resize: none;
        overflow-y: hidden;
        border: 0;
        background: transparent;
        outline: none;
        padding: 12px 14px 6px;
        font-size: 16px;
        line-height: 1.42;
        letter-spacing: -0.005em;
      }

      .composer-footer {
        min-height: 38px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding: 4px 8px 8px;
      }

      .composer-left,
      .composer-right {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .icon-btn,
      .send-btn,
      .ghost-pill,
      .menu-trigger {
        min-height: 30px;
        border: 0;
        border-radius: 999px;
        background: transparent;
      }

      .icon-btn {
        width: 30px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #636d7f;
        cursor: pointer;
      }

      .icon-btn:hover,
      .ghost-pill:hover,
      .menu-trigger:hover {
        background: #edf1f8;
        color: #1f273a;
      }

      .ghost-pill {
        width: 30px;
        padding: 0;
        color: #5f697d;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .ghost-pill.active {
        background: #e7ebf8;
        color: #1d2538;
      }

      .menu-wrap {
        position: relative;
      }

      .menu-trigger {
        padding: 0 10px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        color: #556078;
      }

      .menu-pop {
        position: absolute;
        left: 0;
        bottom: calc(100% + 8px);
        min-width: 180px;
        max-width: min(260px, calc(100vw - 16px));
        max-height: 220px;
        overflow: auto;
        border: 1px solid var(--line);
        border-radius: 10px;
        background: #fff;
        box-shadow: 0 14px 30px rgba(14, 18, 33, 0.16);
        padding: 6px;
        display: none;
        z-index: 130;
      }

      .menu-pop.open { display: block; }

      .menu-option {
        width: 100%;
        min-height: 30px;
        border: 0;
        border-radius: 8px;
        background: transparent;
        text-align: left;
        padding: 0 9px;
        cursor: pointer;
      }

      .menu-option:hover { background: #edf1f8; }
      .menu-option.active { background: #e7ebf8; }

      .send-btn {
        width: 30px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: #0f172a;
        color: #fff;
        cursor: pointer;
      }

      .send-btn:hover {
        background: #0c1221;
      }

      .right-head {
        height: 50px;
        border-bottom: 1px solid var(--line);
        padding: 8px;
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: center;
        gap: 8px;
      }

      .right-tools {
        display: flex;
        gap: 4px;
      }

      .right-tabs {
        display: flex;
        gap: 4px;
        justify-content: flex-end;
      }

      .right-body {
        overflow: auto;
        padding: 8px 6px;
      }

      .right-panel { display: none; }
      .right-panel.active { display: block; }

      .settings-overlay {
        position: fixed;
        inset: 0;
        z-index: 95;
        background: rgba(12, 16, 26, 0.42);
        display: none;
        align-items: stretch;
        justify-content: flex-start;
      }

      .settings-overlay.open { display: flex; }

      .settings-modal {
        width: min(980px, 100vw);
        height: 100vh;
        background: #fff;
        border-right: 1px solid var(--line);
        box-shadow: 0 20px 46px rgba(14, 18, 33, 0.25);
        display: grid;
        grid-template-columns: 240px minmax(0, 1fr);
        overflow: hidden;
      }

      .settings-nav {
        border-right: 1px solid var(--line);
        background: #f8f9fc;
        display: grid;
        grid-template-rows: auto 1fr;
      }

      .settings-head {
        height: 54px;
        border-bottom: 1px solid var(--line);
        padding: 0 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .settings-tabs {
        padding: 8px;
        overflow: auto;
      }

      .settings-tab {
        width: 100%;
        min-height: 34px;
        border: 0;
        border-radius: 9px;
        background: transparent;
        padding: 7px 10px;
        text-align: left;
        cursor: pointer;
      }

      .settings-tab:hover { background: #edf1f8; }
      .settings-tab.active { background: #e7ebf8; }

      .settings-content {
        display: grid;
        grid-template-rows: 54px 1fr;
      }

      .settings-content-head {
        border-bottom: 1px solid var(--line);
        padding: 0 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .settings-body {
        overflow: auto;
        padding: 12px;
      }

      .settings-pane { display: none; }
      .settings-pane.active { display: grid; gap: 10px; }

      .field { display: grid; gap: 6px; }

      .field label {
        font-size: 12px;
        color: var(--muted);
      }

      .field input,
      .field textarea,
      .field select {
        width: 100%;
        min-height: 34px;
        border: 1px solid var(--line);
        border-radius: 9px;
        background: #fff;
        padding: 7px 10px;
        outline: none;
      }

      .field textarea {
        min-height: 96px;
        resize: none;
      }

      .row {
        display: flex;
        gap: 8px;
      }

      .row > * {
        flex: 1;
      }

      .toast {
        position: fixed;
        left: 50%;
        bottom: 10px;
        transform: translateX(-50%);
        border-radius: 999px;
        background: #0f172a;
        color: #fff;
        font-size: 12px;
        padding: 8px 12px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 130ms ease;
        z-index: 100;
      }

      .toast.show { opacity: 1; }

      .quick-modal {
        position: fixed;
        inset: 0;
        z-index: 110;
        background: rgba(12, 16, 26, 0.35);
        display: none;
        align-items: center;
        justify-content: center;
      }

      .quick-modal.open {
        display: flex;
      }

      .quick-modal-card {
        width: min(460px, calc(100vw - 24px));
        border: 1px solid var(--line);
        border-radius: 12px;
        background: #fff;
        box-shadow: 0 20px 44px rgba(15, 23, 42, 0.22);
        padding: 12px;
      }

      .quick-modal-title {
        margin: 0 0 4px;
        font-size: 15px;
        font-weight: 600;
      }

      .quick-modal-label {
        margin: 0 0 8px;
        font-size: 12px;
        color: var(--muted);
      }

      .quick-modal-input {
        width: 100%;
        min-height: 38px;
        border: 1px solid var(--line);
        border-radius: 9px;
        padding: 0 10px;
      }

      .quick-modal-actions {
        margin-top: 10px;
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }

      @media (max-width: 920px) {
        :root { --left-w: 86vw; --right-w: 86vw; }

        .thread-title { font-size: 34px; }

        .message-body { font-size: 15px; }

        .composer-input { font-size: 16px; }

        .feed-wrap { padding: 16px 12px 206px; }

        .composer-wrap,
        .bottom-dock {
          width: calc(100vw - 14px);
        }

        .bottom-dock { bottom: 96px; }

        .settings-modal {
          width: 100vw;
          height: 100vh;
          grid-template-columns: 1fr;
          grid-template-rows: auto 1fr;
        }

        .settings-nav {
          border-right: 0;
          border-bottom: 1px solid var(--line);
        }

        .settings-tabs {
          display: flex;
          gap: 6px;
          overflow: auto;
        }

        .settings-tab {
          min-width: max-content;
        }
      }
    </style>
  </head>
  <body>
    <div id="app" class="app">
      <button id="topLeftToggle" class="corner-toggle left" type="button" aria-label="Open left rail">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7h16M4 12h16M4 17h16"/></svg>
      </button>
      <button id="topRightToggle" class="corner-toggle right" type="button" aria-label="Open right rail">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M15 4v16"/></svg>
      </button>

      <button id="leftEdgeToggle" class="edge-toggle left" type="button" aria-label="Toggle left rail">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
      </button>
      <button id="rightEdgeToggle" class="edge-toggle right" type="button" aria-label="Toggle right rail">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
      </button>

      <aside class="left-rail" aria-label="Sidebar">
        <div class="rail-head">
          <button id="closeLeftBtn" class="ghost-icon" type="button" aria-label="Close left rail">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
          </button>
        </div>
        <div class="rail-scroll">
          <button id="newThreadBtn" class="rail-row" type="button">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
            <span>New thread</span>
          </button>
          <button id="openAutomationsBtn" class="rail-row" type="button">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 7v5l3 3"/></svg>
            <span>Automations</span>
          </button>
          <button id="openSkillsBtn" class="rail-row" type="button">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6l8-4 8 4-8 4-8-4z"/><path d="M4 12l8 4 8-4"/><path d="M4 18l8 4 8-4"/></svg>
            <span>Skills</span>
          </button>

          <div class="section-head">
            <div class="section-label">Threads</div>
            <button id="newFolderBtn" class="ghost-icon" type="button" aria-label="New folder">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
            </button>
          </div>
          <div id="threadTree"></div>
        </div>
        <div class="rail-footer">
          <button id="openSettingsBtn" class="rail-row" type="button">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06A2 2 0 1 1 3.37 17l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H2a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82L3.21 7.3A2 2 0 1 1 6.04 4.5l.06.06a1.65 1.65 0 0 0 1.82.33h.01A1.65 1.65 0 0 0 9 3.38V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.01a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.01a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            <span>Settings</span>
          </button>
        </div>
      </aside>

      <main class="workspace">
        <div id="feedWrap" class="feed-wrap">
          <section id="feed" class="feed"></section>
        </div>

        <section id="bottomDock" class="bottom-dock">
          <div class="dock-head">
            <div class="dock-tabs">
              <button class="tab-pill active" data-dock-tab="files" type="button">Files</button>
              <button class="tab-pill" data-dock-tab="docs" type="button">Docs</button>
              <button class="tab-pill" data-dock-tab="tables" type="button">Tables</button>
            </div>
            <button id="closeDockBtn" class="ghost-icon" type="button" aria-label="Close dock">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
          </div>
          <div class="dock-body">
            <section id="dock-files" class="dock-panel active"></section>
            <section id="dock-docs" class="dock-panel"></section>
            <section id="dock-tables" class="dock-panel"></section>
          </div>
        </section>

        <div class="composer-wrap">
          <div id="composerChips" class="composer-chips"></div>
          <form id="composerForm" class="composer">
            <textarea id="composerInput" class="composer-input" placeholder="Message team. Mention @Titus or enable Ask AI."></textarea>
            <div class="composer-footer">
              <div class="composer-left">
                <button id="addFilesBtn" class="icon-btn" type="button" title="Add files">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                </button>

                <div class="menu-wrap">
                  <button id="modelMenuBtn" class="menu-trigger" type="button">
                    <span id="modelMenuLabel">Auto</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                  </button>
                  <div id="modelMenu" class="menu-pop"></div>
                </div>

                <div class="menu-wrap">
                  <button id="effortMenuBtn" class="menu-trigger" type="button">
                    <span id="effortMenuLabel">High</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                  </button>
                  <div id="effortMenu" class="menu-pop"></div>
                </div>

                <button id="askAiToggle" class="ghost-pill active" type="button" aria-label="Ask AI" title="Ask AI">
                  <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3l1.6 4.6L18 9.2l-4.4 1.6L12 15.4l-1.6-4.6L6 9.2l4.4-1.6L12 3z"/><path d="M5 19l.8 2.2L8 22l-2.2.8L5 25l-.8-2.2L2 22l2.2-.8L5 19z"/></svg>
                </button>
                <button id="privateToggle" class="ghost-pill" type="button" aria-label="Private AI reply" title="Private AI reply">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="11" width="14" height="10" rx="2"/><path d="M8 11V8a4 4 0 0 1 8 0v3"/></svg>
                </button>
              </div>
              <div class="composer-right">
                <button id="micBtn" class="icon-btn" type="button" title="Mic">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="2" width="6" height="12" rx="3"/><path d="M5 10a7 7 0 0 0 14 0"/><path d="M12 19v3"/><path d="M8 22h8"/></svg>
                </button>
                <button id="sendBtn" class="send-btn" type="submit" title="Send">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19V5"/><path d="M5 12l7-7 7 7"/></svg>
                </button>
              </div>
            </div>
            <input id="fileInput" type="file" multiple hidden />
          </form>
        </div>
      </main>

      <aside class="right-rail" aria-label="Context rail">
        <div class="right-head">
          <div class="right-tools">
            <button id="openDockDocsBtn" class="icon-btn" type="button" title="Docs">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M8 13h8M8 17h8M8 9h3"/></svg>
            </button>
            <button id="popoutBtn" class="icon-btn" type="button" title="Popout">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 3h7v7"/><path d="M10 14L21 3"/><path d="M21 14v7h-7"/><path d="M3 10L14 21"/></svg>
            </button>
          </div>

          <div class="right-tabs">
            <button class="icon-btn active" data-right-tab="attachments" type="button" title="Attachments">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a5.5 5.5 0 0 1-7.78-7.78l9.2-9.19a3.5 3.5 0 1 1 4.95 4.95l-9.2 9.19a1.5 1.5 0 0 1-2.12-2.12l8.48-8.48"/></svg>
            </button>
            <button class="icon-btn" data-right-tab="notifications" type="button" title="Notifications">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 17h5l-1.4-1.4a2 2 0 0 1-.6-1.4V11a6 6 0 1 0-12 0v3.2c0 .5-.2 1-.6 1.4L4 17h5"/><path d="M9 17a3 3 0 0 0 6 0"/></svg>
            </button>
          </div>

          <button id="closeRightBtn" class="ghost-icon" type="button" aria-label="Close right rail">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
          </button>
        </div>

        <div class="right-body">
          <section id="right-attachments" class="right-panel active"></section>
          <section id="right-notifications" class="right-panel"></section>
        </div>
      </aside>
    </div>

    <div id="settingsOverlay" class="settings-overlay" role="dialog" aria-modal="true" aria-label="Settings">
      <div class="settings-modal">
        <aside class="settings-nav">
          <div class="settings-head">
            <strong style="font-size:14px;">Settings</strong>
            <button id="closeSettingsBtn" class="ghost-icon" type="button" aria-label="Close settings">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
          </div>
          <div class="settings-tabs">
            <button class="settings-tab active" data-settings="general" type="button">General</button>
            <button class="settings-tab" data-settings="connections" type="button">Connections</button>
            <button class="settings-tab" data-settings="models" type="button">Models</button>
            <button class="settings-tab" data-settings="analysis-profiles" type="button">Analysis Profiles</button>
            <button class="settings-tab" data-settings="training" type="button">Training</button>
            <button class="settings-tab" data-settings="reports" type="button">Reports</button>
            <button class="settings-tab" data-settings="channels" type="button">Channels</button>
            <button class="settings-tab" data-settings="team" type="button">Team</button>
            <button class="settings-tab" data-settings="skills" type="button">Skills</button>
            <button class="settings-tab" data-settings="automations" type="button">Automations</button>
            <button class="settings-tab" data-settings="policies" type="button">Policies</button>
          </div>
        </aside>

        <section class="settings-content">
          <div class="settings-content-head">
            <strong id="settingsTitle" style="font-size:14px;">General</strong>
            <button id="saveSettingsBtn" class="line-btn" type="button">Save</button>
          </div>
          <div class="settings-body">
            <section id="settings-general" class="settings-pane active"></section>
            <section id="settings-connections" class="settings-pane"></section>
            <section id="settings-models" class="settings-pane"></section>
            <section id="settings-analysis-profiles" class="settings-pane"></section>
            <section id="settings-training" class="settings-pane"></section>
            <section id="settings-reports" class="settings-pane"></section>
            <section id="settings-channels" class="settings-pane"></section>
            <section id="settings-team" class="settings-pane"></section>
            <section id="settings-skills" class="settings-pane"></section>
            <section id="settings-automations" class="settings-pane"></section>
            <section id="settings-policies" class="settings-pane"></section>
          </div>
        </section>
      </div>
    </div>

    <div id="quickModal" class="quick-modal" aria-hidden="true">
      <div class="quick-modal-card" role="dialog" aria-modal="true" aria-label="Create">
        <h3 id="quickModalTitle" class="quick-modal-title">Create</h3>
        <p id="quickModalLabel" class="quick-modal-label">Name</p>
        <input id="quickModalInput" class="quick-modal-input" type="text" maxlength="96" />
        <div class="quick-modal-actions">
          <button id="quickModalCancel" class="line-btn" type="button">Cancel</button>
          <button id="quickModalConfirm" class="line-btn" type="button">Create</button>
        </div>
      </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
      const demoTenantId = "__DEMO_TENANT_ID__";
      const modelOptions = [
        { value: "auto", label: "Auto" },
        { value: "gpt-5-codex", label: "GPT-5 Codex" },
        { value: "claude-sonnet", label: "Claude Sonnet" },
        { value: "gemini-2.5", label: "Gemini 2.5" }
      ];
      const effortOptions = [
        { value: "high", label: "High" },
        { value: "medium", label: "Medium" },
        { value: "low", label: "Low" }
      ];
      const reactionEmojis = ["ðŸ‘", "âœ…", "ðŸ‘€", "ðŸ”¥", "ðŸ’¡", "ðŸ“Œ", "ðŸš«", "ðŸŽ¯"];

      const state = {
        tenantId: demoTenantId || "",
        currentUserId: "ui-user",
        currentUserRole: "owner",
        folders: [],
        threads: [],
        activeFolderId: null,
        activeThreadId: null,
        messages: [],
        repliesByParent: {},
        attachments: [],
        folderAttachments: [],
        pendingAssets: [],
        onboarding: null,
        notifications: [],
        settings: null,
        team: [],
        teamAppearance: [],
        workspaceAgent: null,
        profiles: [],
        reportTypes: [],
        connections: [],
        runs: [],
        installedSkills: [],
        automations: [],
        selectedAutomationId: null,
        automationRuns: [],
        modelProviderHealth: [],
        docsFiles: [],
        docsSession: null,
        docsAuthConnected: false,
        tables: [],
        activeTableId: null,
        activeTableRows: [],
        reportTemplates: [],
        selectedTemplateId: null,
        heartbeatByAutomationId: {},
        aiWorkingByThread: {},
        liveSyncEnabled: false,
        realtime: {
          socket: null,
          token: null,
          reconnectTimer: null,
          lastEventAt: null
        },
        selectedModelPreset: "auto",
        selectedEffort: "high",
        askAi: false,
        privateAi: false,
        replyToMessageId: null,
        rightTab: "attachments",
        settingsTab: "general",
        dockOpen: false,
        dockTab: "files",
        selectedDockAttachmentId: null,
        attachmentDetailsById: {},
        rightRailNotes: "",
        quickModal: {
          open: false,
          mode: null,
          title: "",
          label: "",
          placeholder: "",
          confirmLabel: "Create",
          value: "",
          error: ""
        }
      };

      function toast(message) {
        const node = document.getElementById("toast");
        if (!node) return;
        node.textContent = message;
        node.classList.add("show");
        clearTimeout(toast._timer);
        toast._timer = setTimeout(() => node.classList.remove("show"), 1400);
      }

      function escapeHtml(value) {
        return String(value ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function escapeAttr(value) {
        return escapeHtml(value).replaceAll("`", "");
      }

      function memberColor(memberId = "") {
        const manual = state.teamAppearance.find((item) => item.memberId === memberId);
        if (manual?.colorHex) return manual.colorHex;
        const palette = ["#0f766e", "#0b57d0", "#a61e4d", "#7c2d12", "#3f6212", "#5b21b6", "#155e75", "#1f2937"];
        let hash = 0;
        for (let i = 0; i < memberId.length; i += 1) {
          hash = (hash << 5) - hash + memberId.charCodeAt(i);
          hash |= 0;
        }
        return palette[Math.abs(hash) % palette.length];
      }

      function parseMentionTokens(text = "") {
        return [...String(text || "").matchAll(/@([a-zA-Z0-9._-]{2,64})/g)]
          .map((match) => String(match[1] || "").toLowerCase().replace(/[^a-z0-9]+/g, ""));
      }

      function hasAgentMention(text = "") {
        const aliases = new Set([
          String(state.workspaceAgent?.name || "Titus").toLowerCase().replace(/[^a-z0-9]+/g, ""),
          ...(Array.isArray(state.workspaceAgent?.mentionAliases) ? state.workspaceAgent.mentionAliases : ["titus"])
        ].map((entry) => String(entry || "").toLowerCase().replace(/[^a-z0-9]+/g, "")).filter(Boolean));
        const mentions = parseMentionTokens(text);
        return mentions.some((token) => aliases.has(token));
      }

      function headers(extra = {}, includeJson = true) {
        return {
          ...(includeJson ? { "content-type": "application/json" } : {}),
          "x-tenant-id": state.tenantId,
          "x-user-id": state.currentUserId,
          "x-user-role": state.currentUserRole,
          "x-channel-id": "web",
          ...extra
        };
      }

      async function api(path, options = {}) {
        const includeJson = options.includeJson !== false;
        const body = includeJson && options.body && typeof options.body !== "string"
          ? JSON.stringify(options.body)
          : options.body;
        const response = await fetch(path, {
          ...options,
          body,
          headers: {
            ...headers(options.headers || {}, includeJson),
            ...(options.headers || {})
          }
        });
        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(payload.error || `Request failed: ${response.status}`);
        }
        return payload;
      }

      async function ensureTenant() {
        const listed = await fetch("/v1/tenants", { headers: { "content-type": "application/json" } }).then((r) => r.json());
        if (!state.tenantId && listed.tenants?.length) {
          state.tenantId = listed.tenants[0].id;
        }
        if (!state.tenantId) {
          const created = await fetch("/v1/tenants", {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify({ name: "Demo Tenant" })
          }).then((r) => r.json());
          state.tenantId = created.tenant.id;
        }
      }

      async function loadThreads() {
        const foldersRes = await api("/v1/workspace/folders");
        state.folders = foldersRes.folders || [];
        const threadLists = await Promise.all(
          state.folders.map((folder) =>
            api(`/v1/workspace/threads?folderId=${encodeURIComponent(folder.id)}`).then((res) => ({
              folderId: folder.id,
              threads: res.threads || []
            }))
          )
        );
        state.threads = threadLists.flatMap((item) => item.threads || []);
        const activeFolderExists = state.folders.some((folder) => folder.id === state.activeFolderId);
        if (!state.activeFolderId || !activeFolderExists) {
          state.activeFolderId = state.folders[0]?.id || null;
        }
        const activeThreadExists = state.threads.some((thread) => thread.id === state.activeThreadId);
        if (!state.activeThreadId || !activeThreadExists) {
          const first = state.threads.find((item) => item.folderId === state.activeFolderId) || state.threads[0];
          state.activeThreadId = first?.id || null;
        }
      }

      async function loadSettings() {
        const [
          settingsRes,
          teamRes,
          profilesRes,
          reportRes,
          runsRes,
          notificationsRes,
          connectionsRes,
          installedRes,
          workspaceAgentRes,
          automationsRunsRes,
          onboardingRes
        ] = await Promise.all([
          api("/v1/settings"),
          api("/v1/settings/team"),
          api("/v1/models/profiles"),
          api("/v1/reports/types"),
          api("/v1/analysis-runs"),
          api("/v1/workspace/notifications"),
          api("/v1/sources/connections"),
          api("/v1/skills/installed"),
          api("/v1/settings/workspace-agent"),
          api("/v1/automations/runs"),
          api("/v1/workspace/onboarding")
        ]);

        state.settings = settingsRes.settings || null;
        state.team = teamRes.team || [];
        state.teamAppearance = teamRes.appearance || [];
        state.profiles = profilesRes.profiles || [];
        state.reportTypes = reportRes.types || [];
        state.runs = runsRes.runs || [];
        state.notifications = notificationsRes.notifications || [];
        state.connections = connectionsRes.connections || [];
        state.installedSkills = installedRes.installed || [];
        state.workspaceAgent = workspaceAgentRes.profile || null;
        state.automationRuns = automationsRunsRes.runs || [];
        state.onboarding = onboardingRes.onboarding || null;

        const owner = state.team.find((member) => member.role === "owner") || state.team[0];
        if (owner) {
          state.currentUserId = owner.id;
          state.currentUserRole = owner.role;
        }

        try {
          const providerHealthRes = await api("/v1/models/providers/health");
          state.modelProviderHealth = providerHealthRes.health || [];
        } catch {
          state.modelProviderHealth = [];
        }

        try {
          const templatesRes = await api("/v1/reports/templates");
          state.reportTemplates = templatesRes.templates || [];
          if (!state.selectedTemplateId || !state.reportTemplates.some((item) => item.id === state.selectedTemplateId)) {
            state.selectedTemplateId = state.reportTemplates[0]?.id || null;
          }
        } catch {
          state.reportTemplates = [];
        }
      }

      async function loadDocsData() {
        try {
          const docsRes = await api("/v1/workspace/docs/files");
          state.docsFiles = docsRes.files || [];
          state.docsAuthConnected = true;
        } catch {
          state.docsFiles = [];
        }
      }

      async function loadTablesData() {
        try {
          const tablesRes = await api("/v1/workspace/tables");
          state.tables = tablesRes.tables || [];
          if (!state.activeTableId || !state.tables.some((item) => item.id === state.activeTableId)) {
            state.activeTableId = state.tables[0]?.id || null;
          }
          if (!state.activeTableId) {
            state.activeTableRows = [];
            return;
          }
          const detail = await api(`/v1/workspace/tables/${encodeURIComponent(state.activeTableId)}`);
          state.activeTableRows = detail.rows || [];
        } catch {
          state.tables = [];
          state.activeTableRows = [];
          state.activeTableId = null;
        }
      }

      async function loadAutomationsForActiveFolder() {
        if (!state.activeFolderId) {
          state.automations = [];
          state.selectedAutomationId = null;
          return;
        }
        try {
          const res = await api(`/v1/automations/folders/${encodeURIComponent(state.activeFolderId)}`);
          state.automations = res.automations || [];
          if (!state.selectedAutomationId || !state.automations.some((item) => item.id === state.selectedAutomationId)) {
            state.selectedAutomationId = state.automations[0]?.id || null;
          }
        } catch {
          state.automations = [];
          state.selectedAutomationId = null;
        }
      }

      async function loadThreadData() {
        if (!state.activeThreadId) {
          state.messages = [];
          state.repliesByParent = {};
          state.attachments = [];
          await loadFolderAttachments();
          return;
        }
        const [messagesRes, attachmentsRes] = await Promise.all([
          api(`/v1/workspace/chat/threads/${encodeURIComponent(state.activeThreadId)}/messages`),
          api(`/v1/workspace/chat/threads/${encodeURIComponent(state.activeThreadId)}/attachments`)
        ]);
        state.messages = messagesRes.messages || [];
        state.attachments = attachmentsRes.attachments || [];
        const working = state.aiWorkingByThread[state.activeThreadId];
        if (working) {
          const hasAgentReply = state.messages.some((item) =>
            item.authorType === "agent"
            && Date.parse(item.createdAt || "") >= Date.parse(working.createdAt || "1970-01-01T00:00:00.000Z")
          );
          if (hasAgentReply) {
            delete state.aiWorkingByThread[state.activeThreadId];
          }
        }

        const parents = state.messages.filter((item) => Number(item.replyCount || 0) > 0);
        if (!parents.length) {
          state.repliesByParent = {};
          await loadFolderAttachments();
          return;
        }
        const miniThreads = await Promise.all(
          parents.map((parent) =>
            api(`/v1/workspace/chat/threads/${encodeURIComponent(state.activeThreadId)}/mini-threads/${encodeURIComponent(parent.id)}`)
              .then((res) => ({ id: parent.id, miniThread: res.miniThread }))
              .catch(() => ({ id: parent.id, miniThread: { replies: [], mode: "inline" } }))
          )
        );
        state.repliesByParent = miniThreads.reduce((acc, entry) => {
          acc[entry.id] = entry.miniThread;
          return acc;
        }, {});
        await loadFolderAttachments();
      }

      async function loadFolderAttachments() {
        const hasActiveFolder = state.activeFolderId && state.folders.some((folder) => folder.id === state.activeFolderId);
        if (hasActiveFolder) {
          try {
            const response = await api(`/v1/workspace/folders/${encodeURIComponent(state.activeFolderId)}/attachments`);
            state.folderAttachments = response.attachments || [];
            return;
          } catch {
            state.folderAttachments = [];
          }
        }
        state.folderAttachments = (state.attachments || []).map((attachment) => ({
          attachmentId: attachment.attachmentId || attachment.id,
          id: attachment.attachmentId || attachment.id,
          name: attachment.name,
          mimeType: attachment.mimeType || attachment.type || "application/octet-stream",
          size: Number(attachment.size || 0),
          previewable: Boolean(attachment.previewable),
          previewUrl: attachment.previewUrl || "",
          threadIds: attachment.threadId ? [attachment.threadId] : [],
          lastUsedAt: attachment.createdAt || new Date().toISOString()
        }));
      }

      async function loadAll() {
        await loadThreads();
        await loadSettings();
        await loadAutomationsForActiveFolder();
        await loadThreadData();
        await Promise.all([loadDocsData(), loadTablesData()]);
      }

      function scheduleRefresh(kind = "thread", delayMs = 140) {
        const key = `_refresh_${kind}`;
        if (state[key]) clearTimeout(state[key]);
        state[key] = setTimeout(async () => {
          try {
            if (kind === "thread") {
              await loadThreadData();
            } else if (kind === "settings") {
              await loadSettings();
            } else if (kind === "docs") {
              await loadDocsData();
            } else if (kind === "tables") {
              await loadTablesData();
            }
            renderAll();
          } catch {}
          state[key] = null;
        }, delayMs);
      }

      function disconnectRealtime() {
        if (state.realtime.reconnectTimer) {
          clearTimeout(state.realtime.reconnectTimer);
          state.realtime.reconnectTimer = null;
        }
        if (state.realtime.socket) {
          try {
            state.realtime.socket.close();
          } catch {}
          state.realtime.socket = null;
        }
      }

      function handleRealtimeEvent(event) {
        if (!event || event.tenantId !== state.tenantId) return;
        state.realtime.lastEventAt = event.createdAt || new Date().toISOString();
        const type = String(event.type || "");
        if (type === "chat.ai_working" && event.threadId) {
          state.aiWorkingByThread[event.threadId] = {
            messageId: event.payload?.messageId || "",
            agentName: event.payload?.agentName || state.workspaceAgent?.name || "Titus",
            createdAt: event.createdAt || new Date().toISOString()
          };
          renderFeed();
          return;
        }
        if (type === "chat.ai_reply_created" && event.threadId) {
          delete state.aiWorkingByThread[event.threadId];
          scheduleRefresh("thread", 40);
          scheduleRefresh("settings", 120);
          return;
        }
        if (type === "chat.message_created" || type === "chat.reply_created" || type === "chat.reaction_added" || type === "chat.reaction_removed") {
          scheduleRefresh("thread", 40);
          if (type === "chat.message_created" || type === "chat.reply_created") {
            scheduleRefresh("settings", 120);
          }
          return;
        }
        if (type === "workspace.notification_read") {
          scheduleRefresh("settings", 40);
          return;
        }
        if (type.startsWith("workspace.doc_")) {
          scheduleRefresh("docs", 80);
          return;
        }
        if (type.startsWith("workspace.table_")) {
          scheduleRefresh("tables", 80);
        }
      }

      async function connectRealtime() {
        disconnectRealtime();
        if (!state.tenantId) return;
        try {
          const tokenRes = await api("/v1/realtime/token");
          const wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
          const wsUrl = `${wsProtocol}//${window.location.host}${tokenRes.wsPath}`;
          const socket = new WebSocket(wsUrl);
          state.realtime.token = tokenRes.token;
          state.realtime.socket = socket;
          state.liveSyncEnabled = true;
          socket.onopen = () => {
            state.liveSyncEnabled = true;
          };
          socket.onmessage = (raw) => {
            try {
              const payload = JSON.parse(raw.data || "{}");
              if (payload.event) handleRealtimeEvent(payload.event);
            } catch {}
          };
          socket.onerror = () => {
            state.liveSyncEnabled = false;
          };
          socket.onclose = () => {
            state.liveSyncEnabled = false;
            state.realtime.socket = null;
            state.realtime.reconnectTimer = setTimeout(() => {
              connectRealtime().catch(() => {});
            }, 1200);
          };
        } catch {
          state.liveSyncEnabled = false;
        }
      }

      function setLeftOpen(open) {
        document.getElementById("app").classList.toggle("left-open", open);
      }

      function setRightOpen(open) {
        document.getElementById("app").classList.toggle("right-open", open);
      }

      function setDockOpen(open, tab = state.dockTab) {
        state.dockOpen = open;
        if (tab) state.dockTab = tab;
        document.getElementById("bottomDock").classList.toggle("open", open);
        document.querySelectorAll("[data-dock-tab]").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.dockTab === state.dockTab);
        });
        document.querySelectorAll(".dock-panel").forEach((panel) => {
          panel.classList.toggle("active", panel.id === `dock-${state.dockTab}`);
        });
      }

      function toggleDock(tab = "files") {
        if (state.dockOpen && state.dockTab === tab) {
          setDockOpen(false);
          return;
        }
        setDockOpen(true, tab);
      }

      function setRightTab(tab) {
        state.rightTab = tab;
        document.querySelectorAll("[data-right-tab]").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.rightTab === tab);
        });
        document.querySelectorAll(".right-panel").forEach((panel) => {
          panel.classList.toggle("active", panel.id === `right-${tab}`);
        });
      }

      function setSettingsTab(tab) {
        state.settingsTab = tab;
        document.querySelectorAll(".settings-tab").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.settings === tab);
        });
        document.querySelectorAll(".settings-pane").forEach((pane) => {
          pane.classList.toggle("active", pane.id === `settings-${tab}`);
        });
        const title = document.getElementById("settingsTitle");
        if (title) title.textContent = tab.replace(/-/g, " ").replace(/\b\w/g, (char) => char.toUpperCase());
      }

      function openSettings(tab = "general") {
        document.getElementById("settingsOverlay").classList.add("open");
        setSettingsTab(tab);
      }

      function closeSettings() {
        document.getElementById("settingsOverlay").classList.remove("open");
      }

      function closeMenus() {
        ["modelMenu", "effortMenu"].forEach((id) => {
          const menu = document.getElementById(id);
          if (!menu) return;
          menu.classList.remove("open");
          menu.style.left = "";
          menu.style.top = "";
        });
      }

      function toggleMenu(menuId, triggerId) {
        const menu = document.getElementById(menuId);
        const trigger = document.getElementById(triggerId);
        if (!menu || !trigger) return;
        const open = menu.classList.contains("open");
        closeMenus();
        if (open) return;
        const rect = trigger.getBoundingClientRect();
        menu.classList.add("open");
        const menuRect = menu.getBoundingClientRect();
        const margin = 8;
        let left = rect.left;
        if (left + menuRect.width > window.innerWidth - margin) {
          left = Math.max(margin, window.innerWidth - menuRect.width - margin);
        }
        let top = rect.top - menuRect.height - 8;
        if (top < margin) {
          top = Math.min(window.innerHeight - menuRect.height - margin, rect.bottom + 8);
        }
        menu.style.position = "fixed";
        menu.style.left = `${Math.round(left)}px`;
        menu.style.top = `${Math.round(top)}px`;
      }

      function timeLabel(iso) {
        if (!iso) return "";
        const date = new Date(iso);
        if (Number.isNaN(date.getTime())) return "";
        return date.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
      }

      function formatBytes(size) {
        const value = Number(size || 0);
        if (!value) return "0 B";
        if (value < 1024) return `${value} B`;
        if (value < 1024 * 1024) return `${(value / 1024).toFixed(1)} KB`;
        return `${(value / (1024 * 1024)).toFixed(1)} MB`;
      }

      function inferColumnsFromRows(rows = []) {
        const keys = new Set();
        for (const row of rows) {
          Object.keys(row?.values || {}).forEach((key) => keys.add(key));
        }
        return [...keys].map((key) => ({ key, type: "string" }));
      }

      function onboardingActionLabel(actionId) {
        const map = {
          connect_source: "Connect",
          configure_llm: "Configure",
          choose_profile: "Select",
          run_first_analysis: "Start",
          deliver_report: "Deliver"
        };
        return map[actionId] || "Open";
      }

      function renderThreadTree() {
        const root = document.getElementById("threadTree");
        if (!root) return;
        if (!state.folders.length) {
          root.innerHTML = '<div class="list-row">No folders</div>';
          return;
        }

        root.innerHTML = state.folders.map((folder) => {
          const folderThreads = state.threads.filter((thread) => thread.folderId === folder.id);
          const rows = folderThreads.map((thread) => {
            const active = thread.id === state.activeThreadId ? "active" : "";
            return `<button class="thread-row ${active}" type="button" data-thread-id="${thread.id}">${escapeHtml(thread.title || "Untitled")}</button>`;
          }).join("") || '<div class="thread-row" style="cursor:default; opacity:0.65;">No threads</div>';
          return `
            <div style="margin-bottom:10px;">
              <div class="folder-name">${escapeHtml(folder.name || "Folder")}</div>
              ${rows}
            </div>
          `;
        }).join("");

        root.querySelectorAll("[data-thread-id]").forEach((button) => {
          button.onclick = async () => {
            state.activeThreadId = button.dataset.threadId;
            const thread = state.threads.find((item) => item.id === state.activeThreadId);
            if (thread) state.activeFolderId = thread.folderId;
            state.replyToMessageId = null;
            await loadAutomationsForActiveFolder();
            await loadThreadData();
            renderAll();
            setLeftOpen(false);
          };
        });
      }

      function renderOnboardingCard() {
        if (!state.onboarding || state.onboarding.completed) return "";
        const steps = state.onboarding.steps || [];
        const rows = steps.map((step) => {
          const isPending = step.status !== "done";
          return `
            <div class="onboarding-step ${isPending ? "pending" : "done"}">
              <div>${escapeHtml(step.title)}</div>
              ${isPending ? `<button class="mini-action" type="button" data-onboarding-action="${step.actionId}">${escapeHtml(onboardingActionLabel(step.actionId))}</button>` : '<span class="stamp">Done</span>'}
            </div>
          `;
        }).join("");

        return `
          <section class="onboarding-card">
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span class="onboarding-title">Setup checklist</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </summary>
              <div class="hf-acc-body">
                ${rows}
              </div>
            </details>
          </section>
        `;
      }

      function renderFeed() {
        const feed = document.getElementById("feed");
        if (!feed) return;
        const thread = state.threads.find((item) => item.id === state.activeThreadId);
        const folder = state.folders.find((item) => item.id === state.activeFolderId);
        if (!thread) {
          feed.innerHTML = '<div class="empty">Create or open a thread from the left rail.</div>';
          return;
        }

        const onboardingHtml = renderOnboardingCard();
        const working = state.aiWorkingByThread[state.activeThreadId];
        const workingHtml = working
          ? `
            <article class="message">
              <div class="message-head">
                <span class="author" style="color:${memberColor("workspace_agent")};">${escapeHtml(working.agentName || "Titus")}</span>
                <span class="stamp">working...</span>
              </div>
              <div class="message-body">Processing the latest request for this thread.</div>
            </article>
          `
          : "";
        const contextList = `
          <div class="hf-detail-list" style="margin-bottom:12px;">
            <div class="hf-detail-row"><dt class="hf-detail-key">Thread</dt><dd class="hf-detail-val">${escapeHtml(thread.title || "Untitled")}</dd></div>
            <div class="hf-detail-row"><dt class="hf-detail-key">Folder</dt><dd class="hf-detail-val">${escapeHtml(folder?.name || "None")}</dd></div>
            <div class="hf-detail-row"><dt class="hf-detail-key">Model</dt><dd class="hf-detail-val">${escapeHtml(modelOptions.find((o) => o.value === state.selectedModelPreset)?.label || "Auto")}</dd></div>
            <div class="hf-detail-row"><dt class="hf-detail-key">Effort</dt><dd class="hf-detail-val">${escapeHtml(effortOptions.find((o) => o.value === state.selectedEffort)?.label || "High")}</dd></div>
            <div class="hf-detail-row"><dt class="hf-detail-key">Pending files</dt><dd class="hf-detail-val">${Number(state.pendingAssets.length)}</dd></div>
          </div>
        `;

        if (!state.messages.length) {
          feed.innerHTML = `
            <div class="thread-title">${escapeHtml(thread.title)}</div>
            ${onboardingHtml}
            ${contextList}
            ${workingHtml}
            <div class="empty">Start the conversation.</div>
          `;
          bindOnboardingActions();
          return;
        }

        const messages = state.messages.map((message) => {
          const replies = state.repliesByParent[message.id]?.replies || [];
          const firstReply = replies[0] || null;
          const extraReplyCount = Math.max(0, replies.length - 1);
          const replyHtml = firstReply
            ? `
              <div class="inline-reply">
                <div class="message-head">
                  <span class="author" style="color:${memberColor(firstReply.authorId || "reply")};">${escapeHtml(firstReply.authorName || "Reply")}</span>
                  <span class="stamp">${escapeHtml(timeLabel(firstReply.createdAt))}</span>
                </div>
                <div class="message-body">${escapeHtml(firstReply.body || "")}</div>
                ${extraReplyCount > 0 ? `<button class="link-btn" type="button" data-open-mini="${message.id}">Open thread (${extraReplyCount + 1})</button>` : ""}
              </div>
            `
            : "";

          const attachmentHtml = Array.isArray(message.attachments) && message.attachments.length
            ? `<div class="stamp" style="margin-top:4px;">${message.attachments.length} attachment${message.attachments.length > 1 ? "s" : ""}</div>`
            : "";
          const reactions = Array.isArray(message.reactions) ? message.reactions : [];
          const reactionsHtml = `
            <div class="message-reactions">
              ${reactions.map((reaction) => `
                <button class="reaction-chip ${reaction.mineReactionId ? "mine" : ""}" type="button"
                  data-reaction-message-id="${message.id}"
                  data-reaction-emoji="${escapeAttr(reaction.emoji)}"
                  data-reaction-id="${escapeAttr(reaction.mineReactionId || "")}">
                  <span>${escapeHtml(reaction.emoji)}</span>
                  <span>${Number(reaction.count || 0)}</span>
                </button>
              `).join("")}
              <button class="reaction-add" type="button" data-open-reaction-picker="${message.id}">+</button>
            </div>
            <div class="reaction-picker" data-reaction-picker="${message.id}">
              ${reactionEmojis.map((emoji) => `
                <button class="emoji-btn" type="button" data-add-reaction-message="${message.id}" data-emoji="${escapeAttr(emoji)}">${escapeHtml(emoji)}</button>
              `).join("")}
            </div>
          `;

          return `
            <article class="message">
              <div class="message-head">
                <span class="author" style="color:${memberColor(message.authorId || "author")};">${escapeHtml(message.authorName || (message.authorType === "agent" ? "Agent" : "User"))}</span>
                <span class="stamp">${escapeHtml(timeLabel(message.createdAt))}</span>
                ${message.privateHidden || message.isPrivateMarker ? '<span class="stamp">private</span>' : ""}
              </div>
              <div class="message-body">${escapeHtml(message.body || "")}</div>
              ${attachmentHtml}
              <div class="message-actions">
                <button class="link-btn" type="button" data-reply-id="${message.id}">Reply</button>
              </div>
              ${reactionsHtml}
              ${replyHtml}
            </article>
          `;
        }).join("");

        feed.innerHTML = `
          <div class="thread-title">${escapeHtml(thread.title)}</div>
          ${onboardingHtml}
          ${contextList}
          ${workingHtml}
          ${messages}
        `;

        bindOnboardingActions();

        feed.querySelectorAll("[data-reply-id]").forEach((button) => {
          button.onclick = () => {
            state.replyToMessageId = button.dataset.replyId;
            const input = document.getElementById("composerInput");
            if (input) {
              input.placeholder = "Reply in thread";
              input.focus();
            }
            toast("Reply mode enabled");
          };
        });

        feed.querySelectorAll("[data-open-mini]").forEach((button) => {
          button.onclick = () => {
            const messageId = button.dataset.openMini;
            const mini = state.repliesByParent[messageId];
            if (!mini?.replies?.length) return;
            setRightOpen(true);
            setRightTab("notifications");
            toast(`Mini-thread replies: ${mini.replies.length}`);
          };
        });

        feed.querySelectorAll("[data-open-reaction-picker]").forEach((button) => {
          button.onclick = () => {
            const messageId = button.dataset.openReactionPicker;
            feed.querySelectorAll(".reaction-picker").forEach((picker) => {
              picker.classList.toggle("open", picker.dataset.reactionPicker === messageId && !picker.classList.contains("open"));
            });
          };
        });

        feed.querySelectorAll("[data-add-reaction-message]").forEach((button) => {
          button.onclick = async () => {
            try {
              await api(`/v1/workspace/chat/messages/${encodeURIComponent(button.dataset.addReactionMessage)}/reactions`, {
                method: "POST",
                body: { emoji: button.dataset.emoji }
              });
              await loadThreadData();
              renderFeed();
            } catch (error) {
              toast(error.message || "Reaction failed");
            }
          };
        });

        feed.querySelectorAll("[data-reaction-message-id]").forEach((button) => {
          button.onclick = async () => {
            const messageId = button.dataset.reactionMessageId;
            const reactionId = button.dataset.reactionId;
            const emoji = button.dataset.reactionEmoji;
            try {
              if (reactionId) {
                await api(`/v1/workspace/chat/messages/${encodeURIComponent(messageId)}/reactions/${encodeURIComponent(reactionId)}`, {
                  method: "DELETE",
                  body: {}
                });
              } else {
                await api(`/v1/workspace/chat/messages/${encodeURIComponent(messageId)}/reactions`, {
                  method: "POST",
                  body: { emoji }
                });
              }
              await loadThreadData();
              renderFeed();
            } catch (error) {
              toast(error.message || "Reaction update failed");
            }
          };
        });
      }

      function bindOnboardingActions() {
        document.querySelectorAll("[data-onboarding-action]").forEach((button) => {
          button.onclick = async () => {
            const actionId = button.dataset.onboardingAction;
            try {
              await api(`/v1/workspace/onboarding/actions/${encodeURIComponent(actionId)}`, { method: "POST", body: {} });
              toast("Step completed");
              await loadAll();
              renderAll();
            } catch (error) {
              toast(error.message || "Onboarding action failed");
            }
          };
        });
      }

      async function loadAttachmentDetail(attachmentId) {
        if (!attachmentId) return null;
        if (state.attachmentDetailsById[attachmentId]) return state.attachmentDetailsById[attachmentId];
        const detail = await api(`/v1/workspace/attachments/${encodeURIComponent(attachmentId)}`);
        state.attachmentDetailsById[attachmentId] = detail;
        return detail;
      }

      function renderComposerChips() {
        const chips = document.getElementById("composerChips");
        if (!chips) return;
        if (!state.pendingAssets.length) {
          chips.innerHTML = "";
          return;
        }
        chips.innerHTML = state.pendingAssets.map((asset, idx) => `
          <div class="chip">
            <span>${escapeHtml(asset.name)}</span>
            <button class="chip-x" type="button" data-remove-asset="${idx}">x</button>
          </div>
        `).join("");
        chips.querySelectorAll("[data-remove-asset]").forEach((button) => {
          button.onclick = () => {
            const idx = Number(button.dataset.removeAsset);
            state.pendingAssets = state.pendingAssets.filter((_, i) => i !== idx);
            renderComposerChips();
            renderDockFiles();
          };
        });
      }

      function renderDockFiles() {
        const panel = document.getElementById("dock-files");
        if (!panel) return;

        const pendingRows = state.pendingAssets.map((asset) => `
          <tr>
            <td>${escapeHtml(asset.name)}</td>
            <td>${escapeHtml(asset.mimeType || asset.type || "file")}</td>
            <td>${formatBytes(asset.size)}</td>
            <td>queued</td>
          </tr>
        `).join("") || '<tr><td colspan="4">No pending attachments</td></tr>';

        const threadRows = state.attachments.map((asset) => {
          const attachmentId = asset.attachmentId || asset.id;
          return `
            <tr>
              <td>${escapeHtml(asset.name || "File")}</td>
              <td>${escapeHtml(asset.type || asset.mimeType || "file")}</td>
              <td>${formatBytes(asset.size)}</td>
              <td>
                <div class="line-actions" style="margin-top:0;">
                  <button class="line-btn" type="button" data-attach-existing="${escapeAttr(attachmentId)}">Attach</button>
                  <button class="line-btn" type="button" data-open-doc="${escapeAttr(attachmentId)}">Open</button>
                </div>
              </td>
            </tr>
          `;
        }).join("") || '<tr><td colspan="4">No files in this thread</td></tr>';

        panel.innerHTML = `
          <label for="fileInput" class="hf-upload">
            <span>Upload file(s)</span>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="18" height="18">
              <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 7.5h-.75A2.25 2.25 0 0 0 4.5 9.75v7.5a2.25 2.25 0 0 0 2.25 2.25h7.5a2.25 2.25 0 0 0 2.25-2.25v-7.5a2.25 2.25 0 0 0-2.25-2.25h-.75m0-3-3-3m0 0-3 3m3-3v11.25" />
            </svg>
          </label>
          <div class="hf-accordion">
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>Pending attachments</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </summary>
              <div class="hf-acc-body">
                <div class="hf-table-wrap">
                  <table class="hf-table">
                    <thead>
                      <tr><th>Name</th><th>Type</th><th>Size</th><th>Status</th></tr>
                    </thead>
                    <tbody>${pendingRows}</tbody>
                  </table>
                </div>
              </div>
            </details>
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>Thread files</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </summary>
              <div class="hf-acc-body">
                <div class="hf-table-wrap">
                  <table class="hf-table">
                    <thead>
                      <tr><th>Name</th><th>Type</th><th>Size</th><th>Actions</th></tr>
                    </thead>
                    <tbody>${threadRows}</tbody>
                  </table>
                </div>
              </div>
            </details>
          </div>
        `;

        panel.querySelectorAll("[data-attach-existing]").forEach((button) => {
          button.onclick = async () => {
            const attachmentId = button.dataset.attachExisting;
            const existing = state.pendingAssets.find((asset) => asset.id === attachmentId);
            if (existing) return;
            const detail = await loadAttachmentDetail(attachmentId);
            const asset = detail.attachment;
            state.pendingAssets.push({ id: asset.id, name: asset.name, mimeType: asset.mimeType, size: asset.size });
            renderComposerChips();
            renderDockFiles();
          };
        });

        panel.querySelectorAll("[data-open-doc]").forEach((button) => {
          button.onclick = async () => {
            state.selectedDockAttachmentId = button.dataset.openDoc;
            setDockOpen(true, "docs");
            await renderDockDocs();
          };
        });
      }

      async function renderDockDocs() {
        const panel = document.getElementById("dock-docs");
        if (!panel) return;
        const selectedFile = state.docsSession?.file || state.docsFiles[0] || null;
        const fileRows = (state.docsFiles || []).map((file) => `
          <tr>
            <td>${escapeHtml(file.title || "Untitled")}</td>
            <td>${escapeHtml(file.provider === "google_sheets" ? "Sheet" : "Doc")}</td>
            <td>
              <div class="line-actions" style="margin-top:0;">
                <button class="line-btn" type="button" data-open-doc-file="${file.id}">Open</button>
                <button class="line-btn" type="button" data-link-doc-file="${file.id}">Link</button>
              </div>
            </td>
          </tr>
        `).join("") || '<tr><td colspan="3">No linked documents yet</td></tr>';

        const selectedAttachment = state.selectedDockAttachmentId
          ? await loadAttachmentDetail(state.selectedDockAttachmentId).catch(() => null)
          : null;

        const attachmentPreview = selectedAttachment?.preview
          ? `
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>Attachment preview: ${escapeHtml(selectedAttachment.attachment.name)}</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </summary>
              <div class="hf-acc-body">
                ${selectedAttachment.preview.kind === "text"
                  ? `<pre style="white-space:pre-wrap; font-size:12px; margin:0;">${escapeHtml(selectedAttachment.preview.text)}</pre>`
                  : `<iframe class="doc-preview-frame" src="${selectedAttachment.preview.dataUrl}" title="attachment preview"></iframe>`}
              </div>
            </details>
          `
          : "";

        panel.innerHTML = `
          <div class="line-actions" style="margin-bottom:8px;">
            <button id="connectGoogleDocsBtn" class="line-btn" type="button">Connect Google Workspace</button>
            <button id="refreshGoogleDocsBtn" class="line-btn" type="button">Refresh</button>
          </div>
          <div class="hf-table-wrap">
            <table class="hf-table">
              <thead>
                <tr><th>File</th><th>Type</th><th>Actions</th></tr>
              </thead>
              <tbody>${fileRows}</tbody>
            </table>
          </div>
          ${selectedFile ? `
            <details class="hf-acc-item" open style="margin-top:8px;">
              <summary class="hf-acc-summary">
                <span>Active session: ${escapeHtml(selectedFile.title)}</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </summary>
              <div class="hf-acc-body">
                <iframe class="doc-preview-frame" src="${escapeAttr(state.docsSession?.session?.embedUrl || selectedFile.embedUrl)}" title="workspace doc"></iframe>
              </div>
            </details>
          ` : ""}
          ${attachmentPreview}
        `;

        const connectBtn = document.getElementById("connectGoogleDocsBtn");
        if (connectBtn) {
          connectBtn.onclick = async () => {
            try {
              const started = await api("/v1/integrations/google/workspace/auth/start");
              await api(started.authorizeUrl);
              await loadDocsData();
              await renderDockDocs();
              toast("Google Workspace connected");
            } catch (error) {
              toast(error.message || "Google auth failed");
            }
          };
        }

        const refreshBtn = document.getElementById("refreshGoogleDocsBtn");
        if (refreshBtn) {
          refreshBtn.onclick = async () => {
            await loadDocsData();
            await renderDockDocs();
          };
        }

        panel.querySelectorAll("[data-open-doc-file]").forEach((button) => {
          button.onclick = async () => {
            try {
              const opened = await api("/v1/workspace/docs/open", {
                method: "POST",
                body: { fileId: button.dataset.openDocFile, mode: "edit" }
              });
              state.docsSession = opened;
              await renderDockDocs();
            } catch (error) {
              toast(error.message || "Open failed");
            }
          };
        });

        panel.querySelectorAll("[data-link-doc-file]").forEach((button) => {
          button.onclick = async () => {
            if (!state.activeThreadId) {
              toast("Open a thread first");
              return;
            }
            try {
              await api("/v1/workspace/docs/link-thread", {
                method: "POST",
                body: {
                  fileId: button.dataset.linkDocFile,
                  threadId: state.activeThreadId
                }
              });
              toast("Linked to thread");
              await loadDocsData();
              await renderDockDocs();
            } catch (error) {
              toast(error.message || "Link failed");
            }
          };
        });
      }

      async function renderDockTables() {
        const panel = document.getElementById("dock-tables");
        if (!panel) return;
        const activeTable = state.tables.find((item) => item.id === state.activeTableId) || null;
        const tableOptions = (state.tables || []).map((table) => `
          <option value="${table.id}" ${table.id === state.activeTableId ? "selected" : ""}>${escapeHtml(table.name)}</option>
        `).join("");
        const columns = activeTable?.schema?.length
          ? activeTable.schema
          : inferColumnsFromRows(state.activeTableRows);
        const header = columns.map((col) => `<th>${escapeHtml(col.key)}</th>`).join("") || "<th>value</th>";
        const bodyRows = (state.activeTableRows || []).slice(0, 80).map((row) => {
          const values = row.values || {};
          const cells = (columns.length ? columns : [{ key: "value" }]).map((col) => `
            <td>${escapeHtml(values[col.key] ?? "")}</td>
          `).join("");
          return `<tr>${cells}</tr>`;
        }).join("") || `<tr><td colspan="${Math.max(columns.length, 1)}">No rows yet</td></tr>`;

        const connectionOptions = (state.connections || []).map((connection) => `
          <option value="${connection.id}">${escapeHtml(connection.sourceType)} (${escapeHtml(connection.mode)})</option>
        `).join("");

        panel.innerHTML = `
          <div class="line-actions" style="margin-bottom:8px;">
            <select id="tablesSelect" class="line-btn" style="min-width:200px;">${tableOptions || '<option value="">No table</option>'}</select>
            <button id="newTableBtn" class="line-btn" type="button">New table</button>
            <button id="saveTableRowsBtn" class="line-btn" type="button">Save row edits</button>
          </div>
          <div class="line-actions" style="margin-bottom:8px;">
            <select id="tableImportConnection" class="line-btn" style="min-width:220px;">${connectionOptions || '<option value="">No source connections</option>'}</select>
            <button id="importLiveQueryBtn" class="line-btn" type="button">Import live query</button>
          </div>
          <div class="table-grid-wrap">
            <table class="table-grid">
              <thead><tr>${header}</tr></thead>
              <tbody>${bodyRows}</tbody>
            </table>
          </div>
          <div class="line-actions" style="margin-top:8px; flex-wrap:wrap;">
            ${(columns.length ? columns : [{ key: "value" }]).map((col) => `
              <input class="line-btn table-new-row-input" data-col-key="${escapeAttr(col.key)}" placeholder="${escapeAttr(col.key)}" />
            `).join("")}
          </div>
        `;

        const select = document.getElementById("tablesSelect");
        if (select) {
          select.onchange = async () => {
            state.activeTableId = select.value || null;
            await loadTablesData();
            await renderDockTables();
          };
        }

        const newBtn = document.getElementById("newTableBtn");
        if (newBtn) {
          newBtn.onclick = async () => {
            const created = await api("/v1/workspace/tables", {
              method: "POST",
              body: {
                name: `Table ${new Date().toLocaleTimeString()}`,
                rows: [{ metric: "", value: "" }]
              }
            });
            state.activeTableId = created.table.id;
            await loadTablesData();
            await renderDockTables();
            toast("Table created");
          };
        }

        const saveBtn = document.getElementById("saveTableRowsBtn");
        if (saveBtn) {
          saveBtn.onclick = async () => {
            if (!state.activeTableId) {
              toast("Select a table first");
              return;
            }
            const row = {};
            panel.querySelectorAll(".table-new-row-input").forEach((input) => {
              const key = input.dataset.colKey;
              row[key] = input.value;
            });
            const hasAny = Object.values(row).some((value) => String(value || "").trim().length);
            if (!hasAny) {
              toast("Enter values for the new row");
              return;
            }
            await api(`/v1/workspace/tables/${encodeURIComponent(state.activeTableId)}/rows`, {
              method: "POST",
              body: { rows: [row] }
            });
            await loadTablesData();
            await renderDockTables();
            toast("Row added");
          };
        }

        const importBtn = document.getElementById("importLiveQueryBtn");
        if (importBtn) {
          importBtn.onclick = async () => {
            const connectionId = document.getElementById("tableImportConnection")?.value;
            if (!connectionId) {
              toast("Select a source connection");
              return;
            }
            const imported = await api("/v1/workspace/tables/import-live-query", {
              method: "POST",
              body: {
                connectionId,
                tableId: state.activeTableId || undefined,
                tableName: state.activeTableId ? undefined : "Imported dataset",
                query: { select: "*", limit: 50 }
              }
            });
            state.activeTableId = imported.table.id;
            await loadTablesData();
            await renderDockTables();
            toast(`Imported ${imported.insertedRows} row(s)`);
          };
        }
      }

      function renderRightAttachments() {
        const panel = document.getElementById("right-attachments");
        if (!panel) return;
        const totalFiles = state.folderAttachments.length;
        const totalThreads = new Set(
          state.folderAttachments.flatMap((asset) => asset.threadIds || [])
        ).size;
        const rows = state.folderAttachments.slice(0, 120).map((asset) => `
          <tr>
            <td>${escapeHtml(asset.name || "Attachment")}</td>
            <td>${escapeHtml(asset.mimeType || "file")}</td>
            <td>${Number(asset.threadIds?.length || 0)}</td>
            <td>
              <div class="line-actions" style="margin-top:0;">
                <button class="line-btn" type="button" data-right-open-doc="${escapeAttr(asset.attachmentId || asset.id)}">Open</button>
                <button class="line-btn" type="button" data-right-attach="${escapeAttr(asset.attachmentId || asset.id)}">Attach</button>
              </div>
            </td>
          </tr>
        `).join("") || '<tr><td colspan="4">No attachments yet</td></tr>';

        panel.innerHTML = `
          <div class="hf-stats" style="margin-bottom:8px;">
            <article class="hf-stat">
              <div class="hf-stat-kicker">Files</div>
              <div class="hf-stat-value">${totalFiles}</div>
              <div class="hf-stat-trend">active in current folder</div>
            </article>
            <article class="hf-stat">
              <div class="hf-stat-kicker">Threads</div>
              <div class="hf-stat-value">${totalThreads}</div>
              <div class="hf-stat-trend">linked with attachments</div>
            </article>
          </div>
          <div class="hf-table-wrap">
            <table class="hf-table">
              <thead>
                <tr><th>Name</th><th>Type</th><th>Threads</th><th>Actions</th></tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        `;

        panel.querySelectorAll("[data-right-open-doc]").forEach((button) => {
          button.onclick = async () => {
            state.selectedDockAttachmentId = button.dataset.rightOpenDoc;
            toggleDock("docs");
            if (state.dockOpen) await renderDockDocs();
          };
        });

        panel.querySelectorAll("[data-right-attach]").forEach((button) => {
          button.onclick = async () => {
            const attachmentId = button.dataset.rightAttach;
            if (!attachmentId) return;
            const exists = state.pendingAssets.find((asset) => asset.id === attachmentId);
            if (exists) return;
            const detail = await loadAttachmentDetail(attachmentId);
            const asset = detail.attachment;
            state.pendingAssets.push({ id: asset.id, name: asset.name, mimeType: asset.mimeType, size: asset.size });
            renderComposerChips();
            renderDockFiles();
            toast("Attachment queued");
          };
        });
      }

      function renderNotifications() {
        const panel = document.getElementById("right-notifications");
        if (!panel) return;
        const unreadCount = state.notifications.filter((item) => !item.read).length;
        const totalCount = state.notifications.length;
        const timelineRows = state.notifications.slice(0, 30).map((notification) => `
          <li class="hf-timeline-item">
            <button class="list-row" type="button" data-notification-id="${notification.id}" style="padding:0; margin:0; background:transparent;">
              <div class="hf-timeline-time">${escapeHtml(new Date(notification.createdAt).toLocaleString())}</div>
              <div class="hf-timeline-title">${escapeHtml(notification.title || notification.kind || "Notification")}${notification.read ? "" : " â€¢ unread"}</div>
              <div class="hf-timeline-copy">${escapeHtml(notification.kind || "event")}</div>
            </button>
          </li>
        `).join("") || '<li class="hf-timeline-item"><div class="hf-timeline-title">No notifications</div></li>';

        panel.innerHTML = `
          <div class="hf-stats" style="margin-bottom:8px;">
            <article class="hf-stat">
              <div class="hf-stat-kicker">Unread</div>
              <div class="hf-stat-value">${unreadCount}</div>
              <div class="hf-stat-trend">needs review</div>
            </article>
            <article class="hf-stat">
              <div class="hf-stat-kicker">Total events</div>
              <div class="hf-stat-value">${totalCount}</div>
              <div class="hf-stat-trend">recent activity</div>
            </article>
          </div>
          <div class="hf-acc-item" style="margin-bottom:8px;">
            <div class="hf-acc-body">
              <ol class="hf-timeline">
                ${timelineRows}
              </ol>
            </div>
          </div>
          <div class="hf-notes">
            <label for="rightRailNotes">Notes</label>
            <textarea id="rightRailNotes" placeholder="Log approvals, follow-ups, or reminders for this thread">${escapeHtml(state.rightRailNotes || "")}</textarea>
          </div>
        `;

        panel.querySelectorAll("[data-notification-id]").forEach((button) => {
          button.onclick = async () => {
            await api(`/v1/workspace/notifications/${encodeURIComponent(button.dataset.notificationId)}/read`, { method: "POST", body: {} });
            await loadSettings();
            renderNotifications();
          };
        });

        const notes = document.getElementById("rightRailNotes");
        if (notes) {
          notes.oninput = (event) => {
            state.rightRailNotes = event.target.value;
          };
        }
      }

      function renderModelMenus() {
        const modelMenu = document.getElementById("modelMenu");
        const effortMenu = document.getElementById("effortMenu");
        document.getElementById("modelMenuLabel").textContent = modelOptions.find((o) => o.value === state.selectedModelPreset)?.label || "Auto";
        document.getElementById("effortMenuLabel").textContent = effortOptions.find((o) => o.value === state.selectedEffort)?.label || "High";

        modelMenu.innerHTML = modelOptions.map((option) => `
          <button class="menu-option ${option.value === state.selectedModelPreset ? "active" : ""}" type="button" data-model-option="${option.value}">${escapeHtml(option.label)}</button>
        `).join("");

        effortMenu.innerHTML = effortOptions.map((option) => `
          <button class="menu-option ${option.value === state.selectedEffort ? "active" : ""}" type="button" data-effort-option="${option.value}">${escapeHtml(option.label)}</button>
        `).join("");

        modelMenu.querySelectorAll("[data-model-option]").forEach((button) => {
          button.onclick = () => {
            state.selectedModelPreset = button.dataset.modelOption;
            closeMenus();
            renderModelMenus();
          };
        });

        effortMenu.querySelectorAll("[data-effort-option]").forEach((button) => {
          button.onclick = () => {
            state.selectedEffort = button.dataset.effortOption;
            closeMenus();
            renderModelMenus();
          };
        });
      }

      function renderSettingsGeneral() {
        const root = document.getElementById("settings-general");
        if (!root || !state.settings) return;
        const general = state.settings.general || {};
        const agent = state.workspaceAgent || {};
        root.innerHTML = `
          <div class="hf-accordion">
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>Workspace identity</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </summary>
              <div class="hf-acc-body">
                <div class="field"><label>Tenant Name</label><input id="setGeneralName" value="${escapeAttr(general.name || "")}" /></div>
                <div class="row">
                  <div class="field"><label>Timezone</label><input id="setGeneralTimezone" value="${escapeAttr(general.timezone || "America/New_York")}" /></div>
                  <div class="field"><label>Locale</label><input id="setGeneralLocale" value="${escapeAttr(general.locale || "en-US")}" /></div>
                </div>
              </div>
            </details>
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>Workspace agent</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </summary>
              <div class="hf-acc-body">
                <div class="row">
                  <div class="field"><label>Agent name</label><input id="setWorkspaceAgentName" value="${escapeAttr(agent.name || "Titus")}" /></div>
                  <div class="field"><label>Mention aliases (comma separated)</label><input id="setWorkspaceAliases" value="${escapeAttr((agent.mentionAliases || ["titus"]).join(", "))}" /></div>
                </div>
                <div class="stamp" style="margin-top:6px;">Realtime sync: ${state.liveSyncEnabled ? "connected" : "offline"}</div>
              </div>
            </details>
          </div>
        `;
      }

      function renderSettingsConnections() {
        const root = document.getElementById("settings-connections");
        if (!root) return;
        const rows = state.connections.map((connection) => `
          <tr>
            <td>${escapeHtml(connection.sourceType)}</td>
            <td>${escapeHtml(connection.mode)}</td>
            <td>${escapeHtml(connection.status)}</td>
            <td>${Number(connection.syncPolicy?.intervalMinutes || 60)}m</td>
            <td>
              <div class="line-actions" style="margin-top:0;">
                <button class="line-btn" type="button" data-test-connection="${connection.id}">Test</button>
                <button class="line-btn" type="button" data-sync-connection="${connection.id}">Sync</button>
              </div>
            </td>
          </tr>
        `).join("") || '<tr><td colspan="5">No connections</td></tr>';

        root.innerHTML = `
          <div class="hf-accordion">
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>Quick add connectors</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </summary>
              <div class="hf-acc-body">
                <div class="line-actions">
                  <button id="quickConnectAdsBtn" class="line-btn" type="button">Google Ads</button>
                  <button id="quickConnectStripeBtn" class="line-btn" type="button">Stripe</button>
                </div>
              </div>
            </details>
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>Active connections</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </summary>
              <div class="hf-acc-body">
                <div class="hf-table-wrap">
                  <table class="hf-table">
                    <thead>
                      <tr><th>Source</th><th>Mode</th><th>Status</th><th>Sync</th><th>Actions</th></tr>
                    </thead>
                    <tbody>${rows}</tbody>
                  </table>
                </div>
              </div>
            </details>
          </div>
        `;

        document.getElementById("quickConnectAdsBtn").onclick = async () => {
          await api("/v1/integrations/quick-add", {
            method: "POST",
            body: { integrationKey: "google_ads", authRef: "quick_ads_token", runInitialSync: true, periodDays: 21 }
          });
          toast("Google Ads connected");
          await loadSettings();
          renderSettingsConnections();
        };

        document.getElementById("quickConnectStripeBtn").onclick = async () => {
          await api("/v1/integrations/quick-add", {
            method: "POST",
            body: { integrationKey: "stripe", authRef: "quick_stripe_token", runInitialSync: true, periodDays: 21 }
          });
          toast("Stripe connected");
          await loadSettings();
          renderSettingsConnections();
        };

        root.querySelectorAll("[data-test-connection]").forEach((button) => {
          button.onclick = async () => {
            const result = await api(`/v1/sources/connections/${encodeURIComponent(button.dataset.testConnection)}/test`, { method: "POST", body: {} });
            toast(`Test: ${result.status}`);
          };
        });

        root.querySelectorAll("[data-sync-connection]").forEach((button) => {
          button.onclick = async () => {
            await api(`/v1/sources/connections/${encodeURIComponent(button.dataset.syncConnection)}/sync`, { method: "POST", body: { periodDays: 14 } });
            toast("Sync complete");
            await loadSettings();
            renderSettingsConnections();
          };
        });
      }

      function renderSettingsModels() {
        const root = document.getElementById("settings-models");
        if (!root || !state.settings) return;
        const prefs = state.settings.modelPreferences || {};
        const providerHealthRows = state.modelProviderHealth.map((item) => `
          <tr>
            <td>${escapeHtml(item.provider || item.key || "provider")}</td>
            <td>${escapeHtml(item.status || "unknown")}</td>
            <td>${escapeHtml(item.updatedAt || "")}</td>
          </tr>
        `).join("") || '<tr><td colspan="3">No provider health records yet</td></tr>';

        root.innerHTML = `
          <div class="hf-accordion">
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>LLM configuration</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </summary>
              <div class="hf-acc-body">
                <div class="field"><label>Mode</label>
                  <div class="hf-radio-group">
                    <label class="hf-radio ${prefs.llmMode === "managed" ? "active" : ""}" data-llm-mode="managed">
                      <span class="hf-radio-title">Managed</span>
                      <span class="hf-radio-meta">Platform-managed provider keys</span>
                    </label>
                    <label class="hf-radio ${prefs.llmMode === "byo" ? "active" : ""}" data-llm-mode="byo">
                      <span class="hf-radio-title">BYO</span>
                      <span class="hf-radio-meta">Use firm-managed key references</span>
                    </label>
                  </div>
                  <input id="setLlmMode" type="hidden" value="${escapeAttr(prefs.llmMode || "managed")}" />
                </div>
                <div class="row">
                  <div class="field"><label>Default Provider</label><input id="setDefaultProvider" value="${escapeAttr(prefs.defaultProvider || "managed")}" /></div>
                  <div class="field"><label>Failover Chain</label><input id="setFailoverChain" value="${escapeAttr((prefs.failoverChain || []).join(", "))}" /></div>
                </div>
                <div class="field"><label>BYO Key Refs (comma separated)</label><input id="setByoRefs" value="${escapeAttr((prefs.byoKeyRefs || []).join(", "))}" /></div>
              </div>
            </details>
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>Provider health</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </summary>
              <div class="hf-acc-body">
                <div class="line-actions" style="margin-bottom:8px;">
                  <button id="refreshProviderHealthBtn" class="line-btn" type="button">Refresh provider health</button>
                </div>
                <div class="hf-table-wrap">
                  <table class="hf-table">
                    <thead>
                      <tr><th>Provider</th><th>Status</th><th>Updated</th></tr>
                    </thead>
                    <tbody>${providerHealthRows}</tbody>
                  </table>
                </div>
              </div>
            </details>
          </div>
        `;

        root.querySelectorAll("[data-llm-mode]").forEach((button) => {
          button.onclick = () => {
            const value = button.dataset.llmMode;
            const hidden = document.getElementById("setLlmMode");
            if (hidden) hidden.value = value;
            root.querySelectorAll("[data-llm-mode]").forEach((item) => item.classList.toggle("active", item.dataset.llmMode === value));
          };
        });

        const refresh = document.getElementById("refreshProviderHealthBtn");
        if (refresh) {
          refresh.onclick = async () => {
            const healthRes = await api("/v1/models/providers/health");
            state.modelProviderHealth = healthRes.health || [];
            renderSettingsModels();
          };
        }
      }

      function renderSettingsAnalysisProfiles() {
        const root = document.getElementById("settings-analysis-profiles");
        if (!root) return;

        const rows = (state.profiles || []).map((profile) => `
          <tr>
            <td>${escapeHtml(profile.name)} ${profile.active ? "(active)" : ""}</td>
            <td>${escapeHtml(profile.objective)}</td>
            <td>${escapeHtml(profile.provider)}</td>
            <td>${Number(profile.horizonDays)}d</td>
            <td>
              <button class="line-btn" type="button" data-activate-profile="${profile.id}">Activate</button>
            </td>
          </tr>
        `).join("") || '<tr><td colspan="5">No analysis profiles</td></tr>';

        root.innerHTML = `
          <div class="hf-accordion">
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>Profile library</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </summary>
              <div class="hf-acc-body">
                <div class="line-actions" style="margin-bottom:8px;">
                  <button id="createProfileBtn" class="line-btn" type="button">New profile</button>
                </div>
                <div class="hf-table-wrap">
                  <table class="hf-table">
                    <thead>
                      <tr><th>Name</th><th>Objective</th><th>Provider</th><th>Horizon</th><th>Actions</th></tr>
                    </thead>
                    <tbody>${rows}</tbody>
                  </table>
                </div>
              </div>
            </details>
          </div>
        `;

        const create = document.getElementById("createProfileBtn");
        if (create) {
          create.onclick = async () => {
            const created = await api("/v1/models/profiles", {
              method: "POST",
              body: {
                name: "Custom Profile",
                objective: "forecast",
                targetMetricId: "revenue",
                horizonDays: 14,
                provider: "managed",
                params: { confidenceTarget: 0.78 },
                active: false
              }
            });
            toast(`Profile created: ${created.profile.name}`);
            await loadSettings();
            renderSettingsAnalysisProfiles();
          };
        }

        root.querySelectorAll("[data-activate-profile]").forEach((button) => {
          button.onclick = async () => {
            await api(`/v1/models/profiles/${encodeURIComponent(button.dataset.activateProfile)}/activate`, { method: "POST", body: {} });
            toast("Profile activated");
            await loadSettings();
            renderSettingsAnalysisProfiles();
          };
        });
      }

      function renderSettingsTraining() {
        const root = document.getElementById("settings-training");
        if (!root || !state.settings) return;
        const training = state.settings.training || {};
        const memory = training.memoryPolicy || {};
        root.innerHTML = `
          <div class="hf-accordion">
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>Training controls</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </summary>
              <div class="hf-acc-body">
                <div class="row">
                  <div class="field">
                    <label>Training opt-in</label>
                    <select id="setTrainingOptIn">
                      <option value="false" ${training.optIn ? "" : "selected"}>Disabled</option>
                      <option value="true" ${training.optIn ? "selected" : ""}>Enabled</option>
                    </select>
                  </div>
                  <div class="field">
                    <label>Tenant fine-tuning</label>
                    <select id="setTrainingFineTune">
                      <option value="false" ${training.allowTenantFineTuning ? "" : "selected"}>Disabled</option>
                      <option value="true" ${training.allowTenantFineTuning ? "selected" : ""}>Enabled</option>
                    </select>
                  </div>
                </div>
                <div class="row">
                  <div class="field"><label>Training interval (hours)</label><input id="setTrainingInterval" type="number" min="1" value="${Number(training.schedule?.intervalHours || 24)}" /></div>
                  <div class="field"><label>Exclude private chats</label>
                    <select id="setTrainingExcludePrivate">
                      <option value="true" ${memory.excludePrivate !== false ? "selected" : ""}>Yes</option>
                      <option value="false" ${memory.excludePrivate === false ? "selected" : ""}>No</option>
                    </select>
                  </div>
                </div>
              </div>
            </details>
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>Memory weighting</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </summary>
              <div class="hf-acc-body">
                <div class="row">
                  <div class="field"><label>Project memory weight</label><input id="setProjectMemoryWeight" type="number" min="0" max="1" step="0.05" value="${Number(memory.projectWeight ?? 0.7)}" /></div>
                  <div class="field"><label>User memory weight</label><input id="setUserMemoryWeight" type="number" min="0" max="1" step="0.05" value="${Number(memory.userWeight ?? 0.3)}" /></div>
                </div>
                <div class="field"><label>Retention days</label><input id="setMemoryRetentionDays" type="number" min="1" value="${Number(memory.retentionDays ?? 60)}" /></div>
              </div>
            </details>
          </div>
        `;
      }

      function renderSettingsReports() {
        const root = document.getElementById("settings-reports");
        if (!root) return;
        const templateRows = (state.reportTemplates || []).map((template) => `
          <tr>
            <td>${escapeHtml(template.name)} v${Number(template.version || 1)} ${template.active ? "(active)" : ""}</td>
            <td>${escapeHtml(template.reportTypeId || template.objective || template.domain || "general")}</td>
            <td>${escapeHtml((template.variables || []).join(", ") || "none")}</td>
            <td>
              <div class="line-actions" style="margin-top:0;">
                <button class="line-btn" type="button" data-preview-template="${template.id}">Preview</button>
                <button class="line-btn" type="button" data-activate-template="${template.id}">Activate</button>
              </div>
            </td>
          </tr>
        `).join("") || '<tr><td colspan="4">No templates uploaded</td></tr>';

        root.innerHTML = `
          <div class="hf-accordion">
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>Template upload</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </summary>
              <div class="hf-acc-body">
                <div class="field"><label>Name</label><input id="newTemplateName" placeholder="Executive default" /></div>
                <div class="field"><label>Markdown template</label><textarea id="newTemplateBody" placeholder="## Summary\n{{summary}}\n\n## Actions\n{{actions}}"></textarea></div>
                <div class="row">
                  <div class="field"><label>Report type id (optional)</label><input id="newTemplateReportType" placeholder="report_type_xxx" /></div>
                  <div class="field"><label>Objective (optional)</label><input id="newTemplateObjective" placeholder="forecast" /></div>
                </div>
                <div class="line-actions">
                  <button id="uploadTemplateBtn" class="line-btn" type="button">Upload template</button>
                </div>
              </div>
            </details>
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>Template registry</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </summary>
              <div class="hf-acc-body">
                <div class="hf-table-wrap">
                  <table class="hf-table">
                    <thead><tr><th>Template</th><th>Mapped to</th><th>Variables</th><th>Actions</th></tr></thead>
                    <tbody>${templateRows}</tbody>
                  </table>
                </div>
                <div id="templatePreviewBox" class="list-row" style="margin-top:8px;">Select Preview to compile sample output.</div>
              </div>
            </details>
          </div>
        `;

        const uploadBtn = document.getElementById("uploadTemplateBtn");
        if (uploadBtn) {
          uploadBtn.onclick = async () => {
            const name = document.getElementById("newTemplateName")?.value?.trim();
            const body = document.getElementById("newTemplateBody")?.value || "";
            if (!name || !body.trim()) {
              toast("Template name and body are required");
              return;
            }
            await api("/v1/reports/templates/upload", {
              method: "POST",
              body: {
                name,
                body,
                reportTypeId: document.getElementById("newTemplateReportType")?.value?.trim() || null,
                objective: document.getElementById("newTemplateObjective")?.value?.trim() || null
              }
            });
            await loadSettings();
            renderSettingsReports();
            toast("Template uploaded");
          };
        }

        root.querySelectorAll("[data-activate-template]").forEach((button) => {
          button.onclick = async () => {
            await api(`/v1/reports/templates/${encodeURIComponent(button.dataset.activateTemplate)}/activate`, {
              method: "POST",
              body: {}
            });
            await loadSettings();
            renderSettingsReports();
            toast("Template activated");
          };
        });

        root.querySelectorAll("[data-preview-template]").forEach((button) => {
          button.onclick = async () => {
            const preview = await api(`/v1/reports/templates/${encodeURIComponent(button.dataset.previewTemplate)}/preview`, {
              method: "POST",
              body: {
                context: {
                  summary: "Pipeline health is stable with improving conversion.",
                  actions: "- Prioritize stalled enterprise renewals\n- Increase outreach on week-2 cohorts"
                }
              }
            });
            const box = document.getElementById("templatePreviewBox");
            if (!box) return;
            box.innerHTML = `<pre style="white-space:pre-wrap; font-size:12px; margin:0;">${escapeHtml(preview.compiled || "")}</pre>`;
          };
        });
      }

      function renderSettingsChannels() {
        const root = document.getElementById("settings-channels");
        if (!root || !state.settings) return;
        const channels = state.settings.channels || {};
        root.innerHTML = `
          <div class="hf-accordion">
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>Slack</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </summary>
              <div class="hf-acc-body">
                <div class="field"><label>Webhook Ref</label><input id="setSlackRef" value="${escapeAttr(channels.slack?.webhookRef || "")}" /></div>
              </div>
            </details>
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>Telegram</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </summary>
              <div class="hf-acc-body">
                <div class="row">
                  <div class="field"><label>Bot Token Ref</label><input id="setTelegramToken" value="${escapeAttr(channels.telegram?.botTokenRef || "")}" /></div>
                  <div class="field"><label>Chat ID</label><input id="setTelegramChat" value="${escapeAttr(channels.telegram?.chatId || "")}" /></div>
                </div>
              </div>
            </details>
          </div>
        `;
      }

      function renderSettingsTeam() {
        const root = document.getElementById("settings-team");
        if (!root) return;
        const members = (state.team || []).map((member) => `
          <tr>
            <td><span style="color:${memberColor(member.id)};">${escapeHtml(member.name)}</span></td>
            <td>${escapeHtml(member.role)}</td>
            <td>${escapeHtml(member.email || "")}</td>
          </tr>
        `).join("") || '<tr><td colspan="3">No members</td></tr>';
        root.innerHTML = `
          <div class="hf-accordion">
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>Add team member</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </summary>
              <div class="hf-acc-body">
                <div class="row">
                  <div class="field"><label>Name</label><input id="newMemberName" placeholder="Name" /></div>
                  <div class="field"><label>Email</label><input id="newMemberEmail" placeholder="name@firm.com" /></div>
                  <div class="field"><label>Role</label>
                    <select id="newMemberRole">
                      <option value="analyst">analyst</option>
                      <option value="operator">operator</option>
                      <option value="admin">admin</option>
                      <option value="owner">owner</option>
                      <option value="viewer">viewer</option>
                    </select>
                  </div>
                </div>
                <div class="line-actions"><button id="addMemberBtn" class="line-btn" type="button">Add member</button></div>
              </div>
            </details>
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>Current team</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </summary>
              <div class="hf-acc-body">
                <div class="hf-table-wrap">
                  <table class="hf-table">
                    <thead>
                      <tr><th>Name</th><th>Role</th><th>Email</th></tr>
                    </thead>
                    <tbody>${members}</tbody>
                  </table>
                </div>
              </div>
            </details>
          </div>
        `;

        const addBtn = document.getElementById("addMemberBtn");
        if (addBtn) {
          addBtn.onclick = async () => {
            const name = document.getElementById("newMemberName")?.value.trim();
            const email = document.getElementById("newMemberEmail")?.value.trim();
            const role = document.getElementById("newMemberRole")?.value;
            if (!name || !email) {
              toast("Name and email are required");
              return;
            }
            await api("/v1/settings/team", { method: "POST", body: { name, email, role, title: "Team Member" } });
            toast("Member added");
            await loadSettings();
            renderSettingsTeam();
          };
        }
      }

      function renderSettingsSkills() {
        const root = document.getElementById("settings-skills");
        if (!root) return;
        const rows = (state.installedSkills || []).map((skill) => `
          <tr>
            <td>${escapeHtml(skill.id)}</td>
            <td>${skill.active ? "active" : "inactive"}</td>
            <td>${escapeHtml(skill.source || "bundled")}</td>
            <td>
              <div class="line-actions" style="margin-top:0;">
                <button class="line-btn" type="button" data-skill-activate="${escapeAttr(skill.id)}">Activate</button>
                <button class="line-btn" type="button" data-skill-deactivate="${escapeAttr(skill.id)}">Deactivate</button>
              </div>
            </td>
          </tr>
        `).join("") || '<tr><td colspan="4">No skills installed</td></tr>';

        root.innerHTML = `
          <div class="hf-accordion">
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>Install packs</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </summary>
              <div class="hf-acc-body">
                <div class="line-actions">
                  <button id="installMarketingSkillBtn" class="line-btn" type="button">Install marketing skill</button>
                  <button id="installFinanceSkillBtn" class="line-btn" type="button">Install finance skill</button>
                </div>
              </div>
            </details>
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>Installed skills</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </summary>
              <div class="hf-acc-body">
                <div class="hf-table-wrap">
                  <table class="hf-table">
                    <thead>
                      <tr><th>Skill</th><th>Status</th><th>Source</th><th>Actions</th></tr>
                    </thead>
                    <tbody>${rows}</tbody>
                  </table>
                </div>
              </div>
            </details>
          </div>
        `;

        const mk = document.getElementById("installMarketingSkillBtn");
        if (mk) mk.onclick = async () => {
          await api("/v1/skills/install", { method: "POST", body: { skillId: "marketing-optimizer", active: true } });
          toast("Marketing skill installed");
          await loadSettings();
          renderSettingsSkills();
        };

        const fk = document.getElementById("installFinanceSkillBtn");
        if (fk) fk.onclick = async () => {
          await api("/v1/skills/install", { method: "POST", body: { skillId: "finance-forecast-analyst", active: true } });
          toast("Finance skill installed");
          await loadSettings();
          renderSettingsSkills();
        };

        root.querySelectorAll("[data-skill-activate]").forEach((button) => {
          button.onclick = async () => {
            await api(`/v1/skills/${encodeURIComponent(button.dataset.skillActivate)}/activate`, { method: "POST", body: {} });
            toast("Skill activated");
            await loadSettings();
            renderSettingsSkills();
          };
        });

        root.querySelectorAll("[data-skill-deactivate]").forEach((button) => {
          button.onclick = async () => {
            await api(`/v1/skills/${encodeURIComponent(button.dataset.skillDeactivate)}/deactivate`, { method: "POST", body: {} });
            toast("Skill deactivated");
            await loadSettings();
            renderSettingsSkills();
          };
        });
      }

      function renderSettingsAutomations() {
        const root = document.getElementById("settings-automations");
        if (!root) return;
        const folder = state.folders.find((item) => item.id === state.activeFolderId);
        const selectedAutomation = state.automations.find((item) => item.id === state.selectedAutomationId) || null;
        const rows = (state.automations || []).map((automation) => `
          <tr>
            <td>${escapeHtml(automation.name)}</td>
            <td>${automation.enabled ? "on" : "off"}</td>
            <td>${escapeHtml(automation.triggerType)}</td>
            <td>${escapeHtml(automation.actionType)}</td>
            <td>
              <div class="line-actions" style="margin-top:0;">
                <button class="line-btn" type="button" data-edit-heartbeat="${automation.id}">Heartbeat</button>
                <button class="line-btn" type="button" data-run-automation="${automation.id}">Run</button>
                <button class="line-btn" type="button" data-toggle-automation="${automation.id}:${automation.enabled ? "off" : "on"}">${automation.enabled ? "Disable" : "Enable"}</button>
              </div>
            </td>
          </tr>
        `).join("") || '<tr><td colspan="5">No automations</td></tr>';

        root.innerHTML = `
          <div class="hf-accordion">
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>Folder context</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </summary>
              <div class="hf-acc-body">
                <div class="hf-detail-list">
                  <div class="hf-detail-row">
                    <dt class="hf-detail-key">Folder</dt>
                    <dd class="hf-detail-val">${escapeHtml(folder?.name || "None")}</dd>
                  </div>
                </div>
                <div class="line-actions" style="margin-top:8px;">
                  <button id="createAutomationBtn" class="line-btn" type="button">New automation</button>
                </div>
              </div>
            </details>
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>Automation list</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </summary>
              <div class="hf-acc-body">
                <div class="hf-table-wrap">
                  <table class="hf-table">
                    <thead>
                      <tr><th>Name</th><th>Status</th><th>Trigger</th><th>Action</th><th>Controls</th></tr>
                    </thead>
                    <tbody>${rows}</tbody>
                  </table>
                </div>
              </div>
            </details>
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>heartbeat.md editor</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </summary>
              <div class="hf-acc-body">
                ${selectedAutomation ? `
                  <div class="stamp" style="margin-bottom:8px;">Editing: ${escapeHtml(selectedAutomation.name)} (${escapeHtml(selectedAutomation.id)})</div>
                  <div class="field">
                    <label>Heartbeat content</label>
                    <textarea id="heartbeatContent" style="min-height:160px;" placeholder="---\nenabled: true\nintervalMinutes: 5\ntriggers:\n  - id: stale_sync\n    when: source_freshness_hours(connection) > 6\n    action: run_agent_job\n---">${escapeHtml(state.heartbeatByAutomationId[selectedAutomation.id]?.content || selectedAutomation.heartbeatContent || "")}</textarea>
                  </div>
                  <div class="line-actions">
                    <button id="heartbeatValidateBtn" class="line-btn" type="button">Validate</button>
                    <button id="heartbeatSaveBtn" class="line-btn" type="button">Save</button>
                    <button id="heartbeatExportBtn" class="line-btn" type="button">Export heartbeat.md</button>
                  </div>
                  <div id="heartbeatValidationOutput" class="list-row" style="margin-top:8px;">Run validation to inspect parse errors and trigger preview.</div>
                ` : '<div class="list-row">Select or create an automation to manage heartbeat triggers.</div>'}
              </div>
            </details>
          </div>
        `;

        const create = document.getElementById("createAutomationBtn");
        if (create) {
          create.onclick = async () => {
            if (!state.activeFolderId) {
              toast("Select a folder first");
              return;
            }
            await api(`/v1/automations/folders/${encodeURIComponent(state.activeFolderId)}`, {
              method: "POST",
              body: {
                name: "Folder heartbeat",
                triggerType: "cron",
                intervalMinutes: 30,
                actionType: "run_agent_job",
                actionPayload: { objective: "automation_followup" },
                targetThreadId: state.activeThreadId || null
              }
            });
            toast("Automation created");
            await loadAutomationsForActiveFolder();
            renderSettingsAutomations();
          };
        }

        root.querySelectorAll("[data-run-automation]").forEach((button) => {
          button.onclick = async () => {
            await api(`/v1/automations/${encodeURIComponent(button.dataset.runAutomation)}/run`, { method: "POST", body: {} });
            toast("Automation run posted");
            await loadSettings();
            await loadAutomationsForActiveFolder();
            renderSettingsAutomations();
          };
        });

        root.querySelectorAll("[data-toggle-automation]").forEach((button) => {
          button.onclick = async () => {
            const [automationId, next] = String(button.dataset.toggleAutomation || "").split(":");
            await api(`/v1/automations/${encodeURIComponent(automationId)}`, { method: "PATCH", body: { enabled: next === "on" } });
            toast(next === "on" ? "Automation enabled" : "Automation disabled");
            await loadAutomationsForActiveFolder();
            renderSettingsAutomations();
          };
        });

        root.querySelectorAll("[data-edit-heartbeat]").forEach((button) => {
          button.onclick = async () => {
            state.selectedAutomationId = button.dataset.editHeartbeat;
            if (!state.heartbeatByAutomationId[state.selectedAutomationId]) {
              try {
                const heartbeat = await api(`/v1/automations/${encodeURIComponent(state.selectedAutomationId)}/heartbeat`);
                state.heartbeatByAutomationId[state.selectedAutomationId] = heartbeat.heartbeat;
              } catch {}
            }
            renderSettingsAutomations();
          };
        });

        const validateBtn = document.getElementById("heartbeatValidateBtn");
        if (validateBtn && selectedAutomation) {
          validateBtn.onclick = async () => {
            const content = document.getElementById("heartbeatContent")?.value || "";
            const validated = await api("/v1/automations/heartbeat/validate", {
              method: "POST",
              body: { content }
            });
            const output = document.getElementById("heartbeatValidationOutput");
            if (output) {
              output.innerHTML = validated.ok
                ? '<span class="stamp">Valid heartbeat config</span>'
                : `<pre style="white-space:pre-wrap; margin:0;">${escapeHtml((validated.errors || []).join("\n"))}</pre>`;
            }
          };
        }

        const saveBtn = document.getElementById("heartbeatSaveBtn");
        if (saveBtn && selectedAutomation) {
          saveBtn.onclick = async () => {
            const content = document.getElementById("heartbeatContent")?.value || "";
            const saved = await api(`/v1/automations/${encodeURIComponent(selectedAutomation.id)}/heartbeat`, {
              method: "PATCH",
              body: {
                content,
                targetThreadId: state.activeThreadId || selectedAutomation.targetThreadId || null
              }
            });
            state.heartbeatByAutomationId[selectedAutomation.id] = saved.heartbeat;
            toast(saved.heartbeat.valid ? "Heartbeat saved" : "Saved with validation warnings");
            renderSettingsAutomations();
          };
        }

        const exportBtn = document.getElementById("heartbeatExportBtn");
        if (exportBtn && selectedAutomation) {
          exportBtn.onclick = async () => {
            const content = document.getElementById("heartbeatContent")?.value || "";
            const exported = await api(`/v1/automations/${encodeURIComponent(selectedAutomation.id)}/heartbeat/export`, {
              method: "POST",
              body: { content }
            });
            toast(`Exported to ${exported.path || "heartbeat.md"}`);
          };
        }
      }

      function renderSettingsPolicies() {
        const root = document.getElementById("settings-policies");
        if (!root || !state.settings) return;
        const policies = state.settings.policies || {};
        root.innerHTML = `
          <div class="hf-accordion">
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>Runtime policy</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </summary>
              <div class="hf-acc-body">
                <div class="field"><label>Autonomy Mode</label>
                  <div class="hf-radio-group">
                    <label class="hf-radio ${policies.autonomyMode === "manual" ? "active" : ""}" data-autonomy-mode="manual">
                      <span class="hf-radio-title">Manual</span>
                      <span class="hf-radio-meta">Human approvals for actions</span>
                    </label>
                    <label class="hf-radio ${policies.autonomyMode === "policy-gated" ? "active" : ""}" data-autonomy-mode="policy-gated">
                      <span class="hf-radio-title">Policy-gated</span>
                      <span class="hf-radio-meta">Auto-execute within policy bounds</span>
                    </label>
                  </div>
                  <input id="setAutonomyMode" type="hidden" value="${escapeAttr(policies.autonomyMode || "policy-gated")}" />
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; justify-content:space-between;">
                    <span>Kill Switch</span>
                    <span class="hf-toggle">
                      <input id="setKillSwitchToggle" type="checkbox" ${policies.killSwitch ? "checked" : ""} />
                      <span class="hf-toggle-track"><span class="hf-toggle-knob"></span></span>
                    </span>
                  </label>
                </div>
              </div>
            </details>
            <details class="hf-acc-item" open>
              <summary class="hf-acc-summary">
                <span>Guardrails</span>
                <svg class="hf-acc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </summary>
              <div class="hf-acc-body">
                <div class="row">
                  <div class="field"><label>Confidence Threshold</label><input id="setConfidence" type="number" min="0" max="1" step="0.01" value="${Number(policies.confidenceThreshold ?? 0.76)}" /></div>
                  <div class="field"><label>Budget Guardrail USD</label><input id="setBudget" type="number" value="${Number(policies.budgetGuardrailUsd ?? 10000)}" /></div>
                </div>
              </div>
            </details>
          </div>
        `;

        root.querySelectorAll("[data-autonomy-mode]").forEach((button) => {
          button.onclick = () => {
            const value = button.dataset.autonomyMode;
            const hidden = document.getElementById("setAutonomyMode");
            if (hidden) hidden.value = value;
            root.querySelectorAll("[data-autonomy-mode]").forEach((item) => item.classList.toggle("active", item.dataset.autonomyMode === value));
          };
        });
      }

      function renderSettings() {
        renderSettingsGeneral();
        renderSettingsConnections();
        renderSettingsModels();
        renderSettingsAnalysisProfiles();
        renderSettingsTraining();
        renderSettingsReports();
        renderSettingsChannels();
        renderSettingsTeam();
        renderSettingsSkills();
        renderSettingsAutomations();
        renderSettingsPolicies();
      }

      function renderAll() {
        renderThreadTree();
        renderFeed();
        renderComposerChips();
        renderDockFiles();
        renderDockDocs();
        renderDockTables();
        renderRightAttachments();
        renderNotifications();
        renderSettings();
        renderModelMenus();

        document.getElementById("askAiToggle")?.classList.toggle("active", state.askAi);
        document.getElementById("privateToggle")?.classList.toggle("active", state.privateAi);

        const unread = state.notifications.filter((item) => !item.read).length;
        const notifBtn = document.querySelector('[data-right-tab="notifications"]');
        if (notifBtn) notifBtn.title = unread ? `Notifications (${unread})` : "Notifications";
      }

      async function ensureActiveThread() {
        if (state.activeThreadId) return;
        let folderId = state.activeFolderId || state.folders[0]?.id;
        if (!folderId) {
          const folderRes = await api("/v1/workspace/folders", { method: "POST", body: { name: "General" } });
          folderId = folderRes.folder.id;
          state.activeFolderId = folderId;
        }
        const threadRes = await api("/v1/workspace/threads", {
          method: "POST",
          body: { folderId, title: "New thread" }
        });
        state.activeThreadId = threadRes.thread.id;
      }

      async function uploadAttachmentFile(file) {
        const form = new FormData();
        form.append("file", file, file.name);
        const response = await fetch("/v1/workspace/attachments/upload", {
          method: "POST",
          headers: headers({}, false),
          body: form
        });
        const payload = await response.json().catch(() => ({}));
        if (!response.ok) throw new Error(payload.error || "Upload failed");
        return payload;
      }

      async function sendMessage(text) {
        await ensureActiveThread();
        const invokeAiMode = state.askAi ? "explicit" : "auto";
        const payload = {
          body: text,
          visibility: "shared",
          authorType: "user",
          authorName: state.team.find((m) => m.id === state.currentUserId)?.name || "User",
          attachmentIds: state.pendingAssets.map((asset) => asset.id),
          parentMessageId: state.replyToMessageId || null,
          invokeAiMode,
          aiVisibility: state.privateAi ? "private" : "shared"
        };
        const message = await api(`/v1/workspace/chat/threads/${encodeURIComponent(state.activeThreadId)}/messages`, {
          method: "POST",
          body: payload
        });

        state.pendingAssets = [];
        state.replyToMessageId = null;
        document.getElementById("composerInput").placeholder = "Message team. Mention @Titus or enable Ask AI.";
        if (message.aiMessage) {
          delete state.aiWorkingByThread[state.activeThreadId];
        } else if (state.askAi || hasAgentMention(text)) {
          state.aiWorkingByThread[state.activeThreadId] = {
            messageId: message.message?.id || "",
            agentName: state.workspaceAgent?.name || "Titus",
            createdAt: new Date().toISOString()
          };
        }
        await loadThreadData();
        renderAll();
        scheduleRefresh("settings", 120);
      }

      function openQuickModal(mode) {
        const modal = document.getElementById("quickModal");
        const title = document.getElementById("quickModalTitle");
        const label = document.getElementById("quickModalLabel");
        const input = document.getElementById("quickModalInput");
        const confirm = document.getElementById("quickModalConfirm");
        state.quickModal.open = true;
        state.quickModal.mode = mode;
        state.quickModal.title = mode === "create-folder" ? "Create Folder" : "Create Thread";
        state.quickModal.label = mode === "create-folder" ? "Folder name" : "Thread title";
        state.quickModal.placeholder = mode === "create-folder" ? "New folder" : "New thread";
        state.quickModal.confirmLabel = "Create";
        state.quickModal.value = "";
        state.quickModal.error = "";
        if (title) title.textContent = state.quickModal.title;
        if (label) label.textContent = state.quickModal.label;
        if (confirm) confirm.textContent = state.quickModal.confirmLabel;
        if (input) {
          input.value = "";
          input.placeholder = state.quickModal.placeholder;
        }
        if (modal) {
          modal.classList.add("open");
          modal.setAttribute("aria-hidden", "false");
        }
        setTimeout(() => input?.focus(), 0);
      }

      function closeQuickModal() {
        const modal = document.getElementById("quickModal");
        const activeEl = document.activeElement;
        if (activeEl && typeof activeEl.blur === "function") activeEl.blur();
        state.quickModal.open = false;
        state.quickModal.mode = null;
        if (modal) {
          modal.classList.remove("open");
          modal.setAttribute("aria-hidden", "true");
        }
      }

      async function submitQuickModal() {
        const input = document.getElementById("quickModalInput");
        const rawValue = String(input?.value ?? "").trim();
        if (!rawValue) {
          toast("Name is required");
          input?.focus();
          return;
        }
        const value = rawValue.slice(0, 96);
        if (state.quickModal.mode === "create-folder") {
          await api("/v1/workspace/folders", { method: "POST", body: { name: value } });
          await loadThreads();
          await loadFolderAttachments();
          closeQuickModal();
          renderAll();
          toast("Folder created");
          return;
        }
        if (state.quickModal.mode === "create-thread") {
          const folderId = state.activeFolderId || state.folders[0]?.id;
          if (!folderId) {
            toast("Create a folder first");
            return;
          }
          await api("/v1/workspace/threads", { method: "POST", body: { folderId, title: value } });
          await loadThreads();
          const created = state.threads.find((thread) => thread.title === value && thread.folderId === folderId);
          if (created) {
            state.activeThreadId = created.id;
            state.activeFolderId = created.folderId;
          }
          await loadThreadData();
          closeQuickModal();
          renderAll();
          toast("Thread created");
        }
      }

      async function createFolder() {
        openQuickModal("create-folder");
      }

      async function createThread() {
        const folderId = state.activeFolderId || state.folders[0]?.id;
        if (!folderId) {
          toast("Create a folder first");
          return;
        }
        openQuickModal("create-thread");
      }

      async function createRun() {
        const source = state.connections[0];
        const profile = state.profiles.find((item) => item.active) || state.profiles[0];
        const reportType = state.reportTypes[0];
        if (!source || !profile || !reportType) {
          toast("Need source, profile, and report type");
          return;
        }
        const created = await api("/v1/analysis-runs", {
          method: "POST",
          body: {
            sourceConnectionId: source.id,
            modelProfileId: profile.id,
            reportTypeId: reportType.id,
            folderId: state.activeFolderId,
            threadId: state.activeThreadId,
            channels: ["email"]
          }
        });
        toast(`Run created: ${created.run.id}`);
        await loadSettings();
        renderAll();
      }

      function findLatestRunByStatus(status) {
        return state.runs
          .slice()
          .sort((a, b) => (a.updatedAt < b.updatedAt ? 1 : -1))
          .find((run) => run.status === status) || null;
      }

      async function executeRun() {
        const run = findLatestRunByStatus("draft");
        if (!run) {
          toast("No draft run available");
          return;
        }
        await api(`/v1/analysis-runs/${encodeURIComponent(run.id)}/execute`, {
          method: "POST",
          body: { forceSync: true }
        });
        toast("Run executed");
        await loadSettings();
        renderAll();
      }

      async function deliverRun() {
        const run = findLatestRunByStatus("completed");
        if (!run) {
          toast("No completed run available");
          return;
        }
        await api(`/v1/analysis-runs/${encodeURIComponent(run.id)}/deliver`, {
          method: "POST",
          body: { channels: ["email"] }
        });
        toast("Run delivered");
        await loadSettings();
        renderAll();
      }

      async function saveSettingsForActiveTab() {
        const tab = state.settingsTab;
        if (tab === "general") {
          await api("/v1/settings/general", {
            method: "PATCH",
            body: {
              name: document.getElementById("setGeneralName")?.value || "",
              timezone: document.getElementById("setGeneralTimezone")?.value || "America/New_York",
              locale: document.getElementById("setGeneralLocale")?.value || "en-US"
            }
          });
          const aliases = String(document.getElementById("setWorkspaceAliases")?.value || "")
            .split(",")
            .map((item) => item.trim().toLowerCase())
            .filter(Boolean);
          await api("/v1/settings/workspace-agent", {
            method: "PATCH",
            body: {
              name: document.getElementById("setWorkspaceAgentName")?.value || "Titus",
              mentionAliases: aliases.length ? aliases : ["titus"]
            }
          });
        } else if (tab === "models") {
          const byoRefs = String(document.getElementById("setByoRefs")?.value || "")
            .split(",")
            .map((item) => item.trim())
            .filter(Boolean);
          const failoverChain = String(document.getElementById("setFailoverChain")?.value || "")
            .split(",")
            .map((item) => item.trim())
            .filter(Boolean);
          await api("/v1/settings/model-preferences", {
            method: "PATCH",
            body: {
              llmMode: document.getElementById("setLlmMode")?.value || "managed",
              defaultProvider: document.getElementById("setDefaultProvider")?.value || "managed",
              byoKeyRefs: byoRefs,
              failoverChain
            }
          });
        } else if (tab === "training") {
          await api("/v1/settings/training", {
            method: "PATCH",
            body: {
              optIn: document.getElementById("setTrainingOptIn")?.value === "true",
              allowTenantFineTuning: document.getElementById("setTrainingFineTune")?.value === "true",
              schedule: {
                intervalHours: Number(document.getElementById("setTrainingInterval")?.value || 24)
              },
              memoryPolicy: {
                excludePrivate: document.getElementById("setTrainingExcludePrivate")?.value !== "false",
                projectWeight: Number(document.getElementById("setProjectMemoryWeight")?.value || 0.7),
                userWeight: Number(document.getElementById("setUserMemoryWeight")?.value || 0.3),
                retentionDays: Number(document.getElementById("setMemoryRetentionDays")?.value || 60)
              }
            }
          });
        } else if (tab === "reports") {
          toast("Use Upload/Activate actions inside this section");
        } else if (tab === "channels") {
          const slackRef = document.getElementById("setSlackRef")?.value.trim() || "";
          const tgToken = document.getElementById("setTelegramToken")?.value.trim() || "";
          const tgChat = document.getElementById("setTelegramChat")?.value.trim() || "";
          await api("/v1/settings/channels", {
            method: "PATCH",
            body: {
              slack: { enabled: Boolean(slackRef), webhookRef: slackRef },
              telegram: { enabled: Boolean(tgToken && tgChat), botTokenRef: tgToken, chatId: tgChat }
            }
          });
        } else if (tab === "policies") {
          const killSwitchToggle = document.getElementById("setKillSwitchToggle");
          const killSwitchSelect = document.getElementById("setKillSwitch");
          await api("/v1/settings/policies", {
            method: "PATCH",
            body: {
              autonomyMode: document.getElementById("setAutonomyMode")?.value || "policy-gated",
              killSwitch: killSwitchToggle ? Boolean(killSwitchToggle.checked) : killSwitchSelect?.value === "true",
              confidenceThreshold: Number(document.getElementById("setConfidence")?.value || 0.76),
              budgetGuardrailUsd: Number(document.getElementById("setBudget")?.value || 10000)
            }
          });
        }

        toast("Saved");
        await loadSettings();
        renderSettings();
        renderFeed();
      }

      function applyAutoGrow() {
        const textarea = document.getElementById("composerInput");
        if (!textarea) return;
        textarea.style.height = "auto";
        const max = 172;
        const next = Math.min(textarea.scrollHeight, max);
        textarea.style.height = `${next}px`;
        textarea.style.overflowY = textarea.scrollHeight > max ? "auto" : "hidden";
      }

      function bindEvents() {
        document.getElementById("topLeftToggle").onclick = () => setLeftOpen(!document.getElementById("app").classList.contains("left-open"));
        document.getElementById("topRightToggle").onclick = () => setRightOpen(!document.getElementById("app").classList.contains("right-open"));
        const leftEdgeToggle = document.getElementById("leftEdgeToggle");
        const rightEdgeToggle = document.getElementById("rightEdgeToggle");
        leftEdgeToggle.onpointerdown = (event) => {
          event.preventDefault();
          setLeftOpen(!document.getElementById("app").classList.contains("left-open"));
        };
        rightEdgeToggle.onpointerdown = (event) => {
          event.preventDefault();
          setRightOpen(!document.getElementById("app").classList.contains("right-open"));
        };
        leftEdgeToggle.onclick = (event) => event.preventDefault();
        rightEdgeToggle.onclick = (event) => event.preventDefault();
        document.getElementById("closeLeftBtn").onclick = () => setLeftOpen(false);
        document.getElementById("closeRightBtn").onclick = () => setRightOpen(false);

        document.getElementById("newThreadBtn").onclick = createThread;
        document.getElementById("newFolderBtn").onclick = createFolder;

        document.getElementById("openSettingsBtn").onclick = () => openSettings("general");
        document.getElementById("openAutomationsBtn").onclick = () => openSettings("automations");
        document.getElementById("openSkillsBtn").onclick = () => openSettings("skills");

        document.getElementById("openDockDocsBtn").onclick = () => {
          if (!state.docsFiles.length) {
            loadDocsData().catch(() => {});
          }
          toggleDock("docs");
          if (state.dockOpen) renderDockDocs();
        };
        document.getElementById("popoutBtn").onclick = () => window.open(window.location.href, "_blank", "noopener,noreferrer");

        document.querySelectorAll("[data-right-tab]").forEach((button) => {
          button.onclick = () => {
            setRightTab(button.dataset.rightTab);
            setRightOpen(true);
          };
        });

        document.querySelectorAll("[data-dock-tab]").forEach((button) => {
          button.onclick = () => {
            toggleDock(button.dataset.dockTab);
            if (!state.dockOpen) return;
            if (button.dataset.dockTab === "docs") renderDockDocs();
            if (button.dataset.dockTab === "tables") renderDockTables();
          };
        });
        document.getElementById("closeDockBtn").onclick = () => setDockOpen(false);

        document.getElementById("modelMenuBtn").onclick = (event) => {
          event.stopPropagation();
          toggleMenu("modelMenu", "modelMenuBtn");
        };

        document.getElementById("effortMenuBtn").onclick = (event) => {
          event.stopPropagation();
          toggleMenu("effortMenu", "effortMenuBtn");
        };

        document.addEventListener("click", (event) => {
          if (!event.target.closest(".menu-wrap")) closeMenus();
        });

        document.getElementById("addFilesBtn").onclick = () => {
          toggleDock("files");
        };

        document.getElementById("fileInput").onchange = async (event) => {
          const files = Array.from(event.target.files || []);
          event.target.value = "";
          if (!files.length) return;
          setDockOpen(true, "files");
          for (const file of files) {
            try {
              const uploaded = await uploadAttachmentFile(file);
              const asset = uploaded.attachment;
              state.pendingAssets.push({ id: asset.id, name: asset.name, mimeType: asset.mimeType, size: asset.size });
              state.attachmentDetailsById[asset.id] = uploaded;
            } catch (error) {
              toast(error.message || "Upload failed");
            }
          }
          renderComposerChips();
          renderDockFiles();
        };

        document.getElementById("askAiToggle").onclick = () => {
          state.askAi = !state.askAi;
          document.getElementById("askAiToggle").classList.toggle("active", state.askAi);
        };

        document.getElementById("privateToggle").onclick = () => {
          state.privateAi = !state.privateAi;
          document.getElementById("privateToggle").classList.toggle("active", state.privateAi);
        };

        document.getElementById("micBtn").onclick = () => toast("Mic is ready");

        const composerInput = document.getElementById("composerInput");
        composerInput.addEventListener("input", applyAutoGrow);

        document.getElementById("composerForm").onsubmit = async (event) => {
          event.preventDefault();
          const input = document.getElementById("composerInput");
          const text = String(input.value || "").trim();
          if (!text && !state.pendingAssets.length) {
            toast("Type a message or attach files");
            return;
          }
          input.value = "";
          applyAutoGrow();
          try {
            await sendMessage(text || "Attachment context");
          } catch (error) {
            toast(error.message || "Send failed");
          }
        };

        document.getElementById("settingsOverlay").onclick = (event) => {
          if (event.target.id === "settingsOverlay") closeSettings();
        };
        document.getElementById("closeSettingsBtn").onclick = closeSettings;

        document.querySelectorAll(".settings-tab").forEach((button) => {
          button.onclick = () => setSettingsTab(button.dataset.settings);
        });

        document.getElementById("saveSettingsBtn").onclick = async () => {
          try {
            await saveSettingsForActiveTab();
          } catch (error) {
            toast(error.message || "Save failed");
          }
        };

        document.getElementById("quickModalCancel").onclick = closeQuickModal;
        document.getElementById("quickModalConfirm").onclick = async () => {
          try {
            await submitQuickModal();
          } catch (error) {
            toast(error.message || "Create failed");
          }
        };
        document.getElementById("quickModal").onclick = (event) => {
          if (event.target.id === "quickModal") closeQuickModal();
        };
        document.getElementById("quickModalInput").addEventListener("keydown", async (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
            try {
              await submitQuickModal();
            } catch (error) {
              toast(error.message || "Create failed");
            }
          }
          if (event.key === "Tab") {
            const confirm = document.getElementById("quickModalConfirm");
            const cancel = document.getElementById("quickModalCancel");
            if (!event.shiftKey) {
              event.preventDefault();
              confirm?.focus();
            } else {
              event.preventDefault();
              cancel?.focus();
            }
          }
        });
        document.getElementById("quickModalCancel").addEventListener("keydown", (event) => {
          if (event.key === "Tab" && !event.shiftKey) {
            event.preventDefault();
            document.getElementById("quickModalInput")?.focus();
          }
        });
        document.getElementById("quickModalConfirm").addEventListener("keydown", (event) => {
          if (event.key === "Tab") {
            event.preventDefault();
            document.getElementById("quickModalCancel")?.focus();
          }
        });

        window.addEventListener("keydown", (event) => {
          if (event.key === "Escape") {
            closeSettings();
            closeMenus();
            closeQuickModal();
            if (state.dockOpen) setDockOpen(false);
            state.replyToMessageId = null;
            document.getElementById("composerInput").placeholder = "Message team. Mention @Titus or enable Ask AI.";
          }
          if ((event.metaKey || event.ctrlKey) && event.key.toLowerCase() === "k") {
            event.preventDefault();
            openSettings("general");
          }
          if ((event.metaKey || event.ctrlKey) && event.key.toLowerCase() === "j") {
            event.preventDefault();
            setDockOpen(!state.dockOpen, "files");
          }
        });
      }

      async function boot() {
        bindEvents();
        await ensureTenant();
        await loadAll();
        await connectRealtime();
        setRightTab("attachments");
        setDockOpen(false);
        renderAll();
        applyAutoGrow();
      }

      boot().catch((error) => {
        toast(error.message || "Initialization error");
      });

      window.addEventListener("beforeunload", () => {
        disconnectRealtime();
      });
    </script>
  </body>
</html>
